"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[103],{9983:(e,a,r)=>{r.d(a,{E:()=>n});var t=r(11291);r(97451);var s=r(11263),i=r(93293);let l=(0,s.F)("inline-flex items-center gap-1 rounded-full border px-3 py-0.5 text-xs font-medium tracking-tight transition-all focus:outline-none focus:ring-2 focus:ring-offset-2",{variants:{variant:{default:"border-white/30 bg-white/70 text-foreground/80 shadow-sm backdrop-blur-md",secondary:"border-white/20 bg-white/30 text-foreground/70",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/90",outline:"border-white/40 text-foreground/70",success:"border-transparent bg-emerald-500/15 text-emerald-500",warning:"border-transparent bg-amber-400/20 text-amber-600",info:"border-transparent bg-sky-500/15 text-sky-500"}},defaultVariants:{variant:"default"}});function n(e){let{className:a,variant:r,...s}=e;return(0,t.jsx)("div",{className:(0,i.cn)(l({variant:r}),a),...s})}},14007:(e,a,r)=>{r.d(a,{$:()=>C});var t=r(11291),s=r(97451),i=r(90718),l=r(82596),n=r(9983),o=r(68630),c=r(59030);let d=(0,c.createServerReference)("4068b2aad6bb5abca1df8e575b8900239c3f91e123",c.callServer,void 0,c.findSourceMapURL,"getDocuments");var m=r(41782);let u=(0,c.createServerReference)("60a05bb0cd24233599cf9f92c53da27432d198f23b",c.callServer,void 0,c.findSourceMapURL,"updateDocument"),p=(0,c.createServerReference)("40a5ed4d1a022e18d6d1f8ccc8da589a299ef3c127",c.callServer,void 0,c.findSourceMapURL,"deleteDocument"),x=(0,c.createServerReference)("404011b5219b751b45cbe3934d0daa074a2cfba13f",c.callServer,void 0,c.findSourceMapURL,"getDocumentDownloadUrl");var v=r(93293),h=r(89064),g=r(70392),j=r(68671),b=r(23403),f=r(35947),N=r(85605),_=r(22607),y=r(62490),w=r(94724),E=r(66383);E.Ik({case_id:E.Yj().uuid("ID de caso inv\xe1lido"),nombre:E.Yj().min(1,"El nombre del archivo es requerido").max(255,"El nombre no puede exceder 255 caracteres"),visibilidad:E.k5(["privado","cliente"]).default("privado"),file:E.bz().optional()}),E.Ik({nombre:E.Yj().min(1,"El nombre del archivo es requerido").max(255,"El nombre no puede exceder 255 caracteres").optional(),visibilidad:E.k5(["privado","cliente"]).optional()}),E.Ik({case_id:E.Yj().uuid().optional(),visibilidad:E.k5(["privado","cliente"]).optional(),uploader_id:E.Yj().uuid().optional(),tipo_mime:E.Yj().optional(),search:E.Yj().optional(),page:E.ai().min(1).default(1),limit:E.ai().min(1).max(100).default(20)}),E.Ik({maxFileSize:E.ai().default(0x1400000),allowedTypes:E.YO(E.Yj()).default(["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","image/jpeg","image/png","image/gif","text/plain"])});let S={"application/pdf":{extension:"pdf",icon:"\uD83D\uDCC4",name:"PDF"},"application/msword":{extension:"doc",icon:"\uD83D\uDCDD",name:"Word"},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{extension:"docx",icon:"\uD83D\uDCDD",name:"Word"},"image/jpeg":{extension:"jpg",icon:"\uD83D\uDDBC️",name:"Imagen"},"image/png":{extension:"png",icon:"\uD83D\uDDBC️",name:"Imagen"},"image/gif":{extension:"gif",icon:"\uD83D\uDDBC️",name:"Imagen"},"text/plain":{extension:"txt",icon:"\uD83D\uDCC4",name:"Texto"}};function C(e){let{caseId:a,canUpload:r=!1,canEdit:c=!1,canDelete:v=!1,showPrivateDocuments:_=!0}=e,[y,w]=(0,s.useState)([]),[E,C]=(0,s.useState)(!0),[A,R]=(0,s.useState)(!1),[q,z]=(0,s.useState)(null),[L,F]=(0,s.useState)(!1),M=(0,s.useRef)(null),{toast:U}=(0,o.dj)(),D=async()=>{C(!0);try{let e=await d({case_id:a,page:1,limit:50});e.success?w(e.documents):U({title:"Error",description:e.error||"Error al cargar documentos",variant:"destructive"})}catch(e){console.error("Error loading documents:",e),U({title:"Error",description:"Error inesperado al cargar documentos",variant:"destructive"})}finally{C(!1)}};(0,s.useEffect)(()=>{D()},[a]);let $=async e=>{var r;let t=null==(r=e.target.files)?void 0:r[0];if(t){if(t.size>0x1400000)return void U({title:"Archivo demasiado grande",description:"El archivo debe ser menor a ".concat(20,"MB"),variant:"destructive"});if(!Object.keys(S).includes(t.type))return void U({title:"Tipo de archivo no permitido",description:"Solo se permiten archivos PDF, Word, im\xe1genes y texto",variant:"destructive"});R(!0);try{let e=new FormData;e.append("file",t),e.append("case_id",a),e.append("nombre",t.name),e.append("visibilidad","privado");let r=await (0,m.X)(e);r.success?(U({title:"Documento subido",description:"El documento ha sido subido exitosamente"}),F(!1),await D()):U({title:"Error",description:r.error||"Error al subir el documento",variant:"destructive"})}catch(e){console.error("Error uploading document:",e),U({title:"Error",description:"Error inesperado al subir el documento",variant:"destructive"})}finally{R(!1),M.current&&(M.current.value="")}}},P=async(e,a)=>{try{let r=await u(e,a);r.success?(U({title:"Documento actualizado",description:"El documento ha sido actualizado exitosamente"}),z(null),await D()):U({title:"Error",description:r.error||"Error al actualizar el documento",variant:"destructive"})}catch(e){console.error("Error updating document:",e),U({title:"Error",description:"Error inesperado al actualizar el documento",variant:"destructive"})}},I=async e=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar este documento?"))try{let a=await p(e);a.success?(U({title:"Documento eliminado",description:"El documento ha sido eliminado exitosamente"}),await D()):U({title:"Error",description:a.error||"Error al eliminar el documento",variant:"destructive"})}catch(e){console.error("Error deleting document:",e),U({title:"Error",description:"Error inesperado al eliminar el documento",variant:"destructive"})}},Z=async(e,a)=>{try{let r=await x(e);if(r.success&&r.url){let e=document.createElement("a");e.href=r.url,e.download=a,document.body.appendChild(e),e.click(),document.body.removeChild(e),U({title:"Descarga iniciada",description:"El documento se est\xe1 descargando"})}else U({title:"Error",description:r.error||"Error al generar enlace de descarga",variant:"destructive"})}catch(e){console.error("Error downloading document:",e),U({title:"Error",description:"Error inesperado al descargar el documento",variant:"destructive"})}},W=e=>{let a=S[e];return a?a.icon:"\uD83D\uDCC4"},Y=e=>"cliente"===e?(0,t.jsx)(h.A,{className:"h-4 w-4 text-blue-600"}):(0,t.jsx)(g.A,{className:"h-4 w-4 text-gray-600"}),T=e=>"cliente"===e?(0,t.jsx)(n.E,{variant:"default",children:"Cliente"}):(0,t.jsx)(n.E,{variant:"secondary",children:"Privado"}),B=_?y:y.filter(e=>"cliente"===e.visibilidad);return E?(0,t.jsxs)(l.Zp,{children:[(0,t.jsx)(l.aR,{children:(0,t.jsxs)(l.ZB,{className:"flex items-center gap-2",children:[(0,t.jsx)(j.A,{className:"h-5 w-5"}),"Documentos"]})}),(0,t.jsx)(l.Wu,{children:(0,t.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,t.jsx)(b.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,t.jsxs)(l.Zp,{children:[(0,t.jsx)(l.aR,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)(l.ZB,{className:"flex items-center gap-2",children:[(0,t.jsx)(j.A,{className:"h-5 w-5"}),"Documentos (",B.length,")"]}),r&&(0,t.jsxs)(i.$,{size:"sm",onClick:()=>F(!L),disabled:A,children:[(0,t.jsx)(f.A,{className:"h-4 w-4 mr-2"}),"Subir Documento"]})]})}),(0,t.jsxs)(l.Wu,{className:"space-y-4",children:[L&&r&&(0,t.jsx)(l.Zp,{className:"border-dashed",children:(0,t.jsx)(l.Wu,{className:"pt-6",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Seleccionar archivo"}),(0,t.jsx)("input",{ref:M,type:"file",onChange:$,accept:Object.keys(S).join(","),className:"form-input",disabled:A}),(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["M\xe1ximo ",20,"MB. Formatos: PDF, Word, im\xe1genes, texto"]})]}),A&&(0,t.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[(0,t.jsx)(b.A,{className:"h-4 w-4 animate-spin"}),"Subiendo archivo..."]}),(0,t.jsx)("div",{className:"flex justify-end space-x-2",children:(0,t.jsx)(i.$,{variant:"outline",onClick:()=>F(!1),disabled:A,children:"Cancelar"})})]})})}),(0,t.jsx)("div",{className:"space-y-3",children:B.map(e=>(0,t.jsx)(k,{document:e,canEdit:c,canDelete:v,isEditing:q===e.id,onEdit:()=>z(e.id),onCancelEdit:()=>z(null),onSave:a=>P(e.id,a),onDelete:()=>I(e.id),onDownload:()=>Z(e.id,e.nombre),getFileIcon:W,getVisibilityIcon:Y,getVisibilityBadge:T},e.id))}),0===B.length&&(0,t.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,t.jsx)(N.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,t.jsx)("p",{children:"No hay documentos para este caso"}),r&&(0,t.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Subir Documento" para agregar el primer documento'})]})]})]})}function k(e){var a;let{document:r,canEdit:n,canDelete:o,isEditing:c,onEdit:d,onCancelEdit:m,onSave:u,onDelete:p,onDownload:x,getFileIcon:h,getVisibilityIcon:g,getVisibilityBadge:j}=e,[b,f]=(0,s.useState)({nombre:r.nombre,visibilidad:r.visibilidad});return(0,t.jsx)(l.Zp,{className:"border-l-4 border-l-green-500",children:(0,t.jsx)(l.Wu,{className:"pt-4",children:(0,t.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("span",{className:"text-2xl",children:h(r.tipo_mime||"")}),(0,t.jsxs)("div",{children:[c?(0,t.jsx)("input",{type:"text",value:b.nombre,onChange:e=>f({...b,nombre:e.target.value}),className:"form-input text-sm"}):(0,t.jsx)("h4",{className:"font-medium text-gray-900",children:r.nombre}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[g(r.visibilidad||"privado"),c?(0,t.jsxs)("select",{value:b.visibilidad,onChange:e=>f({...b,visibilidad:e.target.value}),className:"form-input text-xs",children:[(0,t.jsx)("option",{value:"privado",children:"Privado"}),(0,t.jsx)("option",{value:"cliente",children:"Cliente"})]}):j(r.visibilidad||"privado"),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:(0,v.v7)(r.size_bytes||0)})]}),(0,t.jsxs)("div",{className:"text-xs text-gray-400 mt-1",children:["Subido por ",(null==(a=r.uploader)?void 0:a.nombre)||"Usuario"," • ",(0,v.fw)(r.created_at)]})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(i.$,{variant:"ghost",size:"sm",onClick:x,children:(0,t.jsx)(_.A,{className:"h-4 w-4"})}),n&&(0,t.jsx)(t.Fragment,{children:c?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.$,{variant:"ghost",size:"sm",onClick:m,children:"Cancelar"}),(0,t.jsx)(i.$,{size:"sm",onClick:()=>{b.nombre.trim()&&u(b)},children:"Guardar"})]}):(0,t.jsx)(i.$,{variant:"ghost",size:"sm",onClick:d,children:(0,t.jsx)(y.A,{className:"h-4 w-4"})})}),o&&!c&&(0,t.jsx)(i.$,{variant:"ghost",size:"sm",onClick:p,children:(0,t.jsx)(w.A,{className:"h-4 w-4"})})]})]})})})}},25711:(e,a,r)=>{r.d(a,{L:()=>R});var t=r(11291),s=r(97451),i=r(90718),l=r(82596),n=r(9983),o=r(68630),c=r(59030);let d=(0,c.createServerReference)("409b0a64c97bfe61b6e8814829fd1beb5b3c0ce84b",c.callServer,void 0,c.findSourceMapURL,"getInfoRequests"),m=(0,c.createServerReference)("40590b8aeb9cfa434beea52a3b54560f16fb3251f6",c.callServer,void 0,c.findSourceMapURL,"createInfoRequest"),u=(0,c.createServerReference)("606404fa1c57a53adafcdadd0b4189028f4b743e65",c.callServer,void 0,c.findSourceMapURL,"respondInfoRequest"),p=(0,c.createServerReference)("40b3ae676bee74d4c392577de287d9a07360d67bdc",c.callServer,void 0,c.findSourceMapURL,"closeInfoRequest");var x=r(93293),v=r(71428),h=r(96843),g=r(38417),j=r(64501),b=r(23403),f=r(35947),N=r(11762),_=r(27416),y=r(90465),w=r(91969),E=r(49833),S=r(66383);S.Ik({case_id:S.Yj().uuid("ID de caso inv\xe1lido"),titulo:S.Yj().min(1,"El t\xedtulo es requerido").max(1e3,"El t\xedtulo no puede exceder 1000 caracteres"),descripcion:S.Yj().min(1,"La descripci\xf3n es requerida").max(2e3,"La descripci\xf3n no puede exceder 2000 caracteres"),tipo:S.k5(["documento","informacion","reunion","otro"]).default("informacion"),prioridad:S.k5(["baja","media","alta","urgente"]).default("media"),fecha_limite:S.Yj().optional(),es_publica:S.zM().default(!0)}).partial().omit({case_id:!0}),S.Ik({respuesta:S.Yj().min(1,"La respuesta es requerida").max(2e3,"La respuesta no puede exceder 2000 caracteres"),archivo_adjunto:S.Yj().optional()}),S.Ik({case_id:S.Yj().uuid().optional(),estado:S.k5(["pendiente","en_revision","respondida","cerrada"]).optional(),tipo:S.k5(["documento","informacion","reunion","otro"]).optional(),prioridad:S.k5(["baja","media","alta","urgente"]).optional(),creador_id:S.Yj().uuid().optional(),es_publica:S.zM().optional(),fecha_desde:S.Yj().optional(),fecha_hasta:S.Yj().optional(),search:S.Yj().optional(),page:S.ai().min(1).default(1),limit:S.ai().min(1).max(100).default(20)});let C=[{value:"documento",label:"Documento",description:"Solicitud de documentos espec\xedficos"},{value:"informacion",label:"Informaci\xf3n",description:"Solicitud de informaci\xf3n general"},{value:"reunion",label:"Reuni\xf3n",description:"Solicitud de reuni\xf3n o cita"},{value:"otro",label:"Otro",description:"Otro tipo de solicitud"}],k=[{value:"pendiente",label:"Pendiente",color:"yellow"},{value:"en_revision",label:"En Revisi\xf3n",color:"blue"},{value:"respondida",label:"Respondida",color:"green"},{value:"cerrada",label:"Cerrada",color:"gray"}],A=[{value:"baja",label:"Baja",color:"gray"},{value:"media",label:"Media",color:"blue"},{value:"alta",label:"Alta",color:"orange"},{value:"urgente",label:"Urgente",color:"red"}];function R(e){let{caseId:a,canCreateRequests:r=!1,canRespondRequests:n=!1,showPrivateRequests:c=!0}=e,[x,N]=(0,s.useState)([]),[_,y]=(0,s.useState)(!0),[w,E]=(0,s.useState)(!1),[S,R]=(0,s.useState)(null),[z,L]=(0,s.useState)(!1),[F,M]=(0,s.useState)({titulo:"",descripcion:"",tipo:"informacion",prioridad:"media",fecha_limite:"",es_publica:!0}),[U,D]=(0,s.useState)({respuesta:"",archivo_adjunto:""}),{toast:$}=(0,o.dj)(),P=async()=>{y(!0);try{let e=await d({case_id:a,page:1,limit:50});e.success?N(e.requests):$({title:"Error",description:e.error||"Error al cargar solicitudes",variant:"destructive"})}catch(e){console.error("Error loading requests:",e),$({title:"Error",description:"Error inesperado al cargar solicitudes",variant:"destructive"})}finally{y(!1)}};(0,s.useEffect)(()=>{P()},[a]);let I=async()=>{if(!F.titulo.trim()||!F.descripcion.trim())return void $({title:"Error",description:"El t\xedtulo y la descripci\xf3n son requeridos",variant:"destructive"});E(!0);try{let e={case_id:a,titulo:F.titulo.trim(),descripcion:F.descripcion.trim(),tipo:F.tipo,prioridad:F.prioridad,fecha_limite:F.fecha_limite||void 0,es_publica:F.es_publica},r=await m(e);r.success?($({title:"Solicitud creada",description:"La solicitud ha sido creada exitosamente"}),M({titulo:"",descripcion:"",tipo:"informacion",prioridad:"media",fecha_limite:"",es_publica:!0}),L(!1),await P()):$({title:"Error",description:r.error||"Error al crear la solicitud",variant:"destructive"})}catch(e){console.error("Error creating request:",e),$({title:"Error",description:"Error inesperado al crear la solicitud",variant:"destructive"})}finally{E(!1)}},Z=async e=>{if(!U.respuesta.trim())return void $({title:"Error",description:"La respuesta es requerida",variant:"destructive"});try{let a={respuesta:U.respuesta.trim(),archivo_adjunto:U.archivo_adjunto||void 0},r=await u(e,a);r.success?($({title:"Respuesta enviada",description:"La respuesta ha sido enviada exitosamente"}),D({respuesta:"",archivo_adjunto:""}),R(null),await P()):$({title:"Error",description:r.error||"Error al enviar la respuesta",variant:"destructive"})}catch(e){console.error("Error responding to request:",e),$({title:"Error",description:"Error inesperado al enviar la respuesta",variant:"destructive"})}},W=async e=>{try{let a=await p(e);a.success?($({title:"Solicitud cerrada",description:"La solicitud ha sido cerrada"}),await P()):$({title:"Error",description:a.error||"Error al cerrar la solicitud",variant:"destructive"})}catch(e){console.error("Error closing request:",e),$({title:"Error",description:"Error inesperado al cerrar la solicitud",variant:"destructive"})}},Y=e=>{switch(e){case"respondida":return(0,t.jsx)(v.A,{className:"h-5 w-5 text-green-600"});case"en_revision":return(0,t.jsx)(h.A,{className:"h-5 w-5 text-blue-600"});case"cerrada":return(0,t.jsx)(g.A,{className:"h-5 w-5 text-gray-600"});default:return(0,t.jsx)(j.A,{className:"h-5 w-5 text-yellow-600"})}},T=e=>{let a=k.find(a=>a.value===e);return a?(0,t.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat({yellow:"bg-yellow-100 text-yellow-800",blue:"bg-blue-100 text-blue-800",green:"bg-green-100 text-green-800",gray:"bg-gray-100 text-gray-800"}[a.color]),children:a.label}):null},B=e=>{let a=A.find(a=>a.value===e);return a?(0,t.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat({gray:"bg-gray-100 text-gray-800",blue:"bg-blue-100 text-blue-800",orange:"bg-orange-100 text-orange-800",red:"bg-red-100 text-red-800"}[a.color]),children:a.label}):null},V=e=>{let a=C.find(a=>a.value===e);return a?a.label:e},O=c?x:x.filter(e=>e.es_publica);return _?(0,t.jsxs)(l.Zp,{children:[(0,t.jsx)(l.aR,{children:(0,t.jsxs)(l.ZB,{className:"flex items-center gap-2",children:[(0,t.jsx)(j.A,{className:"h-5 w-5"}),"Solicitudes de Informaci\xf3n"]})}),(0,t.jsx)(l.Wu,{children:(0,t.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,t.jsx)(b.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,t.jsxs)(l.Zp,{children:[(0,t.jsx)(l.aR,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)(l.ZB,{className:"flex items-center gap-2",children:[(0,t.jsx)(j.A,{className:"h-5 w-5"}),"Solicitudes de Informaci\xf3n (",O.length,")"]}),r&&(0,t.jsxs)(i.$,{size:"sm",onClick:()=>L(!z),disabled:w,children:[(0,t.jsx)(f.A,{className:"h-4 w-4 mr-2"}),"Nueva Solicitud"]})]})}),(0,t.jsxs)(l.Wu,{className:"space-y-4",children:[z&&r&&(0,t.jsx)(l.Zp,{className:"border-dashed",children:(0,t.jsx)(l.Wu,{className:"pt-6",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"T\xedtulo *"}),(0,t.jsx)("input",{type:"text",value:F.titulo,onChange:e=>M({...F,titulo:e.target.value}),placeholder:"T\xedtulo de la solicitud",className:"form-input"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Descripci\xf3n *"}),(0,t.jsx)("textarea",{value:F.descripcion,onChange:e=>M({...F,descripcion:e.target.value}),placeholder:"Describe detalladamente lo que necesitas...",rows:4,className:"form-input"})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Tipo"}),(0,t.jsx)("select",{value:F.tipo,onChange:e=>M({...F,tipo:e.target.value}),className:"form-input",children:C.map(e=>(0,t.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Prioridad"}),(0,t.jsx)("select",{value:F.prioridad,onChange:e=>M({...F,prioridad:e.target.value}),className:"form-input",children:A.map(e=>(0,t.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Fecha l\xedmite (opcional)"}),(0,t.jsx)("input",{type:"date",value:F.fecha_limite,onChange:e=>M({...F,fecha_limite:e.target.value}),className:"form-input"})]})]}),(0,t.jsx)("div",{children:(0,t.jsxs)("label",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{type:"checkbox",checked:F.es_publica,onChange:e=>M({...F,es_publica:e.target.checked})}),(0,t.jsx)("span",{className:"text-sm",children:"Visible para el abogado"})]})}),(0,t.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,t.jsx)(i.$,{variant:"outline",onClick:()=>{L(!1),M({titulo:"",descripcion:"",tipo:"informacion",prioridad:"media",fecha_limite:"",es_publica:!0})},disabled:w,children:"Cancelar"}),(0,t.jsx)(i.$,{onClick:I,disabled:w,children:w?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(b.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Creando..."]}):"Crear Solicitud"})]})]})})}),(0,t.jsx)("div",{className:"space-y-3",children:O.map(e=>(0,t.jsx)(q,{request:e,canRespond:n,isResponding:S===e.id,response:U,onStartResponding:()=>R(e.id),onCancelResponding:()=>{R(null),D({respuesta:"",archivo_adjunto:""})},onResponseChange:D,onSendResponse:()=>Z(e.id),onClose:()=>W(e.id),getStatusIcon:Y,getStatusBadge:T,getPriorityBadge:B,getTypeIcon:V},e.id))}),0===O.length&&(0,t.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,t.jsx)(j.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,t.jsx)("p",{children:"No hay solicitudes de informaci\xf3n"}),r&&(0,t.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Nueva Solicitud" para crear la primera solicitud'})]})]})]})}function q(e){var a,r;let{request:s,canRespond:o,isResponding:c,response:d,onStartResponding:m,onCancelResponding:u,onResponseChange:p,onSendResponse:v,onClose:h,getStatusIcon:j,getStatusBadge:b,getPriorityBadge:f,getTypeIcon:S}=e,C=s.fecha_limite&&(0,x.m7)(s.fecha_limite)&&"respondida"!==s.estado&&"cerrada"!==s.estado;return(0,t.jsx)(l.Zp,{className:"border-l-4 ".concat(C?"border-l-red-500":"border-l-blue-500"),children:(0,t.jsxs)(l.Wu,{className:"pt-4",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[j(s.estado||"pendiente"),(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{className:"font-medium text-gray-900",children:s.titulo}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[b(s.estado||"pendiente"),f(s.prioridad||"media"),(0,t.jsx)(n.E,{variant:"outline",children:S(s.tipo||"informacion")}),!s.es_publica&&(0,t.jsx)(n.E,{variant:"outline",children:"Privada"})]})]})]}),C&&(0,t.jsx)(N.A,{className:"h-5 w-5 text-red-500"})]}),(0,t.jsx)("p",{className:"text-sm text-gray-700 mb-3",children:s.descripcion}),(0,t.jsxs)("div",{className:"flex items-center gap-4 text-sm text-gray-500 mb-3",children:[(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(_.A,{className:"h-4 w-4"}),(0,t.jsx)("span",{children:(null==(a=s.creador)?void 0:a.nombre)||"Usuario"})]}),(0,t.jsx)("span",{children:(0,x.fw)(s.created_at)}),s.fecha_limite&&(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(y.A,{className:"h-4 w-4"}),(0,t.jsxs)("span",{className:C?"text-red-600 font-medium":"",children:["L\xedmite: ",new Date(s.fecha_limite).toLocaleDateString("es-CL")]})]})]}),s.respuesta&&(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 mb-3",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,t.jsx)(w.A,{className:"h-4 w-4 text-blue-600"}),(0,t.jsxs)("span",{className:"text-sm font-medium",children:["Respuesta de ",(null==(r=s.respondido_por_profile)?void 0:r.nombre)||"Abogado"]}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:s.respondido_at&&(0,x.fw)(s.respondido_at)})]}),(0,t.jsx)("p",{className:"text-sm text-gray-700",children:s.respuesta}),s.archivo_adjunto&&(0,t.jsx)("a",{href:s.archivo_adjunto,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:underline mt-2 inline-block",children:"Ver archivo adjunto"})]}),c&&(0,t.jsx)("div",{className:"bg-blue-50 rounded-lg p-3 mb-3",children:(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("textarea",{value:d.respuesta,onChange:e=>p({...d,respuesta:e.target.value}),placeholder:"Escribe tu respuesta...",rows:3,className:"form-input"}),(0,t.jsx)("input",{type:"url",value:d.archivo_adjunto,onChange:e=>p({...d,archivo_adjunto:e.target.value}),placeholder:"URL del archivo adjunto (opcional)",className:"form-input"}),(0,t.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,t.jsx)(i.$,{size:"sm",variant:"outline",onClick:u,children:"Cancelar"}),(0,t.jsxs)(i.$,{size:"sm",onClick:v,children:[(0,t.jsx)(E.A,{className:"h-4 w-4 mr-1"}),"Enviar Respuesta"]})]})]})}),o&&"cerrada"!==s.estado&&(0,t.jsxs)("div",{className:"flex items-center gap-2",children:["respondida"!==s.estado&&!c&&(0,t.jsxs)(i.$,{size:"sm",variant:"outline",onClick:m,children:[(0,t.jsx)(w.A,{className:"h-4 w-4 mr-1"}),"Responder"]}),"respondida"===s.estado&&(0,t.jsxs)(i.$,{size:"sm",variant:"outline",onClick:h,children:[(0,t.jsx)(g.A,{className:"h-4 w-4 mr-1"}),"Cerrar"]})]})]})})}},54997:(e,a,r)=>{r.d(a,{_:()=>_});var t=r(11291),s=r(97451),i=r(90718),l=r(82596),n=r(9983),o=r(68630),c=r(59030);let d=(0,c.createServerReference)("40c65ac279e16daf07c1a74f8b3ab765a3040f1ce2",c.callServer,void 0,c.findSourceMapURL,"getNotes"),m=(0,c.createServerReference)("4012b70a5d87f841ea19b6c7403670ab3f6f53982d",c.callServer,void 0,c.findSourceMapURL,"createNote"),u=(0,c.createServerReference)("60e9b52677848e6ec117b36775fbbc96c53c2d4b8b",c.callServer,void 0,c.findSourceMapURL,"updateNote"),p=(0,c.createServerReference)("40bcd3afb7420703f0e38188f3b26c056f4dd76913",c.callServer,void 0,c.findSourceMapURL,"deleteNote");var x=r(93293),v=r(66656),h=r(53464),g=r(65030),j=r(23403),b=r(35947),f=r(62490),N=r(94724);function _(e){let{caseId:a,canCreateNotes:r=!1,canEditNotes:c=!1,showPrivateNotes:x=!0}=e,[f,N]=(0,s.useState)([]),[_,w]=(0,s.useState)(!0),[E,S]=(0,s.useState)(!1),[C,k]=(0,s.useState)(null),[A,R]=(0,s.useState)({tipo:"privada",contenido:""}),{toast:q}=(0,o.dj)(),z=async()=>{w(!0);try{let e=await d({case_id:a,page:1,limit:50});e.success?N(e.notes):q({title:"Error",description:e.error||"Error al cargar notas",variant:"destructive"})}catch(e){console.error("Error loading notes:",e),q({title:"Error",description:"Error inesperado al cargar notas",variant:"destructive"})}finally{w(!1)}};(0,s.useEffect)(()=>{z()},[a]);let L=async()=>{if(!A.contenido.trim())return void q({title:"Error",description:"El contenido de la nota es requerido",variant:"destructive"});S(!0);try{let e={case_id:a,tipo:A.tipo,contenido:A.contenido.trim()},r=await m(e);r.success?(q({title:"Nota creada",description:"La nota ha sido creada exitosamente"}),R({tipo:"privada",contenido:""}),await z()):q({title:"Error",description:r.error||"Error al crear la nota",variant:"destructive"})}catch(e){console.error("Error creating note:",e),q({title:"Error",description:"Error inesperado al crear la nota",variant:"destructive"})}finally{S(!1)}},F=async(e,a)=>{try{let r=await u(e,{contenido:a.trim()});r.success?(q({title:"Nota actualizada",description:"La nota ha sido actualizada exitosamente"}),k(null),await z()):q({title:"Error",description:r.error||"Error al actualizar la nota",variant:"destructive"})}catch(e){console.error("Error updating note:",e),q({title:"Error",description:"Error inesperado al actualizar la nota",variant:"destructive"})}},M=async e=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar esta nota?"))try{let a=await p(e);a.success?(q({title:"Nota eliminada",description:"La nota ha sido eliminada exitosamente"}),await z()):q({title:"Error",description:a.error||"Error al eliminar la nota",variant:"destructive"})}catch(e){console.error("Error deleting note:",e),q({title:"Error",description:"Error inesperado al eliminar la nota",variant:"destructive"})}},U=e=>"publica"===e?(0,t.jsx)(v.A,{className:"h-4 w-4 text-blue-600"}):(0,t.jsx)(h.A,{className:"h-4 w-4 text-gray-600"}),D=e=>"publica"===e?(0,t.jsx)(n.E,{variant:"default",children:"P\xfablica"}):(0,t.jsx)(n.E,{variant:"secondary",children:"Privada"}),$=x?f:f.filter(e=>"publica"===e.tipo);return _?(0,t.jsxs)(l.Zp,{children:[(0,t.jsx)(l.aR,{children:(0,t.jsxs)(l.ZB,{className:"flex items-center gap-2",children:[(0,t.jsx)(g.A,{className:"h-5 w-5"}),"Notas"]})}),(0,t.jsx)(l.Wu,{children:(0,t.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,t.jsx)(j.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,t.jsxs)(l.Zp,{children:[(0,t.jsx)(l.aR,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)(l.ZB,{className:"flex items-center gap-2",children:[(0,t.jsx)(g.A,{className:"h-5 w-5"}),"Notas (",$.length,")"]}),r&&(0,t.jsxs)(i.$,{size:"sm",onClick:()=>S(!E),disabled:E,children:[(0,t.jsx)(b.A,{className:"h-4 w-4 mr-2"}),"Nueva Nota"]})]})}),(0,t.jsxs)(l.Wu,{className:"space-y-4",children:[E&&r&&(0,t.jsx)(l.Zp,{className:"border-dashed",children:(0,t.jsx)(l.Wu,{className:"pt-6",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Tipo de nota"}),(0,t.jsxs)("select",{value:A.tipo,onChange:e=>R({...A,tipo:e.target.value}),className:"form-input",children:[(0,t.jsx)("option",{value:"privada",children:"Privada (solo abogados)"}),(0,t.jsx)("option",{value:"publica",children:"P\xfablica (visible para cliente)"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Contenido"}),(0,t.jsx)("textarea",{value:A.contenido,onChange:e=>R({...A,contenido:e.target.value}),placeholder:"Escribe tu nota aqu\xed...",rows:4,className:"form-input"})]}),(0,t.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,t.jsx)(i.$,{variant:"outline",onClick:()=>{S(!1),R({tipo:"privada",contenido:""})},children:"Cancelar"}),(0,t.jsx)(i.$,{onClick:L,children:"Crear Nota"})]})]})})}),(0,t.jsx)("div",{className:"space-y-3",children:$.map(e=>(0,t.jsx)(y,{note:e,canEdit:c,isEditing:C===e.id,onEdit:()=>k(e.id),onCancelEdit:()=>k(null),onSave:a=>F(e.id,a),onDelete:()=>M(e.id),getTypeIcon:U,getTypeBadge:D},e.id))}),0===$.length&&(0,t.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,t.jsx)(g.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,t.jsx)("p",{children:"No hay notas para este caso"}),r&&(0,t.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Nueva Nota" para agregar la primera nota'})]})]})]})}function y(e){var a;let{note:r,canEdit:n,isEditing:o,onEdit:c,onCancelEdit:d,onSave:m,onDelete:u,getTypeIcon:p,getTypeBadge:v}=e,[h,g]=(0,s.useState)(r.contenido);return(0,t.jsx)(l.Zp,{className:"border-l-4 border-l-blue-500",children:(0,t.jsxs)(l.Wu,{className:"pt-4",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[p(r.tipo),v(r.tipo),(0,t.jsxs)("span",{className:"text-sm text-gray-500",children:["por ",(null==(a=r.author)?void 0:a.nombre)||"Usuario"]}),(0,t.jsx)("span",{className:"text-sm text-gray-400",children:(0,x.fw)(r.created_at)})]}),n&&(0,t.jsx)("div",{className:"flex items-center gap-1",children:o?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.$,{variant:"ghost",size:"sm",onClick:d,children:"Cancelar"}),(0,t.jsx)(i.$,{size:"sm",onClick:()=>{h.trim()&&m(h)},children:"Guardar"})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.$,{variant:"ghost",size:"sm",onClick:c,children:(0,t.jsx)(f.A,{className:"h-4 w-4"})}),(0,t.jsx)(i.$,{variant:"ghost",size:"sm",onClick:u,children:(0,t.jsx)(N.A,{className:"h-4 w-4"})})]})})]}),o?(0,t.jsx)("textarea",{value:h,onChange:e=>g(e.target.value),rows:4,className:"form-input w-full"}):(0,t.jsx)("div",{className:"prose prose-sm max-w-none",children:(0,t.jsx)("p",{className:"whitespace-pre-wrap text-gray-700",children:r.contenido})})]})})}},68668:(e,a,r)=>{r.d(a,{B:()=>h});var t=r(11291),s=r(97451),i=r(59030);let l=(0,i.createServerReference)("40117251fa73708d6ea58a8a7fc4a4d3f84edd2290",i.callServer,void 0,i.findSourceMapURL,"sendCaseMessage"),n=(0,i.createServerReference)("6033992cdb782388fc84bef8a2922fd17c703a695a",i.callServer,void 0,i.findSourceMapURL,"listCaseMessages");var o=r(90718),c=r(848),d=r(82596),m=r(9983),u=r(93293),p=r(23403),x=r(49833),v=r(68630);function h(e){let{caseId:a,initialMessages:r,currentProfileId:i,allowSend:h=!0}=e,[g,j]=(0,s.useState)(r),[b,f]=(0,s.useState)(""),[N,_]=(0,s.useTransition)(),[y,w]=(0,s.useState)(!1),{toast:E}=(0,v.dj)();(0,s.useEffect)(()=>{j(r)},[r,a]),(0,s.useEffect)(()=>{0===r.length&&C()},[a]);let S=(0,s.useMemo)(()=>g.slice().sort((e,a)=>new Date(e.created_at).getTime()-new Date(a.created_at).getTime()),[g]),C=async()=>{w(!0);try{let e=await n(a,{limit:100});j(e)}catch(a){var e;E({title:"Error al actualizar",description:null!=(e=null==a?void 0:a.message)?e:"No fue posible obtener los mensajes.",variant:"destructive"})}finally{w(!1)}};return(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-lexser-gray-900",children:"Mensajes del caso"}),(0,t.jsx)(o.$,{variant:"outline",size:"sm",onClick:C,disabled:y,children:y?(0,t.jsx)(p.A,{className:"h-4 w-4 animate-spin"}):"Actualizar"})]}),(0,t.jsx)("div",{className:"space-y-4",children:0===S.length?(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"A\xfan no hay mensajes para este caso."}):S.map(e=>{var a,r,s;let l=e.sender_profile_id===i;return(0,t.jsx)(d.Zp,{className:"border ".concat(l?"border-lexser-blue-200 bg-lexser-blue-50":"border-lexser-gray-100"),children:(0,t.jsxs)(d.Wu,{className:"p-4 space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[(0,t.jsxs)("span",{children:[null!=(s=null==(a=e.sender)?void 0:a.nombre)?s:"Usuario",(null==(r=e.sender)?void 0:r.role)&&(0,t.jsx)(m.E,{variant:"outline",className:"ml-2 capitalize text-[10px]",children:e.sender.role})]}),(0,t.jsx)("span",{children:(0,u.r6)(e.created_at)})]}),(0,t.jsx)("p",{className:"text-sm text-lexser-gray-900 whitespace-pre-wrap",children:e.contenido}),e.attachment_url&&(0,t.jsx)("a",{href:e.attachment_url,target:"_blank",rel:"noopener noreferrer",className:"text-xs font-medium text-lexser-blue-600 hover:text-lexser-blue-700",children:"Ver adjunto"})]})},e.id)})}),h&&(0,t.jsxs)("div",{className:"rounded-lg border border-lexser-gray-200 p-4 space-y-3",children:[(0,t.jsx)(c.T,{placeholder:"Escribe un mensaje para tu cliente o equipo...",value:b,onChange:e=>f(e.target.value),disabled:N,className:"min-h-[120px]"}),(0,t.jsx)("div",{className:"flex items-center justify-end",children:(0,t.jsxs)(o.$,{onClick:()=>{if(!b.trim())return void E({title:"Mensaje vac\xedo",description:"Escribe un mensaje antes de enviarlo.",variant:"destructive"});_(async()=>{try{let e=await l({caseId:a,contenido:b.trim()});j(a=>[...a,e]),f("")}catch(a){var e;E({title:"No se pudo enviar",description:null!=(e=null==a?void 0:a.message)?e:"Intenta nuevamente en unos minutos.",variant:"destructive"})}})},disabled:N,children:[N?(0,t.jsx)(p.A,{className:"mr-2 h-4 w-4 animate-spin"}):(0,t.jsx)(x.A,{className:"mr-2 h-4 w-4"}),"Enviar"]})})]})]})}},77022:(e,a,r)=>{r.d(a,{S:()=>M});var t=r(11291),s=r(97451),i=r(90718),l=r(82596),n=r(9983),o=r(68630),c=r(59030);let d=(0,c.createServerReference)("407d6cb4ff2bd39dcaf5f15fa9d0e06606b79d5032",c.callServer,void 0,c.findSourceMapURL,"getStages"),m=(0,c.createServerReference)("4085495ff5376de2d9544dda91281e646ae494c949",c.callServer,void 0,c.findSourceMapURL,"createStage"),u=(0,c.createServerReference)("60ca260422e043e8d031aa4e5ec5aa5cec62c69295",c.callServer,void 0,c.findSourceMapURL,"completeStage"),p=(0,c.createServerReference)("400967a73b9add91995e0337cec7f66ae699a36c62",c.callServer,void 0,c.findSourceMapURL,"deleteStage"),x=(0,c.createServerReference)("608da5f884100b9fa525729204e6c90fb38047921a",c.callServer,void 0,c.findSourceMapURL,"updateStage"),v=(0,c.createServerReference)("60d22c0eee3e81479564a5d2c578cd4d8d7527f1eb",c.callServer,void 0,c.findSourceMapURL,"requestCaseAdvance");var h=r(93293),g=r(71428),j=r(96843),b=r(74759),f=r(23403),N=r(35947),_=r(82738),y=r(26181),w=r(90465),E=r(27416),S=r(87917),C=r(3814),k=r(77230),A=r(87442),R=r(67759),q=r(55096),z=r(62490),L=r(94724),F=r(59823);function M(e){var a,r,c;let{caseId:M,caseMateria:U="Civil",canManageStages:D=!1,showPrivateStages:$=!0,clientContext:P,onClientProgressChange:I,onStagesLoaded:Z}=e,[W,Y]=(0,s.useState)([]),[T,B]=(0,s.useState)(!0),[V,O]=(0,s.useState)(!1),[H,G]=(0,s.useState)(null),[X,J]=(0,s.useState)(!1),[K,Q]=(0,s.useState)({etapa:"",descripcion:"",fecha_programada:"",es_publica:!0,isCustom:!1,audiencia_tipo:"",requiere_testigos:!1,requiere_pago:!1,costo_uf:"",porcentaje_variable:"",enlace_pago:"",notas_pago:"",monto_variable_base:"",estado_pago:"pendiente",monto_pagado_uf:""}),{toast:ee}=(0,o.dj)(),[ea,er]=(0,s.useState)(null),[et,es]=(0,s.useState)(null),ei=null!=(a=null==P?void 0:P.alcanceAutorizado)?a:0,el=null!=(r=null==P?void 0:P.alcanceSolicitado)?r:0,en="cliente"===(null!=(c=null==P?void 0:P.role)?c:"cliente"),[eo,ec]=(0,s.useState)({solicitado:el,autorizado:ei}),[ed,em]=(0,s.useState)(null),eu=async()=>{B(!0);try{let e=await d({case_id:M,page:1,limit:50});e.success?(Y(e.stages),null==Z||Z(e.stages)):ee({title:"Error",description:e.error||"Error al cargar etapas",variant:"destructive"})}catch(e){console.error("Error loading stages:",e),ee({title:"Error",description:"Error inesperado al cargar etapas",variant:"destructive"})}finally{B(!1)}};(0,s.useEffect)(()=>{eu()},[M]),(0,s.useEffect)(()=>{ec({solicitado:el,autorizado:ei})},[el,ei]),(0,s.useEffect)(()=>{I&&(eo.autorizado!==ei||eo.solicitado!==el)&&I(eo)},[eo,I,ei,el]);let ep=async()=>{var e,a,r;if(!K.etapa.trim())return void ee({title:"Error",description:"El nombre de la etapa es requerido",variant:"destructive"});let t=K.costo_uf?Number(K.costo_uf):void 0;if(K.requiere_pago&&(void 0===t||Number.isNaN(t)))return void ee({title:"Costo requerido",description:"Debes indicar el costo en UF de la etapa para poder cobrarla.",variant:"destructive"});if(void 0!==t&&t<0)return void ee({title:"Monto inv\xe1lido",description:"El costo en UF debe ser un n\xfamero positivo.",variant:"destructive"});let s=K.porcentaje_variable?Number(K.porcentaje_variable):void 0;if(void 0!==s&&(Number.isNaN(s)||s<0||s>100))return void ee({title:"Porcentaje inv\xe1lido",description:"El porcentaje variable debe estar entre 0% y 100%.",variant:"destructive"});let i=K.monto_pagado_uf?Number(K.monto_pagado_uf):void 0;if(void 0!==i&&(Number.isNaN(i)||i<0))return void ee({title:"Monto pagado inv\xe1lido",description:"El monto pagado debe ser un n\xfamero positivo.",variant:"destructive"});let l=null==(e=K.enlace_pago)?void 0:e.trim();if(l&&!/^https?:\/\//i.test(l))return void ee({title:"URL inv\xe1lida",description:"El enlace de pago debe comenzar con http:// o https://",variant:"destructive"});O(!0);try{let e=Math.max(...W.map(e=>e.orden||0),0),n=K.audiencia_tipo?K.audiencia_tipo:void 0,o={case_id:M,etapa:K.etapa.trim(),descripcion:K.descripcion.trim()||void 0,fecha_programada:K.fecha_programada||void 0,es_publica:K.es_publica,estado:"pendiente",orden:e+1,audiencia_tipo:n,requiere_testigos:K.requiere_testigos,requiere_pago:K.requiere_pago,costo_uf:t,porcentaje_variable:s,estado_pago:K.estado_pago||"pendiente",enlace_pago:l||void 0,notas_pago:(null==(a=K.notas_pago)?void 0:a.trim())||void 0,monto_variable_base:(null==(r=K.monto_variable_base)?void 0:r.trim())||void 0,monto_pagado_uf:i},c=await m(o);c.success?(ee({title:"Etapa creada",description:"La etapa ha sido creada exitosamente"}),Q({etapa:"",descripcion:"",fecha_programada:"",es_publica:!0,isCustom:!1,audiencia_tipo:"",requiere_testigos:!1,requiere_pago:!1,costo_uf:"",porcentaje_variable:"",enlace_pago:"",notas_pago:"",monto_variable_base:"",estado_pago:"pendiente",monto_pagado_uf:""}),J(!1),await eu()):ee({title:"Error",description:c.error||"Error al crear la etapa",variant:"destructive"})}catch(e){console.error("Error creating stage:",e),ee({title:"Error",description:"Error inesperado al crear la etapa",variant:"destructive"})}finally{O(!1)}},ex=async e=>{if(e.requiere_pago&&"pagado"!==e.estado_pago)return void ee({title:"Pago pendiente",description:"Debes registrar el pago de esta etapa antes de marcarla como completada.",variant:"destructive"});try{er(e.id);let a=await u(e.id);a.success?(ee({title:"Etapa completada",description:"La etapa ha sido marcada como completada"}),await eu()):ee({title:"Error",description:a.error||"Error al completar la etapa",variant:"destructive"})}catch(e){console.error("Error completing stage:",e),ee({title:"Error",description:"Error inesperado al completar la etapa",variant:"destructive"})}finally{er(null)}},ev=async e=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar esta etapa?"))try{let a=await p(e);a.success?(ee({title:"Etapa eliminada",description:"La etapa ha sido eliminada exitosamente"}),await eu()):ee({title:"Error",description:a.error||"Error al eliminar la etapa",variant:"destructive"})}catch(e){console.error("Error deleting stage:",e),ee({title:"Error",description:"Error inesperado al eliminar la etapa",variant:"destructive"})}},eh=e=>null==e?"—":"".concat(new Intl.NumberFormat("es-CL",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e)," UF"),eg=async e=>{if(en&&e.id){em(e.id);try{let r=await v(M,e.id);if(r.success)ec(e=>{var a;return{autorizado:e.autorizado,solicitado:null!=(a=r.requestedOrder)?a:e.solicitado}}),ee({title:"Solicitud enviada",description:'Solicitaste avanzar hasta la etapa "'.concat(e.etapa,'".')}),await eu();else{var a;ee({title:"No se pudo solicitar el avance",description:null!=(a=r.error)?a:"Intenta nuevamente en unos minutos.",variant:"destructive"})}}catch(e){console.error("Error requesting case advance:",e),ee({title:"Error inesperado",description:"No pudimos registrar tu solicitud, intenta nuevamente.",variant:"destructive"})}finally{em(null)}}},ej=async e=>{var a;let r=prompt("Ingresa el enlace de pago de Payku para esta etapa",null!=(a=e.enlace_pago)?a:"");if(null===r)return;let t=r.trim();if(t&&!/^https?:\/\//i.test(t))return void ee({title:"URL inv\xe1lida",description:"Ingresa una URL v\xe1lida que comience con http:// o https://",variant:"destructive"});try{es(e.id);let a=await x(e.id,{enlace_pago:t||void 0,requiere_pago:!!t||e.requiere_pago});a.success?(ee({title:t?"Enlace de pago actualizado":"Enlace eliminado",description:t?"Comparte este enlace con el cliente para cobrar la etapa.":"Se elimin\xf3 el enlace asociado a la etapa."}),await eu()):ee({title:"No se pudo guardar el enlace",description:a.error||"Intenta nuevamente.",variant:"destructive"})}catch(e){console.error("Error setting payment link:",e),ee({title:"Error inesperado",description:"No pudimos guardar el enlace en este momento.",variant:"destructive"})}finally{es(null)}},eb=async e=>{var a,r,t,s,i;let l=null!=(t=e.monto_pagado_uf)?t:null!=(r=e.costo_uf)?r:0,n=prompt("Monto pagado (UF)",l>0?l.toString():null!=(s=null==(a=e.costo_uf)?void 0:a.toString())?s:"");if(null===n)return;let o=Number(n.replace(",","."));if(Number.isNaN(o)||o<0)return void ee({title:"Monto inv\xe1lido",description:"Ingresa un n\xfamero v\xe1lido en UF.",variant:"destructive"});let c=null!=(i=e.costo_uf)?i:0,d=c>0&&o>=c?"pagado":"parcial";try{es(e.id);let a=await x(e.id,{estado_pago:d,monto_pagado_uf:o,requiere_pago:!0});a.success?(ee({title:"Pago registrado",description:"pagado"===d?"La etapa qued\xf3 marcada como pagada.":"Se registr\xf3 un pago parcial."}),await eu()):ee({title:"No se pudo registrar el pago",description:a.error||"Vuelve a intentarlo.",variant:"destructive"})}catch(e){console.error("Error setting payment status:",e),ee({title:"Error inesperado",description:"No pudimos registrar el pago.",variant:"destructive"})}finally{es(null)}},ef=async e=>{if(!e.costo_uf||!e.monto_pagado_uf||!(e.monto_pagado_uf<e.costo_uf)||confirm("El monto registrado como pagado es menor al costo de la etapa. \xbfDeseas marcarla como pagada de todas maneras?"))try{var a,r;es(e.id);let t=await x(e.id,{estado_pago:"pagado",monto_pagado_uf:null!=(r=null!=(a=e.costo_uf)?a:e.monto_pagado_uf)?r:0,requiere_pago:!0});t.success?(ee({title:"Pago completado",description:"Esta etapa qued\xf3 marcada como pagada."}),await eu()):ee({title:"No se pudo marcar como pagado",description:t.error||"Intenta nuevamente.",variant:"destructive"})}catch(e){console.error("Error marking stage paid:",e),ee({title:"Error inesperado",description:"No fue posible marcar la etapa como pagada.",variant:"destructive"})}finally{es(null)}},eN=$?W:W.filter(e=>e.es_publica),e_=(0,F.CT)(U),ey=W.reduce((e,a)=>{var r;return e+(null!=(r=a.costo_uf)?r:0)},0),ew=W.reduce((e,a)=>{var r;return e+(null!=(r=a.monto_pagado_uf)?r:0)},0),eE=W.filter(e=>e.requiere_pago),eS=eE.filter(e=>"pagado"===e.estado_pago).length,eC=eE.filter(e=>"pagado"!==e.estado_pago).length,ek=eE.filter(e=>"solicitado"===e.estado_pago).length,eA=e=>{var a;if(!e)return null;let r=W.find(a=>{var r;return(null!=(r=a.orden)?r:0)===e});return null!=(a=null==r?void 0:r.etapa)?a:null},eR=en?eA(eo.solicitado):null,eq=en?eA(eo.autorizado):null;return((0,s.useEffect)(()=>{X&&eE.length>0&&Q(e=>({...e,requiere_pago:!0}))},[X,eE.length]),T)?(0,t.jsxs)(l.Zp,{children:[(0,t.jsx)(l.aR,{children:(0,t.jsxs)(l.ZB,{className:"flex items-center gap-2",children:[(0,t.jsx)(j.A,{className:"h-5 w-5"}),"Timeline Procesal"]})}),(0,t.jsx)(l.Wu,{children:(0,t.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,t.jsx)(f.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,t.jsxs)(l.Zp,{children:[(0,t.jsx)(l.aR,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)(l.ZB,{className:"flex items-center gap-2",children:[(0,t.jsx)(j.A,{className:"h-5 w-5"}),"Timeline Procesal (",eN.length,")"]}),D&&(0,t.jsxs)(i.$,{size:"sm",onClick:()=>J(!X),disabled:V,children:[(0,t.jsx)(N.A,{className:"h-4 w-4 mr-2"}),"Nueva Etapa"]})]})}),(0,t.jsxs)(l.Wu,{className:"space-y-6",children:[eE.length>0&&(0,t.jsxs)("div",{className:"grid grid-cols-1 ".concat(en?"md:grid-cols-4":"md:grid-cols-3"," gap-3 rounded-lg border border-blue-100 bg-blue-50 p-4 text-sm text-blue-900"),children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Honorario distribuido"}),(0,t.jsx)("p",{className:"text-lg font-semibold",children:eh(ey)})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Pagado"}),(0,t.jsx)("p",{className:"text-lg font-semibold",children:eh(ew)})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Etapas liberadas"}),(0,t.jsxs)("p",{className:"text-lg font-semibold",children:[eS," / ",eE.length]}),eC>0&&(0,t.jsxs)("p",{className:"text-xs text-blue-700 mt-1",children:["Faltan ",eC," pago(s) para completar el plan."]})]}),en&&(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Solicitadas por el cliente"}),(0,t.jsx)("p",{className:"text-lg font-semibold",children:ek})]})]}),en&&(0,t.jsxs)("div",{className:"rounded-xl border border-slate-200 bg-white/80 px-4 py-4 text-sm text-slate-600 shadow-sm",children:[(0,t.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Alcance solicitado"}),(0,t.jsx)("p",{className:"text-base font-semibold text-slate-900",children:eo.solicitado>0?null!=eR?eR:"Etapa ".concat(eo.solicitado):"A\xfan no definido"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Autorizado por el estudio"}),(0,t.jsx)("p",{className:"text-base font-semibold text-slate-900",children:eo.autorizado>0?null!=eq?eq:"Etapa ".concat(eo.autorizado):"Pendiente"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Etapas solicitadas"}),(0,t.jsxs)("p",{className:"text-base font-semibold text-slate-900",children:[ek," / ",eE.length]})]})]}),eo.solicitado>eo.autorizado&&(0,t.jsx)("p",{className:"mt-3 text-xs text-slate-500",children:"Estamos revisando tu solicitud para avanzar. Te notificaremos cuando est\xe9 aprobada."})]}),X&&D&&(0,t.jsx)(l.Zp,{className:"border-dashed",children:(0,t.jsx)(l.Wu,{className:"pt-6",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Etapa"}),(0,t.jsxs)("select",{value:K.isCustom?"custom":K.etapa,onChange:e=>{var a;let r=e.target.value;if("custom"===r)return void Q({...K,etapa:"",descripcion:"",isCustom:!0});let t=e_.find(e=>e.etapa===r);Q({...K,etapa:r,descripcion:(null==t?void 0:t.descripcion)||K.descripcion,isCustom:!1,requiere_pago:null!=(a=null==t?void 0:t.requierePago)?a:K.requiere_pago,costo_uf:(null==t?void 0:t.costoUF)!==void 0?t.costoUF.toString():"",porcentaje_variable:(null==t?void 0:t.porcentajeVariable)!==void 0?t.porcentajeVariable.toString():"",monto_variable_base:(null==t?void 0:t.notasPago)||"",estado_pago:"pendiente",notas_pago:(null==t?void 0:t.notasPago)||""})},className:"form-input",children:[(0,t.jsx)("option",{value:"",children:"Seleccionar etapa"}),e_.map(e=>(0,t.jsxs)("option",{value:e.etapa,children:[e.etapa," ",e.diasEstimados?"(≈ ".concat(e.diasEstimados," d\xedas)"):""]},e.etapa)),(0,t.jsx)("option",{value:"custom",children:"Etapa personalizada..."})]}),K.isCustom&&(0,t.jsx)("input",{type:"text",placeholder:"Nombre de la etapa personalizada",value:K.etapa,onChange:e=>Q({...K,etapa:e.target.value}),className:"form-input mt-2"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Descripci\xf3n (opcional)"}),(0,t.jsx)("textarea",{value:K.descripcion,onChange:e=>Q({...K,descripcion:e.target.value}),placeholder:"Descripci\xf3n de la etapa...",rows:3,className:"form-input"})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium",children:"Tipo de audiencia"}),(0,t.jsxs)("select",{value:K.audiencia_tipo,onChange:e=>{let a=e.target.value;Q(e=>({...e,audiencia_tipo:a,requiere_testigos:""!==a&&e.requiere_testigos}))},className:"form-input",children:[(0,t.jsx)("option",{value:"",children:"Sin audiencia definida"}),F.Od.map(e=>(0,t.jsx)("option",{value:e.value,children:e.label},e.value))]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium",children:"Participaci\xf3n de testigos"}),(0,t.jsxs)("label",{className:"flex items-center gap-2 rounded-md border px-3 py-2 text-sm ".concat(K.audiencia_tipo?"border-gray-300 bg-white text-gray-700":"border-dashed border-gray-300 bg-gray-50 text-gray-500"),children:[(0,t.jsx)("input",{type:"checkbox",className:"rounded border-gray-300",checked:K.requiere_testigos,disabled:!K.audiencia_tipo,onChange:e=>Q({...K,requiere_testigos:e.target.checked})}),"Se coordinar\xe1n testigos para esta audiencia"]}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"Esta informaci\xf3n ayuda al equipo a planificar con tiempo la asistencia."})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Fecha programada (opcional)"}),(0,t.jsx)("input",{type:"date",value:K.fecha_programada,onChange:e=>Q({...K,fecha_programada:e.target.value}),className:"form-input"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Visibilidad"}),(0,t.jsxs)("select",{value:K.es_publica?"publica":"privada",onChange:e=>Q({...K,es_publica:"publica"===e.target.value}),className:"form-input",children:[(0,t.jsx)("option",{value:"publica",children:"P\xfablica (visible para cliente)"}),(0,t.jsx)("option",{value:"privada",children:"Privada (solo abogados)"})]})]})]}),(0,t.jsxs)("div",{className:"space-y-4 border-t border-gray-200 pt-4",children:[(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700",children:[(0,t.jsx)("input",{type:"checkbox",className:"rounded border-gray-300",checked:K.requiere_pago,onChange:e=>Q({...K,requiere_pago:e.target.checked,estado_pago:"pendiente"})}),"Esta etapa requiere pago para avanzar"]}),K.requiere_pago&&(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium",children:"Monto fijo (UF)"}),(0,t.jsx)("input",{type:"number",min:"0",step:"0.01",value:K.costo_uf,onChange:e=>Q({...K,costo_uf:e.target.value}),className:"form-input",placeholder:"Ej: 5.0"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium",children:"Componente variable (%)"}),(0,t.jsx)("input",{type:"number",min:"0",max:"100",step:"0.1",value:K.porcentaje_variable,onChange:e=>Q({...K,porcentaje_variable:e.target.value}),className:"form-input",placeholder:"Ej: 10"})]}),(0,t.jsxs)("div",{className:"md:col-span-2 space-y-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium",children:"Base del variable"}),(0,t.jsx)("textarea",{rows:2,value:K.monto_variable_base,onChange:e=>Q({...K,monto_variable_base:e.target.value}),className:"form-input",placeholder:"Ej: 10% de lo obtenido o ahorrado."})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium",children:"Link de pago (Payku)"}),(0,t.jsx)("input",{type:"url",value:K.enlace_pago,onChange:e=>Q({...K,enlace_pago:e.target.value}),className:"form-input",placeholder:"https://..."})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium",children:"Notas internas"}),(0,t.jsx)("textarea",{rows:2,value:K.notas_pago,onChange:e=>Q({...K,notas_pago:e.target.value}),className:"form-input",placeholder:"Instrucciones u observaciones sobre el cobro."})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium",children:"Estado inicial del pago"}),(0,t.jsx)("select",{value:K.estado_pago,onChange:e=>Q({...K,estado_pago:e.target.value}),className:"form-input",children:F.pp.map(e=>(0,t.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium",children:"Monto ya pagado (UF)"}),(0,t.jsx)("input",{type:"number",min:"0",step:"0.01",value:K.monto_pagado_uf,onChange:e=>Q({...K,monto_pagado_uf:e.target.value}),className:"form-input",placeholder:"0.00"})]})]}),(0,t.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,t.jsx)(i.$,{variant:"outline",onClick:()=>{J(!1),Q({etapa:"",descripcion:"",fecha_programada:"",es_publica:!0,isCustom:!1,audiencia_tipo:"",requiere_testigos:!1,requiere_pago:!1,costo_uf:"",porcentaje_variable:"",enlace_pago:"",notas_pago:"",monto_variable_base:"",estado_pago:"pendiente",monto_pagado_uf:""})},disabled:V,children:"Cancelar"}),(0,t.jsx)(i.$,{onClick:ep,disabled:V,children:V?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(f.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Creando..."]}):"Crear Etapa"})]})]})]})})}),(0,t.jsx)("div",{className:"relative",children:eN.map((e,a)=>{var r,s,o,c;let d=e.responsable,m=null!=(s=e.orden)?s:a+1,u=en&&m<=eo.autorizado,p=en&&m<=eo.solicitado&&m>eo.autorizado,x=["completado"===e.estado?"bg-green-50":"",u?"border-green-200 bg-green-50/70":"",!u&&p?"border-blue-200 bg-blue-50/70":""].filter(Boolean).join(" "),v="completado"===e.estado,N=u||v||(null!=(o=e.estado_pago)?o:"pendiente")==="pagado"||m<=eo.solicitado||ed===e.id,M=e.audiencia_tipo?null!=(c=null==(r=F.Od.find(a=>a.value===e.audiencia_tipo))?void 0:r.label)?c:"Audiencia ".concat(e.audiencia_tipo):null;return(0,t.jsxs)("div",{className:"relative flex items-start space-x-4 pb-8",children:[a<eN.length-1&&(0,t.jsx)("div",{className:"absolute left-2.5 top-8 w-0.5 h-full bg-gray-200"}),(0,t.jsx)("div",{className:"relative z-10 flex-shrink-0",children:(e=>{switch(e){case"completado":return(0,t.jsx)(g.A,{className:"h-5 w-5 text-green-600"});case"en_proceso":return(0,t.jsx)(j.A,{className:"h-5 w-5 text-blue-600"});default:return(0,t.jsx)(b.A,{className:"h-5 w-5 text-gray-400"})}})(e.estado||"pendiente")}),(0,t.jsx)("div",{className:"flex-1 min-w-0",children:(0,t.jsx)(l.Zp,{className:x,children:(0,t.jsxs)(l.Wu,{className:"pt-4",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("h4",{className:"font-medium text-gray-900",children:e.etapa}),e.descripcion&&(0,t.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:e.descripcion}),(M||e.requiere_testigos)&&(0,t.jsxs)("div",{className:"mt-3 flex flex-wrap items-center gap-2 text-xs",children:[M&&(0,t.jsxs)("span",{className:"inline-flex items-center gap-1 rounded-full bg-blue-100 px-2 py-0.5 font-medium text-blue-700",children:[(0,t.jsx)(_.A,{className:"h-3 w-3"}),M]}),e.requiere_testigos&&(0,t.jsxs)("span",{className:"inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 font-medium text-amber-800",children:[(0,t.jsx)(y.A,{className:"h-3 w-3"}),"Requiere testigos"]})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 ml-4",children:[(e=>{let a=F.E5.find(a=>a.value===e);return a?(0,t.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat({gray:"bg-gray-100 text-gray-800",blue:"bg-blue-100 text-blue-800",green:"bg-green-100 text-green-800",red:"bg-red-100 text-red-800"}[a.color]),children:a.label}):null})(e.estado||"pendiente"),!e.es_publica&&(0,t.jsx)(n.E,{variant:"outline",children:"Privada"})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-4 text-sm text-gray-500 mb-3",children:[e.fecha_programada&&(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(w.A,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:(0,h.m7)(e.fecha_programada)&&"completado"!==e.estado?"text-red-600 font-medium":"",children:(0,h.Yq)(e.fecha_programada)})]}),(null==d?void 0:d.nombre)&&(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(E.A,{className:"h-4 w-4"}),(0,t.jsx)("span",{children:d.nombre})]}),e.fecha_cumplida&&(0,t.jsxs)("div",{className:"text-green-600",children:["Completado ",(0,h.fw)(e.fecha_cumplida)]})]}),e.requiere_pago&&(0,t.jsxs)("div",{className:"mt-3 rounded-lg border border-amber-200 bg-amber-50 p-3 text-sm space-y-2 text-amber-900",children:[(0,t.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 font-semibold",children:[(0,t.jsx)(S.A,{className:"h-4 w-4"}),(0,t.jsx)("span",{children:"Costo de la etapa:"}),(0,t.jsx)("span",{children:eh(e.costo_uf)})]}),(e=>{if(!e)return null;let a=F.pp.find(a=>a.value===e);if(!a)return null;let r={gray:"bg-gray-100 text-gray-800",amber:"bg-amber-100 text-amber-800",blue:"bg-blue-100 text-blue-800",green:"bg-green-100 text-green-800",red:"bg-red-100 text-red-800"}[a.color]||"bg-gray-100 text-gray-800";return(0,t.jsx)(n.E,{className:r,variant:"outline",children:a.label})})(e.estado_pago||"pendiente")]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 text-amber-800",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(C.A,{className:"h-4 w-4"}),(0,t.jsxs)("span",{children:["Pagado: ",eh(e.monto_pagado_uf)]})]}),e.porcentaje_variable&&(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(k.A,{className:"h-4 w-4"}),(0,t.jsxs)("span",{children:["Variable: ",e.porcentaje_variable,"% ",e.monto_variable_base?"(".concat(e.monto_variable_base,")"):""]})]})]}),e.notas_pago&&(0,t.jsx)("p",{className:"text-xs text-amber-700 bg-white/60 border border-amber-200 rounded-md px-3 py-2",children:e.notas_pago}),"solicitado"===e.estado_pago&&(0,t.jsxs)("p",{className:"flex items-center gap-2 text-xs text-amber-700",children:[(0,t.jsx)(A.A,{className:"h-3 w-3"}),"Solicitud enviada"," ",e.solicitado_at?(0,h.fw)(e.solicitado_at):"recientemente","."]}),(0,t.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[e.enlace_pago&&(0,t.jsx)(i.$,{size:"sm",variant:"outline",asChild:!0,children:(0,t.jsxs)("a",{href:e.enlace_pago,target:"_blank",rel:"noopener noreferrer",children:[(0,t.jsx)(R.A,{className:"h-4 w-4 mr-2"}),"Abrir enlace Payku"]})}),D&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.$,{size:"sm",variant:"ghost",onClick:()=>ej(e),disabled:et===e.id,children:et===e.id?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(f.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Guardando…"]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(q.A,{className:"h-4 w-4 mr-2"}),e.enlace_pago?"Editar enlace":"Asignar enlace"]})}),(0,t.jsx)(i.$,{size:"sm",variant:"ghost",onClick:()=>eb(e),disabled:et===e.id,children:et===e.id?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(f.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Registrando…"]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(C.A,{className:"h-4 w-4 mr-2"}),"Registrar pago"]})}),(0,t.jsx)(i.$,{size:"sm",variant:"outline",onClick:()=>ef(e),disabled:et===e.id,children:et===e.id?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(f.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Confirmando…"]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(k.A,{className:"h-4 w-4 mr-2"}),"Marcar pagado"]})})]}),en&&!D&&(0,t.jsx)(i.$,{size:"sm",variant:"outline",onClick:()=>eg(e),disabled:N,children:ed===e.id?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(f.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Enviando…"]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(S.A,{className:"h-4 w-4 mr-2"}),"Solicitar prepago"]})})]}),"pagado"!==e.estado_pago&&e.enlace_pago&&(0,t.jsxs)("p",{className:"text-xs text-amber-700 flex items-center gap-1",children:[(0,t.jsx)(A.A,{className:"h-3 w-3"}),"Comparte el enlace con el cliente para liberar esta etapa."]})]}),D&&(0,t.jsxs)("div",{className:"flex items-center gap-2",children:["completado"!==e.estado&&(0,t.jsx)(i.$,{size:"sm",variant:"outline",onClick:()=>ex(e),disabled:ea===e.id||e.requiere_pago&&"pagado"!==e.estado_pago,children:ea===e.id?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(f.A,{className:"h-4 w-4 mr-1 animate-spin"}),"Procesando…"]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(g.A,{className:"h-4 w-4 mr-1"}),"Completar"]})}),(0,t.jsx)(i.$,{size:"sm",variant:"ghost",onClick:()=>G(e.id),children:(0,t.jsx)(z.A,{className:"h-4 w-4"})}),(0,t.jsx)(i.$,{size:"sm",variant:"ghost",onClick:()=>ev(e.id),children:(0,t.jsx)(L.A,{className:"h-4 w-4"})})]})]})})})]},e.id)})}),0===eN.length&&(0,t.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,t.jsx)(j.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,t.jsx)("p",{children:"No hay etapas definidas para este caso"}),D&&(0,t.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Nueva Etapa" para agregar la primera etapa'})]}),e_.length>0&&(0,t.jsxs)("div",{className:"border-t pt-4 mt-2",children:[(0,t.jsxs)("h3",{className:"text-sm font-semibold text-gray-700",children:["Plan estimado de referencia para materia ",U||"Civil"]}),(0,t.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Duraciones aproximadas en d\xedas a partir del inicio del caso."}),(0,t.jsx)("ul",{className:"mt-3 space-y-2 text-sm text-gray-600",children:e_.map((e,a)=>(0,t.jsxs)("li",{className:"flex items-start gap-2",children:[(0,t.jsx)("span",{className:"mt-1 h-2 w-2 rounded-full bg-blue-500 flex-shrink-0"}),(0,t.jsxs)("span",{children:[(0,t.jsx)("span",{className:"font-medium text-gray-800",children:e.etapa}),(0,t.jsxs)("span",{className:"block text-gray-500",children:[e.descripcion,e.diasEstimados?" \xb7 ≈ ".concat(e.diasEstimados," d\xedas"):""]})]})]},"".concat(e.etapa,"-").concat(a)))})]})]})]})}}}]);