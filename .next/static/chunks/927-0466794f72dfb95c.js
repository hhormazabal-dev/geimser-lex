"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[927],{848:(e,a,t)=>{t.d(a,{T:()=>n});var r=t(11291),i=t(97451),s=t(93293);let n=i.forwardRef((e,a)=>{let{className:t,...i}=e;return(0,r.jsx)("textarea",{ref:a,className:(0,s.cn)("flex min-h-[100px] w-full rounded-2xl border border-white/30 bg-white/70 px-4 py-3 text-sm text-foreground/80 shadow-inner transition-all placeholder:text-foreground/40 focus-visible:border-primary focus-visible:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/30 disabled:cursor-not-allowed disabled:opacity-60",t),...i})});n.displayName="Textarea"},9983:(e,a,t)=>{t.d(a,{E:()=>o});var r=t(11291);t(97451);var i=t(11263),s=t(93293);let n=(0,i.F)("inline-flex items-center gap-1 rounded-full border px-3 py-0.5 text-xs font-medium tracking-tight transition-all focus:outline-none focus:ring-2 focus:ring-offset-2",{variants:{variant:{default:"border-white/30 bg-white/70 text-foreground/80 shadow-sm backdrop-blur-md",secondary:"border-white/20 bg-white/30 text-foreground/70",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/90",outline:"border-white/40 text-foreground/70",success:"border-transparent bg-emerald-500/15 text-emerald-500",warning:"border-transparent bg-amber-400/20 text-amber-600",info:"border-transparent bg-sky-500/15 text-sky-500"}},defaultVariants:{variant:"default"}});function o(e){let{className:a,variant:t,...i}=e;return(0,r.jsx)("div",{className:(0,s.cn)(n({variant:t}),a),...i})}},14007:(e,a,t)=>{t.d(a,{$:()=>C});var r=t(11291),i=t(97451),s=t(90718),n=t(82596),o=t(9983),l=t(68630),c=t(59030);let d=(0,c.createServerReference)("4068b2aad6bb5abca1df8e575b8900239c3f91e123",c.callServer,void 0,c.findSourceMapURL,"getDocuments");var p=t(41782);let u=(0,c.createServerReference)("60a05bb0cd24233599cf9f92c53da27432d198f23b",c.callServer,void 0,c.findSourceMapURL,"updateDocument"),m=(0,c.createServerReference)("40a5ed4d1a022e18d6d1f8ccc8da589a299ef3c127",c.callServer,void 0,c.findSourceMapURL,"deleteDocument"),x=(0,c.createServerReference)("404011b5219b751b45cbe3934d0daa074a2cfba13f",c.callServer,void 0,c.findSourceMapURL,"getDocumentDownloadUrl");var v=t(93293),h=t(89064),g=t(70392),f=t(68671),b=t(23403),j=t(35947),N=t(85605),y=t(22607),_=t(62490),E=t(94724),w=t(66383);w.Ik({case_id:w.Yj().uuid("ID de caso inv\xe1lido"),nombre:w.Yj().min(1,"El nombre del archivo es requerido").max(255,"El nombre no puede exceder 255 caracteres"),visibilidad:w.k5(["privado","cliente"]).default("privado"),file:w.bz().optional()}),w.Ik({nombre:w.Yj().min(1,"El nombre del archivo es requerido").max(255,"El nombre no puede exceder 255 caracteres").optional(),visibilidad:w.k5(["privado","cliente"]).optional()}),w.Ik({case_id:w.Yj().uuid().optional(),visibilidad:w.k5(["privado","cliente"]).optional(),uploader_id:w.Yj().uuid().optional(),tipo_mime:w.Yj().optional(),search:w.Yj().optional(),page:w.ai().min(1).default(1),limit:w.ai().min(1).max(100).default(20)}),w.Ik({maxFileSize:w.ai().default(0x1400000),allowedTypes:w.YO(w.Yj()).default(["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","image/jpeg","image/png","image/gif","text/plain"])});let S={"application/pdf":{extension:"pdf",icon:"\uD83D\uDCC4",name:"PDF"},"application/msword":{extension:"doc",icon:"\uD83D\uDCDD",name:"Word"},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{extension:"docx",icon:"\uD83D\uDCDD",name:"Word"},"image/jpeg":{extension:"jpg",icon:"\uD83D\uDDBC️",name:"Imagen"},"image/png":{extension:"png",icon:"\uD83D\uDDBC️",name:"Imagen"},"image/gif":{extension:"gif",icon:"\uD83D\uDDBC️",name:"Imagen"},"text/plain":{extension:"txt",icon:"\uD83D\uDCC4",name:"Texto"}};function C(e){let{caseId:a,canUpload:t=!1,canEdit:c=!1,canDelete:v=!1,showPrivateDocuments:y=!0}=e,[_,E]=(0,i.useState)([]),[w,C]=(0,i.useState)(!0),[A,R]=(0,i.useState)(!1),[z,D]=(0,i.useState)(null),[I,q]=(0,i.useState)(!1),M=(0,i.useRef)(null),{toast:L}=(0,l.dj)(),T=async()=>{C(!0);try{let e=await d({case_id:a,page:1,limit:50});e.success?E(e.documents):L({title:"Error",description:e.error||"Error al cargar documentos",variant:"destructive"})}catch(e){console.error("Error loading documents:",e),L({title:"Error",description:"Error inesperado al cargar documentos",variant:"destructive"})}finally{C(!1)}};(0,i.useEffect)(()=>{T()},[a]);let F=async e=>{var t;let r=null==(t=e.target.files)?void 0:t[0];if(r){if(r.size>0x1400000)return void L({title:"Archivo demasiado grande",description:"El archivo debe ser menor a ".concat(20,"MB"),variant:"destructive"});if(!Object.keys(S).includes(r.type))return void L({title:"Tipo de archivo no permitido",description:"Solo se permiten archivos PDF, Word, im\xe1genes y texto",variant:"destructive"});R(!0);try{let e=new FormData;e.append("file",r),e.append("case_id",a),e.append("nombre",r.name),e.append("visibilidad","privado");let t=await (0,p.X)(e);t.success?(L({title:"Documento subido",description:"El documento ha sido subido exitosamente"}),q(!1),await T()):L({title:"Error",description:t.error||"Error al subir el documento",variant:"destructive"})}catch(e){console.error("Error uploading document:",e),L({title:"Error",description:"Error inesperado al subir el documento",variant:"destructive"})}finally{R(!1),M.current&&(M.current.value="")}}},P=async(e,a)=>{try{let t=await u(e,a);t.success?(L({title:"Documento actualizado",description:"El documento ha sido actualizado exitosamente"}),D(null),await T()):L({title:"Error",description:t.error||"Error al actualizar el documento",variant:"destructive"})}catch(e){console.error("Error updating document:",e),L({title:"Error",description:"Error inesperado al actualizar el documento",variant:"destructive"})}},U=async e=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar este documento?"))try{let a=await m(e);a.success?(L({title:"Documento eliminado",description:"El documento ha sido eliminado exitosamente"}),await T()):L({title:"Error",description:a.error||"Error al eliminar el documento",variant:"destructive"})}catch(e){console.error("Error deleting document:",e),L({title:"Error",description:"Error inesperado al eliminar el documento",variant:"destructive"})}},Y=async(e,a)=>{try{let t=await x(e);if(t.success&&t.url){let e=document.createElement("a");e.href=t.url,e.download=a,document.body.appendChild(e),e.click(),document.body.removeChild(e),L({title:"Descarga iniciada",description:"El documento se est\xe1 descargando"})}else L({title:"Error",description:t.error||"Error al generar enlace de descarga",variant:"destructive"})}catch(e){console.error("Error downloading document:",e),L({title:"Error",description:"Error inesperado al descargar el documento",variant:"destructive"})}},$=e=>{let a=S[e];return a?a.icon:"\uD83D\uDCC4"},Z=e=>"cliente"===e?(0,r.jsx)(h.A,{className:"h-4 w-4 text-blue-600"}):(0,r.jsx)(g.A,{className:"h-4 w-4 text-gray-600"}),B=e=>"cliente"===e?(0,r.jsx)(o.E,{variant:"default",children:"Cliente"}):(0,r.jsx)(o.E,{variant:"secondary",children:"Privado"}),W=y?_:_.filter(e=>"cliente"===e.visibilidad);return w?(0,r.jsxs)(n.Zp,{children:[(0,r.jsx)(n.aR,{children:(0,r.jsxs)(n.ZB,{className:"flex items-center gap-2",children:[(0,r.jsx)(f.A,{className:"h-5 w-5"}),"Documentos"]})}),(0,r.jsx)(n.Wu,{children:(0,r.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,r.jsx)(b.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,r.jsxs)(n.Zp,{children:[(0,r.jsx)(n.aR,{children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)(n.ZB,{className:"flex items-center gap-2",children:[(0,r.jsx)(f.A,{className:"h-5 w-5"}),"Documentos (",W.length,")"]}),t&&(0,r.jsxs)(s.$,{size:"sm",onClick:()=>q(!I),disabled:A,children:[(0,r.jsx)(j.A,{className:"h-4 w-4 mr-2"}),"Subir Documento"]})]})}),(0,r.jsxs)(n.Wu,{className:"space-y-4",children:[I&&t&&(0,r.jsx)(n.Zp,{className:"border-dashed",children:(0,r.jsx)(n.Wu,{className:"pt-6",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Seleccionar archivo"}),(0,r.jsx)("input",{ref:M,type:"file",onChange:F,accept:Object.keys(S).join(","),className:"form-input",disabled:A}),(0,r.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["M\xe1ximo ",20,"MB. Formatos: PDF, Word, im\xe1genes, texto"]})]}),A&&(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[(0,r.jsx)(b.A,{className:"h-4 w-4 animate-spin"}),"Subiendo archivo..."]}),(0,r.jsx)("div",{className:"flex justify-end space-x-2",children:(0,r.jsx)(s.$,{variant:"outline",onClick:()=>q(!1),disabled:A,children:"Cancelar"})})]})})}),(0,r.jsx)("div",{className:"space-y-3",children:W.map(e=>(0,r.jsx)(k,{document:e,canEdit:c,canDelete:v,isEditing:z===e.id,onEdit:()=>D(e.id),onCancelEdit:()=>D(null),onSave:a=>P(e.id,a),onDelete:()=>U(e.id),onDownload:()=>Y(e.id,e.nombre),getFileIcon:$,getVisibilityIcon:Z,getVisibilityBadge:B},e.id))}),0===W.length&&(0,r.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,r.jsx)(N.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,r.jsx)("p",{children:"No hay documentos para este caso"}),t&&(0,r.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Subir Documento" para agregar el primer documento'})]})]})]})}function k(e){var a;let{document:t,canEdit:o,canDelete:l,isEditing:c,onEdit:d,onCancelEdit:p,onSave:u,onDelete:m,onDownload:x,getFileIcon:h,getVisibilityIcon:g,getVisibilityBadge:f}=e,[b,j]=(0,i.useState)({nombre:t.nombre,visibilidad:t.visibilidad});return(0,r.jsx)(n.Zp,{className:"border-l-4 border-l-green-500",children:(0,r.jsx)(n.Wu,{className:"pt-4",children:(0,r.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("span",{className:"text-2xl",children:h(t.tipo_mime||"")}),(0,r.jsxs)("div",{children:[c?(0,r.jsx)("input",{type:"text",value:b.nombre,onChange:e=>j({...b,nombre:e.target.value}),className:"form-input text-sm"}):(0,r.jsx)("h4",{className:"font-medium text-gray-900",children:t.nombre}),(0,r.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[g(t.visibilidad||"privado"),c?(0,r.jsxs)("select",{value:b.visibilidad,onChange:e=>j({...b,visibilidad:e.target.value}),className:"form-input text-xs",children:[(0,r.jsx)("option",{value:"privado",children:"Privado"}),(0,r.jsx)("option",{value:"cliente",children:"Cliente"})]}):f(t.visibilidad||"privado"),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:(0,v.v7)(t.size_bytes||0)})]}),(0,r.jsxs)("div",{className:"text-xs text-gray-400 mt-1",children:["Subido por ",(null==(a=t.uploader)?void 0:a.nombre)||"Usuario"," • ",(0,v.fw)(t.created_at)]})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)(s.$,{variant:"ghost",size:"sm",onClick:x,children:(0,r.jsx)(y.A,{className:"h-4 w-4"})}),o&&(0,r.jsx)(r.Fragment,{children:c?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.$,{variant:"ghost",size:"sm",onClick:p,children:"Cancelar"}),(0,r.jsx)(s.$,{size:"sm",onClick:()=>{b.nombre.trim()&&u(b)},children:"Guardar"})]}):(0,r.jsx)(s.$,{variant:"ghost",size:"sm",onClick:d,children:(0,r.jsx)(_.A,{className:"h-4 w-4"})})}),l&&!c&&(0,r.jsx)(s.$,{variant:"ghost",size:"sm",onClick:m,children:(0,r.jsx)(E.A,{className:"h-4 w-4"})})]})]})})})}},25711:(e,a,t)=>{t.d(a,{L:()=>R});var r=t(11291),i=t(97451),s=t(90718),n=t(82596),o=t(9983),l=t(68630),c=t(59030);let d=(0,c.createServerReference)("409b0a64c97bfe61b6e8814829fd1beb5b3c0ce84b",c.callServer,void 0,c.findSourceMapURL,"getInfoRequests"),p=(0,c.createServerReference)("40590b8aeb9cfa434beea52a3b54560f16fb3251f6",c.callServer,void 0,c.findSourceMapURL,"createInfoRequest"),u=(0,c.createServerReference)("606404fa1c57a53adafcdadd0b4189028f4b743e65",c.callServer,void 0,c.findSourceMapURL,"respondInfoRequest"),m=(0,c.createServerReference)("40b3ae676bee74d4c392577de287d9a07360d67bdc",c.callServer,void 0,c.findSourceMapURL,"closeInfoRequest");var x=t(93293),v=t(71428),h=t(96843),g=t(38417),f=t(64501),b=t(23403),j=t(35947),N=t(11762),y=t(27416),_=t(90465),E=t(91969),w=t(49833),S=t(66383);S.Ik({case_id:S.Yj().uuid("ID de caso inv\xe1lido"),titulo:S.Yj().min(1,"El t\xedtulo es requerido").max(1e3,"El t\xedtulo no puede exceder 1000 caracteres"),descripcion:S.Yj().min(1,"La descripci\xf3n es requerida").max(2e3,"La descripci\xf3n no puede exceder 2000 caracteres"),tipo:S.k5(["documento","informacion","reunion","otro"]).default("informacion"),prioridad:S.k5(["baja","media","alta","urgente"]).default("media"),fecha_limite:S.Yj().optional(),es_publica:S.zM().default(!0)}).partial().omit({case_id:!0}),S.Ik({respuesta:S.Yj().min(1,"La respuesta es requerida").max(2e3,"La respuesta no puede exceder 2000 caracteres"),archivo_adjunto:S.Yj().optional()}),S.Ik({case_id:S.Yj().uuid().optional(),estado:S.k5(["pendiente","en_revision","respondida","cerrada"]).optional(),tipo:S.k5(["documento","informacion","reunion","otro"]).optional(),prioridad:S.k5(["baja","media","alta","urgente"]).optional(),creador_id:S.Yj().uuid().optional(),es_publica:S.zM().optional(),fecha_desde:S.Yj().optional(),fecha_hasta:S.Yj().optional(),search:S.Yj().optional(),page:S.ai().min(1).default(1),limit:S.ai().min(1).max(100).default(20)});let C=[{value:"documento",label:"Documento",description:"Solicitud de documentos espec\xedficos"},{value:"informacion",label:"Informaci\xf3n",description:"Solicitud de informaci\xf3n general"},{value:"reunion",label:"Reuni\xf3n",description:"Solicitud de reuni\xf3n o cita"},{value:"otro",label:"Otro",description:"Otro tipo de solicitud"}],k=[{value:"pendiente",label:"Pendiente",color:"yellow"},{value:"en_revision",label:"En Revisi\xf3n",color:"blue"},{value:"respondida",label:"Respondida",color:"green"},{value:"cerrada",label:"Cerrada",color:"gray"}],A=[{value:"baja",label:"Baja",color:"gray"},{value:"media",label:"Media",color:"blue"},{value:"alta",label:"Alta",color:"orange"},{value:"urgente",label:"Urgente",color:"red"}];function R(e){let{caseId:a,canCreateRequests:t=!1,canRespondRequests:o=!1,showPrivateRequests:c=!0}=e,[x,N]=(0,i.useState)([]),[y,_]=(0,i.useState)(!0),[E,w]=(0,i.useState)(!1),[S,R]=(0,i.useState)(null),[D,I]=(0,i.useState)(!1),[q,M]=(0,i.useState)({titulo:"",descripcion:"",tipo:"informacion",prioridad:"media",fecha_limite:"",es_publica:!0}),[L,T]=(0,i.useState)({respuesta:"",archivo_adjunto:""}),{toast:F}=(0,l.dj)(),P=async()=>{_(!0);try{let e=await d({case_id:a,page:1,limit:50});e.success?N(e.requests):F({title:"Error",description:e.error||"Error al cargar solicitudes",variant:"destructive"})}catch(e){console.error("Error loading requests:",e),F({title:"Error",description:"Error inesperado al cargar solicitudes",variant:"destructive"})}finally{_(!1)}};(0,i.useEffect)(()=>{P()},[a]);let U=async()=>{if(!q.titulo.trim()||!q.descripcion.trim())return void F({title:"Error",description:"El t\xedtulo y la descripci\xf3n son requeridos",variant:"destructive"});w(!0);try{let e={case_id:a,titulo:q.titulo.trim(),descripcion:q.descripcion.trim(),tipo:q.tipo,prioridad:q.prioridad,fecha_limite:q.fecha_limite||void 0,es_publica:q.es_publica},t=await p(e);t.success?(F({title:"Solicitud creada",description:"La solicitud ha sido creada exitosamente"}),M({titulo:"",descripcion:"",tipo:"informacion",prioridad:"media",fecha_limite:"",es_publica:!0}),I(!1),await P()):F({title:"Error",description:t.error||"Error al crear la solicitud",variant:"destructive"})}catch(e){console.error("Error creating request:",e),F({title:"Error",description:"Error inesperado al crear la solicitud",variant:"destructive"})}finally{w(!1)}},Y=async e=>{if(!L.respuesta.trim())return void F({title:"Error",description:"La respuesta es requerida",variant:"destructive"});try{let a={respuesta:L.respuesta.trim(),archivo_adjunto:L.archivo_adjunto||void 0},t=await u(e,a);t.success?(F({title:"Respuesta enviada",description:"La respuesta ha sido enviada exitosamente"}),T({respuesta:"",archivo_adjunto:""}),R(null),await P()):F({title:"Error",description:t.error||"Error al enviar la respuesta",variant:"destructive"})}catch(e){console.error("Error responding to request:",e),F({title:"Error",description:"Error inesperado al enviar la respuesta",variant:"destructive"})}},$=async e=>{try{let a=await m(e);a.success?(F({title:"Solicitud cerrada",description:"La solicitud ha sido cerrada"}),await P()):F({title:"Error",description:a.error||"Error al cerrar la solicitud",variant:"destructive"})}catch(e){console.error("Error closing request:",e),F({title:"Error",description:"Error inesperado al cerrar la solicitud",variant:"destructive"})}},Z=e=>{switch(e){case"respondida":return(0,r.jsx)(v.A,{className:"h-5 w-5 text-green-600"});case"en_revision":return(0,r.jsx)(h.A,{className:"h-5 w-5 text-blue-600"});case"cerrada":return(0,r.jsx)(g.A,{className:"h-5 w-5 text-gray-600"});default:return(0,r.jsx)(f.A,{className:"h-5 w-5 text-yellow-600"})}},B=e=>{let a=k.find(a=>a.value===e);return a?(0,r.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat({yellow:"bg-yellow-100 text-yellow-800",blue:"bg-blue-100 text-blue-800",green:"bg-green-100 text-green-800",gray:"bg-gray-100 text-gray-800"}[a.color]),children:a.label}):null},W=e=>{let a=A.find(a=>a.value===e);return a?(0,r.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat({gray:"bg-gray-100 text-gray-800",blue:"bg-blue-100 text-blue-800",orange:"bg-orange-100 text-orange-800",red:"bg-red-100 text-red-800"}[a.color]),children:a.label}):null},O=e=>{let a=C.find(a=>a.value===e);return a?a.label:e},V=c?x:x.filter(e=>e.es_publica);return y?(0,r.jsxs)(n.Zp,{children:[(0,r.jsx)(n.aR,{children:(0,r.jsxs)(n.ZB,{className:"flex items-center gap-2",children:[(0,r.jsx)(f.A,{className:"h-5 w-5"}),"Solicitudes de Informaci\xf3n"]})}),(0,r.jsx)(n.Wu,{children:(0,r.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,r.jsx)(b.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,r.jsxs)(n.Zp,{children:[(0,r.jsx)(n.aR,{children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)(n.ZB,{className:"flex items-center gap-2",children:[(0,r.jsx)(f.A,{className:"h-5 w-5"}),"Solicitudes de Informaci\xf3n (",V.length,")"]}),t&&(0,r.jsxs)(s.$,{size:"sm",onClick:()=>I(!D),disabled:E,children:[(0,r.jsx)(j.A,{className:"h-4 w-4 mr-2"}),"Nueva Solicitud"]})]})}),(0,r.jsxs)(n.Wu,{className:"space-y-4",children:[D&&t&&(0,r.jsx)(n.Zp,{className:"border-dashed",children:(0,r.jsx)(n.Wu,{className:"pt-6",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"T\xedtulo *"}),(0,r.jsx)("input",{type:"text",value:q.titulo,onChange:e=>M({...q,titulo:e.target.value}),placeholder:"T\xedtulo de la solicitud",className:"form-input"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Descripci\xf3n *"}),(0,r.jsx)("textarea",{value:q.descripcion,onChange:e=>M({...q,descripcion:e.target.value}),placeholder:"Describe detalladamente lo que necesitas...",rows:4,className:"form-input"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Tipo"}),(0,r.jsx)("select",{value:q.tipo,onChange:e=>M({...q,tipo:e.target.value}),className:"form-input",children:C.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Prioridad"}),(0,r.jsx)("select",{value:q.prioridad,onChange:e=>M({...q,prioridad:e.target.value}),className:"form-input",children:A.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Fecha l\xedmite (opcional)"}),(0,r.jsx)("input",{type:"date",value:q.fecha_limite,onChange:e=>M({...q,fecha_limite:e.target.value}),className:"form-input"})]})]}),(0,r.jsx)("div",{children:(0,r.jsxs)("label",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{type:"checkbox",checked:q.es_publica,onChange:e=>M({...q,es_publica:e.target.checked})}),(0,r.jsx)("span",{className:"text-sm",children:"Visible para el abogado"})]})}),(0,r.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,r.jsx)(s.$,{variant:"outline",onClick:()=>{I(!1),M({titulo:"",descripcion:"",tipo:"informacion",prioridad:"media",fecha_limite:"",es_publica:!0})},disabled:E,children:"Cancelar"}),(0,r.jsx)(s.$,{onClick:U,disabled:E,children:E?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(b.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Creando..."]}):"Crear Solicitud"})]})]})})}),(0,r.jsx)("div",{className:"space-y-3",children:V.map(e=>(0,r.jsx)(z,{request:e,canRespond:o,isResponding:S===e.id,response:L,onStartResponding:()=>R(e.id),onCancelResponding:()=>{R(null),T({respuesta:"",archivo_adjunto:""})},onResponseChange:T,onSendResponse:()=>Y(e.id),onClose:()=>$(e.id),getStatusIcon:Z,getStatusBadge:B,getPriorityBadge:W,getTypeIcon:O},e.id))}),0===V.length&&(0,r.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,r.jsx)(f.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,r.jsx)("p",{children:"No hay solicitudes de informaci\xf3n"}),t&&(0,r.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Nueva Solicitud" para crear la primera solicitud'})]})]})]})}function z(e){var a,t;let{request:i,canRespond:l,isResponding:c,response:d,onStartResponding:p,onCancelResponding:u,onResponseChange:m,onSendResponse:v,onClose:h,getStatusIcon:f,getStatusBadge:b,getPriorityBadge:j,getTypeIcon:S}=e,C=i.fecha_limite&&(0,x.m7)(i.fecha_limite)&&"respondida"!==i.estado&&"cerrada"!==i.estado;return(0,r.jsx)(n.Zp,{className:"border-l-4 ".concat(C?"border-l-red-500":"border-l-blue-500"),children:(0,r.jsxs)(n.Wu,{className:"pt-4",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[f(i.estado||"pendiente"),(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900",children:i.titulo}),(0,r.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[b(i.estado||"pendiente"),j(i.prioridad||"media"),(0,r.jsx)(o.E,{variant:"outline",children:S(i.tipo||"informacion")}),!i.es_publica&&(0,r.jsx)(o.E,{variant:"outline",children:"Privada"})]})]})]}),C&&(0,r.jsx)(N.A,{className:"h-5 w-5 text-red-500"})]}),(0,r.jsx)("p",{className:"text-sm text-gray-700 mb-3",children:i.descripcion}),(0,r.jsxs)("div",{className:"flex items-center gap-4 text-sm text-gray-500 mb-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)(y.A,{className:"h-4 w-4"}),(0,r.jsx)("span",{children:(null==(a=i.creador)?void 0:a.nombre)||"Usuario"})]}),(0,r.jsx)("span",{children:(0,x.fw)(i.created_at)}),i.fecha_limite&&(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)(_.A,{className:"h-4 w-4"}),(0,r.jsxs)("span",{className:C?"text-red-600 font-medium":"",children:["L\xedmite: ",new Date(i.fecha_limite).toLocaleDateString("es-CL")]})]})]}),i.respuesta&&(0,r.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 mb-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,r.jsx)(E.A,{className:"h-4 w-4 text-blue-600"}),(0,r.jsxs)("span",{className:"text-sm font-medium",children:["Respuesta de ",(null==(t=i.respondido_por_profile)?void 0:t.nombre)||"Abogado"]}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:i.respondido_at&&(0,x.fw)(i.respondido_at)})]}),(0,r.jsx)("p",{className:"text-sm text-gray-700",children:i.respuesta}),i.archivo_adjunto&&(0,r.jsx)("a",{href:i.archivo_adjunto,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:underline mt-2 inline-block",children:"Ver archivo adjunto"})]}),c&&(0,r.jsx)("div",{className:"bg-blue-50 rounded-lg p-3 mb-3",children:(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("textarea",{value:d.respuesta,onChange:e=>m({...d,respuesta:e.target.value}),placeholder:"Escribe tu respuesta...",rows:3,className:"form-input"}),(0,r.jsx)("input",{type:"url",value:d.archivo_adjunto,onChange:e=>m({...d,archivo_adjunto:e.target.value}),placeholder:"URL del archivo adjunto (opcional)",className:"form-input"}),(0,r.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,r.jsx)(s.$,{size:"sm",variant:"outline",onClick:u,children:"Cancelar"}),(0,r.jsxs)(s.$,{size:"sm",onClick:v,children:[(0,r.jsx)(w.A,{className:"h-4 w-4 mr-1"}),"Enviar Respuesta"]})]})]})}),l&&"cerrada"!==i.estado&&(0,r.jsxs)("div",{className:"flex items-center gap-2",children:["respondida"!==i.estado&&!c&&(0,r.jsxs)(s.$,{size:"sm",variant:"outline",onClick:p,children:[(0,r.jsx)(E.A,{className:"h-4 w-4 mr-1"}),"Responder"]}),"respondida"===i.estado&&(0,r.jsxs)(s.$,{size:"sm",variant:"outline",onClick:h,children:[(0,r.jsx)(g.A,{className:"h-4 w-4 mr-1"}),"Cerrar"]})]})]})})}},41782:(e,a,t)=>{t.d(a,{X:()=>i});var r=t(59030);let i=(0,r.createServerReference)("4075c1ceb223881a0e7965a110fc966b45d5dff05e",r.callServer,void 0,r.findSourceMapURL,"uploadDocument")},44722:(e,a,t)=>{t.d(a,{S:()=>T});var r=t(11291),i=t(97451),s=t(90718),n=t(82596),o=t(9983),l=t(68630),c=t(59030);let d=(0,c.createServerReference)("407d6cb4ff2bd39dcaf5f15fa9d0e06606b79d5032",c.callServer,void 0,c.findSourceMapURL,"getStages"),p=(0,c.createServerReference)("4085495ff5376de2d9544dda91281e646ae494c949",c.callServer,void 0,c.findSourceMapURL,"createStage"),u=(0,c.createServerReference)("60ca260422e043e8d031aa4e5ec5aa5cec62c69295",c.callServer,void 0,c.findSourceMapURL,"completeStage"),m=(0,c.createServerReference)("400967a73b9add91995e0337cec7f66ae699a36c62",c.callServer,void 0,c.findSourceMapURL,"deleteStage"),x=(0,c.createServerReference)("608da5f884100b9fa525729204e6c90fb38047921a",c.callServer,void 0,c.findSourceMapURL,"updateStage"),v=(0,c.createServerReference)("60d22c0eee3e81479564a5d2c578cd4d8d7527f1eb",c.callServer,void 0,c.findSourceMapURL,"requestCaseAdvance");var h=t(93293),g=t(71428),f=t(96843),b=t(74759),j=t(23403),N=t(35947),y=t(90465),_=t(27416),E=t(87917),w=t(3814),S=t(77230),C=t(87442),k=t(67759),A=t(55096),R=t(62490),z=t(94724),D=t(66383);D.Ik({case_id:D.Yj().uuid("ID de caso inv\xe1lido"),etapa:D.Yj().min(1,"El nombre de la etapa es requerido").max(1e3,"El nombre no puede exceder 1000 caracteres"),descripcion:D.Yj().optional(),fecha_programada:D.Yj().optional(),fecha_completada:D.Yj().optional(),estado:D.k5(["pendiente","en_proceso","completado"]).default("pendiente"),es_publica:D.zM().default(!0),orden:D.ai().int().positive("El orden debe ser un n\xfamero positivo"),responsable_id:D.Yj().uuid("ID de responsable inv\xe1lido").optional(),requiere_pago:D.zM().default(!1),costo_uf:D.ai().min(0,"El costo debe ser positivo").optional(),porcentaje_variable:D.ai().min(0,"El porcentaje debe ser positivo").max(100,"El porcentaje no puede exceder 100").optional(),estado_pago:D.k5(["pendiente","en_proceso","parcial","pagado","vencido"]).default("pendiente"),enlace_pago:D.Yj().url("Debe ser una URL v\xe1lida").optional(),notas_pago:D.Yj().max(1e3,"Las notas no pueden exceder 1000 caracteres").optional(),monto_variable_base:D.Yj().optional(),monto_pagado_uf:D.ai().min(0,"El monto pagado debe ser positivo").optional()}).partial().omit({case_id:!0}),D.Ik({fecha_completada:D.Yj().optional(),observaciones:D.Yj().optional()}),D.Ik({case_id:D.Yj().uuid().optional(),estado:D.k5(["pendiente","en_proceso","completado"]).optional(),responsable_id:D.Yj().uuid().optional(),es_publica:D.zM().optional(),fecha_desde:D.Yj().optional(),fecha_hasta:D.Yj().optional(),page:D.ai().min(1).default(1),limit:D.ai().min(1).max(100).default(20)});let I={Civil:[.15,.1,.1,.1,.15,.2,.1,.05,.05],Comercial:[.2,.15,.15,.2,.15,.1,.05],Laboral:[.2,.2,.2,.2,.1,.1],Familia:[.2,.15,.15,.15,.2,.15]},q={Civil:[{etapa:"Ingreso Demanda",descripcion:"Presentaci\xf3n de la demanda con antecedentes y revisi\xf3n formal del tribunal.",diasEstimados:0},{etapa:"Notificaci\xf3n a la contraparte",descripcion:"Gestiones de notificaci\xf3n personal o por c\xe9dula al demandado.",diasEstimados:30},{etapa:"Contestaci\xf3n de la demanda",descripcion:"Plazo legal para que la contraparte conteste y proponga excepciones.",diasEstimados:20},{etapa:"R\xe9plicas y d\xfaplicas",descripcion:"Intercambio de escritos aclarando puntos controvertidos.",diasEstimados:15},{etapa:"Audiencia preparatoria",descripcion:"Fijaci\xf3n de puntos de prueba y acuerdos probatorios.",diasEstimados:30},{etapa:"Periodo probatorio",descripcion:"Recepci\xf3n de declaraciones, oficios, peritajes y documental.",diasEstimados:45},{etapa:"Alegatos y vista de la causa",descripcion:"Audiencia de cierre donde las partes exponen sus argumentos finales.",diasEstimados:20},{etapa:"Sentencia de primera instancia",descripcion:"Redacci\xf3n y publicaci\xf3n del fallo por el tribunal.",diasEstimados:60},{etapa:"Recursos y cumplimiento",descripcion:"Interposici\xf3n de recursos o cumplimiento voluntario/forzado.",diasEstimados:30}],Comercial:[{etapa:"Ingreso Demanda",descripcion:"Presentaci\xf3n de la demanda y verificaci\xf3n formal.",diasEstimados:0},{etapa:"Notificaci\xf3n demandado",descripcion:"Gesti\xf3n de notificaci\xf3n a la contraparte y acreditaci\xf3n en autos.",diasEstimados:20},{etapa:"Contestaci\xf3n y reconvenci\xf3n",descripcion:"Respuesta del demandado y eventuales reconvenciones.",diasEstimados:20},{etapa:"Audiencia preparatoria",descripcion:"Determinaci\xf3n de hechos a probar y medios de prueba.",diasEstimados:25},{etapa:"Prueba y alegatos",descripcion:"Producci\xf3n de prueba documental, testimonial y alegatos finales.",diasEstimados:40},{etapa:"Sentencia",descripcion:"Decisi\xf3n del tribunal y notificaci\xf3n a las partes.",diasEstimados:45},{etapa:"Ejecuci\xf3n o recursos",descripcion:"Cumplimiento del fallo o tramitaci\xf3n de recursos.",diasEstimados:30}],Laboral:[{etapa:"Ingreso tutela o demanda laboral",descripcion:"Ingreso del escrito y asignaci\xf3n de audiencia preliminar.",diasEstimados:0},{etapa:"Citaciones y notificaci\xf3n empleador",descripcion:"Notificaci\xf3n de la demanda y citaci\xf3n a audiencia preparatoria.",diasEstimados:10},{etapa:"Audiencia preparatoria",descripcion:"Intento de conciliaci\xf3n y fijaci\xf3n de puntos controvertidos.",diasEstimados:15},{etapa:"Audiencia de juicio",descripcion:"Producci\xf3n de prueba y alegatos finales.",diasEstimados:20},{etapa:"Sentencia laboral",descripcion:"Pronunciamiento del tribunal y notificaci\xf3n a las partes.",diasEstimados:15},{etapa:"Cumplimiento / Recurso de nulidad",descripcion:"Tramitaci\xf3n de recursos o ejecuci\xf3n de la sentencia.",diasEstimados:20}],Familia:[{etapa:"Ingreso demanda o escrito inicial",descripcion:"Ingreso de medida de protecci\xf3n o demanda ante tribunal de familia.",diasEstimados:0},{etapa:"Notificaci\xf3n y citaci\xf3n a audiencia",descripcion:"Notificaci\xf3n a la contraparte y citaci\xf3n a audiencia preparatoria.",diasEstimados:10},{etapa:"Audiencia preparatoria",descripcion:"Determinaci\xf3n de puntos controvertidos y acumulaci\xf3n de prueba.",diasEstimados:15},{etapa:"Audiencia de juicio",descripcion:"Presentaci\xf3n de prueba, declaraciones y alegatos.",diasEstimados:20},{etapa:"Sentencia",descripcion:"Redacci\xf3n y comunicaci\xf3n del fallo.",diasEstimados:20},{etapa:"Cumplimiento y seguimiento",descripcion:"Ejecuci\xf3n de medidas decretadas y seguimiento del cumplimiento.",diasEstimados:25}]},M=[{value:"pendiente",label:"Pendiente",color:"gray"},{value:"en_proceso",label:"En Proceso",color:"blue"},{value:"completado",label:"Completado",color:"green"}],L=[{value:"pendiente",label:"Pendiente",color:"gray"},{value:"solicitado",label:"Solicitado por cliente",color:"blue"},{value:"en_proceso",label:"En proceso",color:"amber"},{value:"parcial",label:"Pago parcial",color:"blue"},{value:"pagado",label:"Pagado",color:"green"},{value:"vencido",label:"Vencido",color:"red"}];function T(e){var a,t,c;let{caseId:D,caseMateria:T="Civil",canManageStages:F=!1,showPrivateStages:P=!0,clientContext:U,onClientProgressChange:Y,onStagesLoaded:$}=e,[Z,B]=(0,i.useState)([]),[W,O]=(0,i.useState)(!0),[V,H]=(0,i.useState)(!1),[G,X]=(0,i.useState)(null),[K,Q]=(0,i.useState)(!1),[J,ee]=(0,i.useState)({etapa:"",descripcion:"",fecha_programada:"",es_publica:!0,isCustom:!1,requiere_pago:!1,costo_uf:"",porcentaje_variable:"",enlace_pago:"",notas_pago:"",monto_variable_base:"",estado_pago:"pendiente",monto_pagado_uf:""}),{toast:ea}=(0,l.dj)(),[et,er]=(0,i.useState)(null),[ei,es]=(0,i.useState)(null),en=null!=(a=null==U?void 0:U.alcanceAutorizado)?a:0,eo=null!=(t=null==U?void 0:U.alcanceSolicitado)?t:0,el="cliente"===(null!=(c=null==U?void 0:U.role)?c:"cliente"),[ec,ed]=(0,i.useState)({solicitado:eo,autorizado:en}),[ep,eu]=(0,i.useState)(null),em=async()=>{O(!0);try{let e=await d({case_id:D,page:1,limit:50});e.success?(B(e.stages),null==$||$(e.stages)):ea({title:"Error",description:e.error||"Error al cargar etapas",variant:"destructive"})}catch(e){console.error("Error loading stages:",e),ea({title:"Error",description:"Error inesperado al cargar etapas",variant:"destructive"})}finally{O(!1)}};(0,i.useEffect)(()=>{em()},[D]),(0,i.useEffect)(()=>{ed({solicitado:eo,autorizado:en})},[eo,en]),(0,i.useEffect)(()=>{Y&&(ec.autorizado!==en||ec.solicitado!==eo)&&Y(ec)},[ec,Y,en,eo]);let ex=async()=>{var e,a,t;if(!J.etapa.trim())return void ea({title:"Error",description:"El nombre de la etapa es requerido",variant:"destructive"});let r=J.costo_uf?Number(J.costo_uf):void 0;if(J.requiere_pago&&(void 0===r||Number.isNaN(r)))return void ea({title:"Costo requerido",description:"Debes indicar el costo en UF de la etapa para poder cobrarla.",variant:"destructive"});if(void 0!==r&&r<0)return void ea({title:"Monto inv\xe1lido",description:"El costo en UF debe ser un n\xfamero positivo.",variant:"destructive"});let i=J.porcentaje_variable?Number(J.porcentaje_variable):void 0;if(void 0!==i&&(Number.isNaN(i)||i<0||i>100))return void ea({title:"Porcentaje inv\xe1lido",description:"El porcentaje variable debe estar entre 0% y 100%.",variant:"destructive"});let s=J.monto_pagado_uf?Number(J.monto_pagado_uf):void 0;if(void 0!==s&&(Number.isNaN(s)||s<0))return void ea({title:"Monto pagado inv\xe1lido",description:"El monto pagado debe ser un n\xfamero positivo.",variant:"destructive"});let n=null==(e=J.enlace_pago)?void 0:e.trim();if(n&&!/^https?:\/\//i.test(n))return void ea({title:"URL inv\xe1lida",description:"El enlace de pago debe comenzar con http:// o https://",variant:"destructive"});H(!0);try{let e=Math.max(...Z.map(e=>e.orden||0),0),o={case_id:D,etapa:J.etapa.trim(),descripcion:J.descripcion.trim()||void 0,fecha_programada:J.fecha_programada||void 0,es_publica:J.es_publica,estado:"pendiente",orden:e+1,requiere_pago:J.requiere_pago,costo_uf:r,porcentaje_variable:i,estado_pago:J.estado_pago||"pendiente",enlace_pago:n||void 0,notas_pago:(null==(a=J.notas_pago)?void 0:a.trim())||void 0,monto_variable_base:(null==(t=J.monto_variable_base)?void 0:t.trim())||void 0,monto_pagado_uf:s},l=await p(o);l.success?(ea({title:"Etapa creada",description:"La etapa ha sido creada exitosamente"}),ee({etapa:"",descripcion:"",fecha_programada:"",es_publica:!0,isCustom:!1,requiere_pago:!1,costo_uf:"",porcentaje_variable:"",enlace_pago:"",notas_pago:"",monto_variable_base:"",estado_pago:"pendiente",monto_pagado_uf:""}),Q(!1),await em()):ea({title:"Error",description:l.error||"Error al crear la etapa",variant:"destructive"})}catch(e){console.error("Error creating stage:",e),ea({title:"Error",description:"Error inesperado al crear la etapa",variant:"destructive"})}finally{H(!1)}},ev=async e=>{if(e.requiere_pago&&"pagado"!==e.estado_pago)return void ea({title:"Pago pendiente",description:"Debes registrar el pago de esta etapa antes de marcarla como completada.",variant:"destructive"});try{er(e.id);let a=await u(e.id);a.success?(ea({title:"Etapa completada",description:"La etapa ha sido marcada como completada"}),await em()):ea({title:"Error",description:a.error||"Error al completar la etapa",variant:"destructive"})}catch(e){console.error("Error completing stage:",e),ea({title:"Error",description:"Error inesperado al completar la etapa",variant:"destructive"})}finally{er(null)}},eh=async e=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar esta etapa?"))try{let a=await m(e);a.success?(ea({title:"Etapa eliminada",description:"La etapa ha sido eliminada exitosamente"}),await em()):ea({title:"Error",description:a.error||"Error al eliminar la etapa",variant:"destructive"})}catch(e){console.error("Error deleting stage:",e),ea({title:"Error",description:"Error inesperado al eliminar la etapa",variant:"destructive"})}},eg=e=>null==e?"—":"".concat(new Intl.NumberFormat("es-CL",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e)," UF"),ef=async e=>{if(el&&e.id){eu(e.id);try{let t=await v(D,e.id);if(t.success)ed(e=>{var a;return{autorizado:e.autorizado,solicitado:null!=(a=t.requestedOrder)?a:e.solicitado}}),ea({title:"Solicitud enviada",description:'Solicitaste avanzar hasta la etapa "'.concat(e.etapa,'".')}),await em();else{var a;ea({title:"No se pudo solicitar el avance",description:null!=(a=t.error)?a:"Intenta nuevamente en unos minutos.",variant:"destructive"})}}catch(e){console.error("Error requesting case advance:",e),ea({title:"Error inesperado",description:"No pudimos registrar tu solicitud, intenta nuevamente.",variant:"destructive"})}finally{eu(null)}}},eb=async e=>{var a;let t=prompt("Ingresa el enlace de pago de Payku para esta etapa",null!=(a=e.enlace_pago)?a:"");if(null===t)return;let r=t.trim();if(r&&!/^https?:\/\//i.test(r))return void ea({title:"URL inv\xe1lida",description:"Ingresa una URL v\xe1lida que comience con http:// o https://",variant:"destructive"});try{es(e.id);let a=await x(e.id,{enlace_pago:r||void 0,requiere_pago:!!r||e.requiere_pago});a.success?(ea({title:r?"Enlace de pago actualizado":"Enlace eliminado",description:r?"Comparte este enlace con el cliente para cobrar la etapa.":"Se elimin\xf3 el enlace asociado a la etapa."}),await em()):ea({title:"No se pudo guardar el enlace",description:a.error||"Intenta nuevamente.",variant:"destructive"})}catch(e){console.error("Error setting payment link:",e),ea({title:"Error inesperado",description:"No pudimos guardar el enlace en este momento.",variant:"destructive"})}finally{es(null)}},ej=async e=>{var a,t,r,i,s;let n=null!=(r=e.monto_pagado_uf)?r:null!=(t=e.costo_uf)?t:0,o=prompt("Monto pagado (UF)",n>0?n.toString():null!=(i=null==(a=e.costo_uf)?void 0:a.toString())?i:"");if(null===o)return;let l=Number(o.replace(",","."));if(Number.isNaN(l)||l<0)return void ea({title:"Monto inv\xe1lido",description:"Ingresa un n\xfamero v\xe1lido en UF.",variant:"destructive"});let c=null!=(s=e.costo_uf)?s:0,d=c>0&&l>=c?"pagado":"parcial";try{es(e.id);let a=await x(e.id,{estado_pago:d,monto_pagado_uf:l,requiere_pago:!0});a.success?(ea({title:"Pago registrado",description:"pagado"===d?"La etapa qued\xf3 marcada como pagada.":"Se registr\xf3 un pago parcial."}),await em()):ea({title:"No se pudo registrar el pago",description:a.error||"Vuelve a intentarlo.",variant:"destructive"})}catch(e){console.error("Error setting payment status:",e),ea({title:"Error inesperado",description:"No pudimos registrar el pago.",variant:"destructive"})}finally{es(null)}},eN=async e=>{if(!e.costo_uf||!e.monto_pagado_uf||!(e.monto_pagado_uf<e.costo_uf)||confirm("El monto registrado como pagado es menor al costo de la etapa. \xbfDeseas marcarla como pagada de todas maneras?"))try{var a,t;es(e.id);let r=await x(e.id,{estado_pago:"pagado",monto_pagado_uf:null!=(t=null!=(a=e.costo_uf)?a:e.monto_pagado_uf)?t:0,requiere_pago:!0});r.success?(ea({title:"Pago completado",description:"Esta etapa qued\xf3 marcada como pagada."}),await em()):ea({title:"No se pudo marcar como pagado",description:r.error||"Intenta nuevamente.",variant:"destructive"})}catch(e){console.error("Error marking stage paid:",e),ea({title:"Error inesperado",description:"No fue posible marcar la etapa como pagada.",variant:"destructive"})}finally{es(null)}},ey=P?Z:Z.filter(e=>e.es_publica),e_=function(e){var a;if(!e)return q.Civil;let t=e.toLowerCase(),r=Object.keys(q).find(e=>e.toLowerCase()===t),i=r?q[r]:q.Civil,s=r&&I[r]?I[r]:null!=(a=I.Civil)?a:[];return i.map((e,a)=>{var t;return{...e,porcentajeHonorario:null!=(t=s[a])?t:0}})}(T),eE=Z.reduce((e,a)=>{var t;return e+(null!=(t=a.costo_uf)?t:0)},0),ew=Z.reduce((e,a)=>{var t;return e+(null!=(t=a.monto_pagado_uf)?t:0)},0),eS=Z.filter(e=>e.requiere_pago),eC=eS.filter(e=>"pagado"===e.estado_pago).length,ek=eS.filter(e=>"pagado"!==e.estado_pago).length,eA=eS.filter(e=>"solicitado"===e.estado_pago).length,eR=e=>{var a;if(!e)return null;let t=Z.find(a=>{var t;return(null!=(t=a.orden)?t:0)===e});return null!=(a=null==t?void 0:t.etapa)?a:null},ez=el?eR(ec.solicitado):null,eD=el?eR(ec.autorizado):null;return((0,i.useEffect)(()=>{K&&eS.length>0&&ee(e=>({...e,requiere_pago:!0}))},[K,eS.length]),W)?(0,r.jsxs)(n.Zp,{children:[(0,r.jsx)(n.aR,{children:(0,r.jsxs)(n.ZB,{className:"flex items-center gap-2",children:[(0,r.jsx)(f.A,{className:"h-5 w-5"}),"Timeline Procesal"]})}),(0,r.jsx)(n.Wu,{children:(0,r.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,r.jsx)(j.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,r.jsxs)(n.Zp,{children:[(0,r.jsx)(n.aR,{children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)(n.ZB,{className:"flex items-center gap-2",children:[(0,r.jsx)(f.A,{className:"h-5 w-5"}),"Timeline Procesal (",ey.length,")"]}),F&&(0,r.jsxs)(s.$,{size:"sm",onClick:()=>Q(!K),disabled:V,children:[(0,r.jsx)(N.A,{className:"h-4 w-4 mr-2"}),"Nueva Etapa"]})]})}),(0,r.jsxs)(n.Wu,{className:"space-y-6",children:[eS.length>0&&(0,r.jsxs)("div",{className:"grid grid-cols-1 ".concat(el?"md:grid-cols-4":"md:grid-cols-3"," gap-3 rounded-lg border border-blue-100 bg-blue-50 p-4 text-sm text-blue-900"),children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Honorario distribuido"}),(0,r.jsx)("p",{className:"text-lg font-semibold",children:eg(eE)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Pagado"}),(0,r.jsx)("p",{className:"text-lg font-semibold",children:eg(ew)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Etapas liberadas"}),(0,r.jsxs)("p",{className:"text-lg font-semibold",children:[eC," / ",eS.length]}),ek>0&&(0,r.jsxs)("p",{className:"text-xs text-blue-700 mt-1",children:["Faltan ",ek," pago(s) para completar el plan."]})]}),el&&(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Solicitadas por el cliente"}),(0,r.jsx)("p",{className:"text-lg font-semibold",children:eA})]})]}),el&&(0,r.jsxs)("div",{className:"rounded-xl border border-slate-200 bg-white/80 px-4 py-4 text-sm text-slate-600 shadow-sm",children:[(0,r.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Alcance solicitado"}),(0,r.jsx)("p",{className:"text-base font-semibold text-slate-900",children:ec.solicitado>0?null!=ez?ez:"Etapa ".concat(ec.solicitado):"A\xfan no definido"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Autorizado por el estudio"}),(0,r.jsx)("p",{className:"text-base font-semibold text-slate-900",children:ec.autorizado>0?null!=eD?eD:"Etapa ".concat(ec.autorizado):"Pendiente"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Etapas solicitadas"}),(0,r.jsxs)("p",{className:"text-base font-semibold text-slate-900",children:[eA," / ",eS.length]})]})]}),ec.solicitado>ec.autorizado&&(0,r.jsx)("p",{className:"mt-3 text-xs text-slate-500",children:"Estamos revisando tu solicitud para avanzar. Te notificaremos cuando est\xe9 aprobada."})]}),K&&F&&(0,r.jsx)(n.Zp,{className:"border-dashed",children:(0,r.jsx)(n.Wu,{className:"pt-6",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Etapa"}),(0,r.jsxs)("select",{value:J.isCustom?"custom":J.etapa,onChange:e=>{var a;let t=e.target.value;if("custom"===t)return void ee({...J,etapa:"",descripcion:"",isCustom:!0});let r=e_.find(e=>e.etapa===t);ee({...J,etapa:t,descripcion:(null==r?void 0:r.descripcion)||J.descripcion,isCustom:!1,requiere_pago:null!=(a=null==r?void 0:r.requierePago)?a:J.requiere_pago,costo_uf:(null==r?void 0:r.costoUF)!==void 0?r.costoUF.toString():"",porcentaje_variable:(null==r?void 0:r.porcentajeVariable)!==void 0?r.porcentajeVariable.toString():"",monto_variable_base:(null==r?void 0:r.notasPago)||"",estado_pago:"pendiente",notas_pago:(null==r?void 0:r.notasPago)||""})},className:"form-input",children:[(0,r.jsx)("option",{value:"",children:"Seleccionar etapa"}),e_.map(e=>(0,r.jsxs)("option",{value:e.etapa,children:[e.etapa," ",e.diasEstimados?"(≈ ".concat(e.diasEstimados," d\xedas)"):""]},e.etapa)),(0,r.jsx)("option",{value:"custom",children:"Etapa personalizada..."})]}),J.isCustom&&(0,r.jsx)("input",{type:"text",placeholder:"Nombre de la etapa personalizada",value:J.etapa,onChange:e=>ee({...J,etapa:e.target.value}),className:"form-input mt-2"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Descripci\xf3n (opcional)"}),(0,r.jsx)("textarea",{value:J.descripcion,onChange:e=>ee({...J,descripcion:e.target.value}),placeholder:"Descripci\xf3n de la etapa...",rows:3,className:"form-input"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Fecha programada (opcional)"}),(0,r.jsx)("input",{type:"date",value:J.fecha_programada,onChange:e=>ee({...J,fecha_programada:e.target.value}),className:"form-input"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Visibilidad"}),(0,r.jsxs)("select",{value:J.es_publica?"publica":"privada",onChange:e=>ee({...J,es_publica:"publica"===e.target.value}),className:"form-input",children:[(0,r.jsx)("option",{value:"publica",children:"P\xfablica (visible para cliente)"}),(0,r.jsx)("option",{value:"privada",children:"Privada (solo abogados)"})]})]})]}),(0,r.jsxs)("div",{className:"space-y-4 border-t border-gray-200 pt-4",children:[(0,r.jsxs)("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700",children:[(0,r.jsx)("input",{type:"checkbox",className:"rounded border-gray-300",checked:J.requiere_pago,onChange:e=>ee({...J,requiere_pago:e.target.checked,estado_pago:"pendiente"})}),"Esta etapa requiere pago para avanzar"]}),J.requiere_pago&&(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium",children:"Monto fijo (UF)"}),(0,r.jsx)("input",{type:"number",min:"0",step:"0.01",value:J.costo_uf,onChange:e=>ee({...J,costo_uf:e.target.value}),className:"form-input",placeholder:"Ej: 5.0"})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium",children:"Componente variable (%)"}),(0,r.jsx)("input",{type:"number",min:"0",max:"100",step:"0.1",value:J.porcentaje_variable,onChange:e=>ee({...J,porcentaje_variable:e.target.value}),className:"form-input",placeholder:"Ej: 10"})]}),(0,r.jsxs)("div",{className:"md:col-span-2 space-y-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium",children:"Base del variable"}),(0,r.jsx)("textarea",{rows:2,value:J.monto_variable_base,onChange:e=>ee({...J,monto_variable_base:e.target.value}),className:"form-input",placeholder:"Ej: 10% de lo obtenido o ahorrado."})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium",children:"Link de pago (Payku)"}),(0,r.jsx)("input",{type:"url",value:J.enlace_pago,onChange:e=>ee({...J,enlace_pago:e.target.value}),className:"form-input",placeholder:"https://..."})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium",children:"Notas internas"}),(0,r.jsx)("textarea",{rows:2,value:J.notas_pago,onChange:e=>ee({...J,notas_pago:e.target.value}),className:"form-input",placeholder:"Instrucciones u observaciones sobre el cobro."})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium",children:"Estado inicial del pago"}),(0,r.jsx)("select",{value:J.estado_pago,onChange:e=>ee({...J,estado_pago:e.target.value}),className:"form-input",children:L.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium",children:"Monto ya pagado (UF)"}),(0,r.jsx)("input",{type:"number",min:"0",step:"0.01",value:J.monto_pagado_uf,onChange:e=>ee({...J,monto_pagado_uf:e.target.value}),className:"form-input",placeholder:"0.00"})]})]}),(0,r.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,r.jsx)(s.$,{variant:"outline",onClick:()=>{Q(!1),ee({etapa:"",descripcion:"",fecha_programada:"",es_publica:!0,isCustom:!1,requiere_pago:!1,costo_uf:"",porcentaje_variable:"",enlace_pago:"",notas_pago:"",monto_variable_base:"",estado_pago:"pendiente",monto_pagado_uf:""})},disabled:V,children:"Cancelar"}),(0,r.jsx)(s.$,{onClick:ex,disabled:V,children:V?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(j.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Creando..."]}):"Crear Etapa"})]})]})]})})}),(0,r.jsx)("div",{className:"relative",children:ey.map((e,a)=>{var t,i;let l=e.responsable,c=null!=(t=e.orden)?t:a+1,d=el&&c<=ec.autorizado,p=el&&c<=ec.solicitado&&c>ec.autorizado,u=["completado"===e.estado?"bg-green-50":"",d?"border-green-200 bg-green-50/70":"",!d&&p?"border-blue-200 bg-blue-50/70":""].filter(Boolean).join(" "),m="completado"===e.estado,x=d||m||(null!=(i=e.estado_pago)?i:"pendiente")==="pagado"||c<=ec.solicitado||ep===e.id;return(0,r.jsxs)("div",{className:"relative flex items-start space-x-4 pb-8",children:[a<ey.length-1&&(0,r.jsx)("div",{className:"absolute left-2.5 top-8 w-0.5 h-full bg-gray-200"}),(0,r.jsx)("div",{className:"relative z-10 flex-shrink-0",children:(e=>{switch(e){case"completado":return(0,r.jsx)(g.A,{className:"h-5 w-5 text-green-600"});case"en_proceso":return(0,r.jsx)(f.A,{className:"h-5 w-5 text-blue-600"});default:return(0,r.jsx)(b.A,{className:"h-5 w-5 text-gray-400"})}})(e.estado||"pendiente")}),(0,r.jsx)("div",{className:"flex-1 min-w-0",children:(0,r.jsx)(n.Zp,{className:u,children:(0,r.jsxs)(n.Wu,{className:"pt-4",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900",children:e.etapa}),e.descripcion&&(0,r.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:e.descripcion})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 ml-4",children:[(e=>{let a=M.find(a=>a.value===e);return a?(0,r.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat({gray:"bg-gray-100 text-gray-800",blue:"bg-blue-100 text-blue-800",green:"bg-green-100 text-green-800",red:"bg-red-100 text-red-800"}[a.color]),children:a.label}):null})(e.estado||"pendiente"),!e.es_publica&&(0,r.jsx)(o.E,{variant:"outline",children:"Privada"})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-4 text-sm text-gray-500 mb-3",children:[e.fecha_programada&&(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)(y.A,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:(0,h.m7)(e.fecha_programada)&&"completado"!==e.estado?"text-red-600 font-medium":"",children:(0,h.Yq)(e.fecha_programada)})]}),(null==l?void 0:l.nombre)&&(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)(_.A,{className:"h-4 w-4"}),(0,r.jsx)("span",{children:l.nombre})]}),e.fecha_cumplida&&(0,r.jsxs)("div",{className:"text-green-600",children:["Completado ",(0,h.fw)(e.fecha_cumplida)]})]}),e.requiere_pago&&(0,r.jsxs)("div",{className:"mt-3 rounded-lg border border-amber-200 bg-amber-50 p-3 text-sm space-y-2 text-amber-900",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 font-semibold",children:[(0,r.jsx)(E.A,{className:"h-4 w-4"}),(0,r.jsx)("span",{children:"Costo de la etapa:"}),(0,r.jsx)("span",{children:eg(e.costo_uf)})]}),(e=>{if(!e)return null;let a=L.find(a=>a.value===e);if(!a)return null;let t={gray:"bg-gray-100 text-gray-800",amber:"bg-amber-100 text-amber-800",blue:"bg-blue-100 text-blue-800",green:"bg-green-100 text-green-800",red:"bg-red-100 text-red-800"}[a.color]||"bg-gray-100 text-gray-800";return(0,r.jsx)(o.E,{className:t,variant:"outline",children:a.label})})(e.estado_pago||"pendiente")]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 text-amber-800",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(w.A,{className:"h-4 w-4"}),(0,r.jsxs)("span",{children:["Pagado: ",eg(e.monto_pagado_uf)]})]}),e.porcentaje_variable&&(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(S.A,{className:"h-4 w-4"}),(0,r.jsxs)("span",{children:["Variable: ",e.porcentaje_variable,"% ",e.monto_variable_base?"(".concat(e.monto_variable_base,")"):""]})]})]}),e.notas_pago&&(0,r.jsx)("p",{className:"text-xs text-amber-700 bg-white/60 border border-amber-200 rounded-md px-3 py-2",children:e.notas_pago}),"solicitado"===e.estado_pago&&(0,r.jsxs)("p",{className:"flex items-center gap-2 text-xs text-amber-700",children:[(0,r.jsx)(C.A,{className:"h-3 w-3"}),"Solicitud enviada"," ",e.solicitado_at?(0,h.fw)(e.solicitado_at):"recientemente","."]}),(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[e.enlace_pago&&(0,r.jsx)(s.$,{size:"sm",variant:"outline",asChild:!0,children:(0,r.jsxs)("a",{href:e.enlace_pago,target:"_blank",rel:"noopener noreferrer",children:[(0,r.jsx)(k.A,{className:"h-4 w-4 mr-2"}),"Abrir enlace Payku"]})}),F&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.$,{size:"sm",variant:"ghost",onClick:()=>eb(e),disabled:ei===e.id,children:ei===e.id?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(j.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Guardando…"]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(A.A,{className:"h-4 w-4 mr-2"}),e.enlace_pago?"Editar enlace":"Asignar enlace"]})}),(0,r.jsx)(s.$,{size:"sm",variant:"ghost",onClick:()=>ej(e),disabled:ei===e.id,children:ei===e.id?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(j.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Registrando…"]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(w.A,{className:"h-4 w-4 mr-2"}),"Registrar pago"]})}),(0,r.jsx)(s.$,{size:"sm",variant:"outline",onClick:()=>eN(e),disabled:ei===e.id,children:ei===e.id?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(j.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Confirmando…"]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(S.A,{className:"h-4 w-4 mr-2"}),"Marcar pagado"]})})]}),el&&!F&&(0,r.jsx)(s.$,{size:"sm",variant:"outline",onClick:()=>ef(e),disabled:x,children:ep===e.id?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(j.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Enviando…"]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(E.A,{className:"h-4 w-4 mr-2"}),"Solicitar prepago"]})})]}),"pagado"!==e.estado_pago&&e.enlace_pago&&(0,r.jsxs)("p",{className:"text-xs text-amber-700 flex items-center gap-1",children:[(0,r.jsx)(C.A,{className:"h-3 w-3"}),"Comparte el enlace con el cliente para liberar esta etapa."]})]}),F&&(0,r.jsxs)("div",{className:"flex items-center gap-2",children:["completado"!==e.estado&&(0,r.jsx)(s.$,{size:"sm",variant:"outline",onClick:()=>ev(e),disabled:et===e.id||e.requiere_pago&&"pagado"!==e.estado_pago,children:et===e.id?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(j.A,{className:"h-4 w-4 mr-1 animate-spin"}),"Procesando…"]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(g.A,{className:"h-4 w-4 mr-1"}),"Completar"]})}),(0,r.jsx)(s.$,{size:"sm",variant:"ghost",onClick:()=>X(e.id),children:(0,r.jsx)(R.A,{className:"h-4 w-4"})}),(0,r.jsx)(s.$,{size:"sm",variant:"ghost",onClick:()=>eh(e.id),children:(0,r.jsx)(z.A,{className:"h-4 w-4"})})]})]})})})]},e.id)})}),0===ey.length&&(0,r.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,r.jsx)(f.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,r.jsx)("p",{children:"No hay etapas definidas para este caso"}),F&&(0,r.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Nueva Etapa" para agregar la primera etapa'})]}),e_.length>0&&(0,r.jsxs)("div",{className:"border-t pt-4 mt-2",children:[(0,r.jsxs)("h3",{className:"text-sm font-semibold text-gray-700",children:["Plan estimado de referencia para materia ",T||"Civil"]}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Duraciones aproximadas en d\xedas a partir del inicio del caso."}),(0,r.jsx)("ul",{className:"mt-3 space-y-2 text-sm text-gray-600",children:e_.map((e,a)=>(0,r.jsxs)("li",{className:"flex items-start gap-2",children:[(0,r.jsx)("span",{className:"mt-1 h-2 w-2 rounded-full bg-blue-500 flex-shrink-0"}),(0,r.jsxs)("span",{children:[(0,r.jsx)("span",{className:"font-medium text-gray-800",children:e.etapa}),(0,r.jsxs)("span",{className:"block text-gray-500",children:[e.descripcion,e.diasEstimados?" \xb7 ≈ ".concat(e.diasEstimados," d\xedas"):""]})]})]},"".concat(e.etapa,"-").concat(a)))})]})]})]})}},54997:(e,a,t)=>{t.d(a,{_:()=>y});var r=t(11291),i=t(97451),s=t(90718),n=t(82596),o=t(9983),l=t(68630),c=t(59030);let d=(0,c.createServerReference)("40c65ac279e16daf07c1a74f8b3ab765a3040f1ce2",c.callServer,void 0,c.findSourceMapURL,"getNotes"),p=(0,c.createServerReference)("4012b70a5d87f841ea19b6c7403670ab3f6f53982d",c.callServer,void 0,c.findSourceMapURL,"createNote"),u=(0,c.createServerReference)("60e9b52677848e6ec117b36775fbbc96c53c2d4b8b",c.callServer,void 0,c.findSourceMapURL,"updateNote"),m=(0,c.createServerReference)("40bcd3afb7420703f0e38188f3b26c056f4dd76913",c.callServer,void 0,c.findSourceMapURL,"deleteNote");var x=t(93293),v=t(66656),h=t(53464),g=t(65030),f=t(23403),b=t(35947),j=t(62490),N=t(94724);function y(e){let{caseId:a,canCreateNotes:t=!1,canEditNotes:c=!1,showPrivateNotes:x=!0}=e,[j,N]=(0,i.useState)([]),[y,E]=(0,i.useState)(!0),[w,S]=(0,i.useState)(!1),[C,k]=(0,i.useState)(null),[A,R]=(0,i.useState)({tipo:"privada",contenido:""}),{toast:z}=(0,l.dj)(),D=async()=>{E(!0);try{let e=await d({case_id:a,page:1,limit:50});e.success?N(e.notes):z({title:"Error",description:e.error||"Error al cargar notas",variant:"destructive"})}catch(e){console.error("Error loading notes:",e),z({title:"Error",description:"Error inesperado al cargar notas",variant:"destructive"})}finally{E(!1)}};(0,i.useEffect)(()=>{D()},[a]);let I=async()=>{if(!A.contenido.trim())return void z({title:"Error",description:"El contenido de la nota es requerido",variant:"destructive"});S(!0);try{let e={case_id:a,tipo:A.tipo,contenido:A.contenido.trim()},t=await p(e);t.success?(z({title:"Nota creada",description:"La nota ha sido creada exitosamente"}),R({tipo:"privada",contenido:""}),await D()):z({title:"Error",description:t.error||"Error al crear la nota",variant:"destructive"})}catch(e){console.error("Error creating note:",e),z({title:"Error",description:"Error inesperado al crear la nota",variant:"destructive"})}finally{S(!1)}},q=async(e,a)=>{try{let t=await u(e,{contenido:a.trim()});t.success?(z({title:"Nota actualizada",description:"La nota ha sido actualizada exitosamente"}),k(null),await D()):z({title:"Error",description:t.error||"Error al actualizar la nota",variant:"destructive"})}catch(e){console.error("Error updating note:",e),z({title:"Error",description:"Error inesperado al actualizar la nota",variant:"destructive"})}},M=async e=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar esta nota?"))try{let a=await m(e);a.success?(z({title:"Nota eliminada",description:"La nota ha sido eliminada exitosamente"}),await D()):z({title:"Error",description:a.error||"Error al eliminar la nota",variant:"destructive"})}catch(e){console.error("Error deleting note:",e),z({title:"Error",description:"Error inesperado al eliminar la nota",variant:"destructive"})}},L=e=>"publica"===e?(0,r.jsx)(v.A,{className:"h-4 w-4 text-blue-600"}):(0,r.jsx)(h.A,{className:"h-4 w-4 text-gray-600"}),T=e=>"publica"===e?(0,r.jsx)(o.E,{variant:"default",children:"P\xfablica"}):(0,r.jsx)(o.E,{variant:"secondary",children:"Privada"}),F=x?j:j.filter(e=>"publica"===e.tipo);return y?(0,r.jsxs)(n.Zp,{children:[(0,r.jsx)(n.aR,{children:(0,r.jsxs)(n.ZB,{className:"flex items-center gap-2",children:[(0,r.jsx)(g.A,{className:"h-5 w-5"}),"Notas"]})}),(0,r.jsx)(n.Wu,{children:(0,r.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,r.jsx)(f.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,r.jsxs)(n.Zp,{children:[(0,r.jsx)(n.aR,{children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)(n.ZB,{className:"flex items-center gap-2",children:[(0,r.jsx)(g.A,{className:"h-5 w-5"}),"Notas (",F.length,")"]}),t&&(0,r.jsxs)(s.$,{size:"sm",onClick:()=>S(!w),disabled:w,children:[(0,r.jsx)(b.A,{className:"h-4 w-4 mr-2"}),"Nueva Nota"]})]})}),(0,r.jsxs)(n.Wu,{className:"space-y-4",children:[w&&t&&(0,r.jsx)(n.Zp,{className:"border-dashed",children:(0,r.jsx)(n.Wu,{className:"pt-6",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Tipo de nota"}),(0,r.jsxs)("select",{value:A.tipo,onChange:e=>R({...A,tipo:e.target.value}),className:"form-input",children:[(0,r.jsx)("option",{value:"privada",children:"Privada (solo abogados)"}),(0,r.jsx)("option",{value:"publica",children:"P\xfablica (visible para cliente)"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Contenido"}),(0,r.jsx)("textarea",{value:A.contenido,onChange:e=>R({...A,contenido:e.target.value}),placeholder:"Escribe tu nota aqu\xed...",rows:4,className:"form-input"})]}),(0,r.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,r.jsx)(s.$,{variant:"outline",onClick:()=>{S(!1),R({tipo:"privada",contenido:""})},children:"Cancelar"}),(0,r.jsx)(s.$,{onClick:I,children:"Crear Nota"})]})]})})}),(0,r.jsx)("div",{className:"space-y-3",children:F.map(e=>(0,r.jsx)(_,{note:e,canEdit:c,isEditing:C===e.id,onEdit:()=>k(e.id),onCancelEdit:()=>k(null),onSave:a=>q(e.id,a),onDelete:()=>M(e.id),getTypeIcon:L,getTypeBadge:T},e.id))}),0===F.length&&(0,r.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,r.jsx)(g.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,r.jsx)("p",{children:"No hay notas para este caso"}),t&&(0,r.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Nueva Nota" para agregar la primera nota'})]})]})]})}function _(e){var a;let{note:t,canEdit:o,isEditing:l,onEdit:c,onCancelEdit:d,onSave:p,onDelete:u,getTypeIcon:m,getTypeBadge:v}=e,[h,g]=(0,i.useState)(t.contenido);return(0,r.jsx)(n.Zp,{className:"border-l-4 border-l-blue-500",children:(0,r.jsxs)(n.Wu,{className:"pt-4",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[m(t.tipo),v(t.tipo),(0,r.jsxs)("span",{className:"text-sm text-gray-500",children:["por ",(null==(a=t.author)?void 0:a.nombre)||"Usuario"]}),(0,r.jsx)("span",{className:"text-sm text-gray-400",children:(0,x.fw)(t.created_at)})]}),o&&(0,r.jsx)("div",{className:"flex items-center gap-1",children:l?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.$,{variant:"ghost",size:"sm",onClick:d,children:"Cancelar"}),(0,r.jsx)(s.$,{size:"sm",onClick:()=>{h.trim()&&p(h)},children:"Guardar"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.$,{variant:"ghost",size:"sm",onClick:c,children:(0,r.jsx)(j.A,{className:"h-4 w-4"})}),(0,r.jsx)(s.$,{variant:"ghost",size:"sm",onClick:u,children:(0,r.jsx)(N.A,{className:"h-4 w-4"})})]})})]}),l?(0,r.jsx)("textarea",{value:h,onChange:e=>g(e.target.value),rows:4,className:"form-input w-full"}):(0,r.jsx)("div",{className:"prose prose-sm max-w-none",children:(0,r.jsx)("p",{className:"whitespace-pre-wrap text-gray-700",children:t.contenido})})]})})}},68630:(e,a,t)=>{t.d(a,{dj:()=>p});var r=t(97451);let i=0,s=new Map,n=e=>{if(s.has(e))return;let a=setTimeout(()=>{s.delete(e),c({type:"REMOVE_TOAST",toastId:e})},1e6);s.set(e,a)},o=[],l={toasts:[]};function c(e){l=((e,a)=>{switch(a.type){case"ADD_TOAST":return{...e,toasts:[a.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===a.toast.id?{...e,...a.toast}:e)};case"DISMISS_TOAST":{let{toastId:t}=a;return t?n(t):e.toasts.forEach(e=>{n(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===t||void 0===t?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===a.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==a.toastId)}}})(l,e),o.forEach(e=>{e(l)})}function d(e){let{...a}=e,t=(i=(i+1)%Number.MAX_SAFE_INTEGER).toString(),r=()=>c({type:"DISMISS_TOAST",toastId:t});return c({type:"ADD_TOAST",toast:{...a,id:t,open:!0,onOpenChange:e=>{e||r()}}}),{id:t,dismiss:r,update:e=>c({type:"UPDATE_TOAST",toast:{...e,id:t}})}}function p(){let[e,a]=r.useState(l);return r.useEffect(()=>(o.push(a),()=>{let e=o.indexOf(a);e>-1&&o.splice(e,1)}),[e]),{...e,toast:d,dismiss:e=>c(e?{type:"DISMISS_TOAST",toastId:e}:{type:"DISMISS_TOAST"})}}},68668:(e,a,t)=>{t.d(a,{B:()=>h});var r=t(11291),i=t(97451),s=t(59030);let n=(0,s.createServerReference)("40117251fa73708d6ea58a8a7fc4a4d3f84edd2290",s.callServer,void 0,s.findSourceMapURL,"sendCaseMessage"),o=(0,s.createServerReference)("6033992cdb782388fc84bef8a2922fd17c703a695a",s.callServer,void 0,s.findSourceMapURL,"listCaseMessages");var l=t(90718),c=t(848),d=t(82596),p=t(9983),u=t(93293),m=t(23403),x=t(49833),v=t(68630);function h(e){let{caseId:a,initialMessages:t,currentProfileId:s,allowSend:h=!0}=e,[g,f]=(0,i.useState)(t),[b,j]=(0,i.useState)(""),[N,y]=(0,i.useTransition)(),[_,E]=(0,i.useState)(!1),{toast:w}=(0,v.dj)();(0,i.useEffect)(()=>{f(t)},[t,a]),(0,i.useEffect)(()=>{0===t.length&&C()},[a]);let S=(0,i.useMemo)(()=>g.slice().sort((e,a)=>new Date(e.created_at).getTime()-new Date(a.created_at).getTime()),[g]),C=async()=>{E(!0);try{let e=await o(a,{limit:100});f(e)}catch(a){var e;w({title:"Error al actualizar",description:null!=(e=null==a?void 0:a.message)?e:"No fue posible obtener los mensajes.",variant:"destructive"})}finally{E(!1)}};return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-lexser-gray-900",children:"Mensajes del caso"}),(0,r.jsx)(l.$,{variant:"outline",size:"sm",onClick:C,disabled:_,children:_?(0,r.jsx)(m.A,{className:"h-4 w-4 animate-spin"}):"Actualizar"})]}),(0,r.jsx)("div",{className:"space-y-4",children:0===S.length?(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"A\xfan no hay mensajes para este caso."}):S.map(e=>{var a,t,i;let n=e.sender_profile_id===s;return(0,r.jsx)(d.Zp,{className:"border ".concat(n?"border-lexser-blue-200 bg-lexser-blue-50":"border-lexser-gray-100"),children:(0,r.jsxs)(d.Wu,{className:"p-4 space-y-2",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[(0,r.jsxs)("span",{children:[null!=(i=null==(a=e.sender)?void 0:a.nombre)?i:"Usuario",(null==(t=e.sender)?void 0:t.role)&&(0,r.jsx)(p.E,{variant:"outline",className:"ml-2 capitalize text-[10px]",children:e.sender.role})]}),(0,r.jsx)("span",{children:(0,u.r6)(e.created_at)})]}),(0,r.jsx)("p",{className:"text-sm text-lexser-gray-900 whitespace-pre-wrap",children:e.contenido}),e.attachment_url&&(0,r.jsx)("a",{href:e.attachment_url,target:"_blank",rel:"noopener noreferrer",className:"text-xs font-medium text-lexser-blue-600 hover:text-lexser-blue-700",children:"Ver adjunto"})]})},e.id)})}),h&&(0,r.jsxs)("div",{className:"rounded-lg border border-lexser-gray-200 p-4 space-y-3",children:[(0,r.jsx)(c.T,{placeholder:"Escribe un mensaje para tu cliente o equipo...",value:b,onChange:e=>j(e.target.value),disabled:N,className:"min-h-[120px]"}),(0,r.jsx)("div",{className:"flex items-center justify-end",children:(0,r.jsxs)(l.$,{onClick:()=>{if(!b.trim())return void w({title:"Mensaje vac\xedo",description:"Escribe un mensaje antes de enviarlo.",variant:"destructive"});y(async()=>{try{let e=await n({caseId:a,contenido:b.trim()});f(a=>[...a,e]),j("")}catch(a){var e;w({title:"No se pudo enviar",description:null!=(e=null==a?void 0:a.message)?e:"Intenta nuevamente en unos minutos.",variant:"destructive"})}})},disabled:N,children:[N?(0,r.jsx)(m.A,{className:"mr-2 h-4 w-4 animate-spin"}):(0,r.jsx)(x.A,{className:"mr-2 h-4 w-4"}),"Enviar"]})})]})]})}},82596:(e,a,t)=>{t.d(a,{Wu:()=>c,ZB:()=>l,Zp:()=>n,aR:()=>o});var r=t(11291),i=t(97451),s=t(93293);let n=i.forwardRef((e,a)=>{let{className:t,...i}=e;return(0,r.jsx)("div",{ref:a,className:(0,s.cn)("rounded-3xl border border-white/20 bg-white/70 text-card-foreground shadow-xl backdrop-blur-xl transition-colors",t),...i})});n.displayName="Card";let o=i.forwardRef((e,a)=>{let{className:t,...i}=e;return(0,r.jsx)("div",{ref:a,className:(0,s.cn)("flex flex-col space-y-1.5 px-6 py-5",t),...i})});o.displayName="CardHeader";let l=i.forwardRef((e,a)=>{let{className:t,...i}=e;return(0,r.jsx)("h3",{ref:a,className:(0,s.cn)("text-2xl font-semibold leading-none tracking-tight",t),...i})});l.displayName="CardTitle",i.forwardRef((e,a)=>{let{className:t,...i}=e;return(0,r.jsx)("p",{ref:a,className:(0,s.cn)("text-sm text-muted-foreground",t),...i})}).displayName="CardDescription";let c=i.forwardRef((e,a)=>{let{className:t,...i}=e;return(0,r.jsx)("div",{ref:a,className:(0,s.cn)("px-6 pb-6 pt-0 text-sm text-foreground/80",t),...i})});c.displayName="CardContent",i.forwardRef((e,a)=>{let{className:t,...i}=e;return(0,r.jsx)("div",{ref:a,className:(0,s.cn)("flex items-center p-6 pt-0",t),...i})}).displayName="CardFooter"},90718:(e,a,t)=>{t.d(a,{$:()=>c});var r=t(11291),i=t(97451),s=t(26809),n=t(11263),o=t(93293);let l=(0,n.F)("inline-flex items-center justify-center whitespace-nowrap rounded-2xl text-sm font-medium transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 ring-offset-transparent",{variants:{variant:{default:"border border-white/30 bg-white/70 text-foreground shadow-sm backdrop-blur-xl hover:bg-white/90 focus-visible:ring-primary/40 focus-visible:ring-offset-transparent",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/90 focus-visible:ring-destructive/40 focus-visible:ring-offset-transparent",outline:"border border-white/30 bg-transparent text-foreground/80 hover:bg-white/10 focus-visible:ring-primary/30 focus-visible:ring-offset-transparent",secondary:"border border-transparent bg-primary text-primary-foreground shadow-lg hover:bg-primary/90 focus-visible:ring-primary/40 focus-visible:ring-offset-transparent",ghost:"border border-transparent bg-transparent text-foreground/70 hover:bg-white/10",link:"text-primary underline-offset-4 hover:underline hover:text-primary/80"},size:{default:"h-10 px-5",sm:"h-9 rounded-xl px-3.5",lg:"h-12 rounded-2xl px-8 text-base",icon:"h-10 w-10 rounded-xl"}},defaultVariants:{variant:"default",size:"default"}}),c=i.forwardRef((e,a)=>{let{className:t,variant:i,size:n,asChild:c=!1,...d}=e,p=c?s.DX:"button";return(0,r.jsx)(p,{className:(0,o.cn)(l({variant:i,size:n,className:t})),ref:a,...d})});c.displayName="Button"},93293:(e,a,t)=>{t.d(a,{IM:()=>x,Yq:()=>c,cn:()=>o,fw:()=>u,kz:()=>d,m7:()=>v,nr:()=>m,qA:()=>g,r6:()=>p,v7:()=>h,vv:()=>l});var r=t(41111),i=t(98358);function s(e){return null!=e?e:""}function n(e){if(!e)return new Date("Invalid Date");let a="string"==typeof e?new Date(e):e;return isNaN(a.getTime())?new Date("Invalid Date"):a}function o(){for(var e=arguments.length,a=Array(e),t=0;t<e;t++)a[t]=arguments[t];return(0,i.QP)((0,r.$)(a))}function l(e){return new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0}).format(e)}function c(e){let a=n(null!=e?e:null);return isNaN(a.getTime())?"":new Intl.DateTimeFormat("es-CL",{year:"numeric",month:"long",day:"numeric"}).format(a)}function d(e){let a=n(null!=e?e:null);return isNaN(a.getTime())?"":new Intl.DateTimeFormat("es-CL",{year:"numeric",month:"2-digit",day:"2-digit"}).format(a)}function p(e){let a=n(null!=e?e:null);return isNaN(a.getTime())?"":new Intl.DateTimeFormat("es-CL",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(a)}function u(e){let a=n(null!=e?e:null);if(isNaN(a.getTime()))return"Fecha inv\xe1lida";let t=(Date.now()-a.getTime())/1e3;return t<60?"hace unos segundos":t<3600?"hace ".concat(Math.floor(t/60)," minutos"):t<86400?"hace ".concat(Math.floor(t/3600)," horas"):t<2592e3?"hace ".concat(Math.floor(t/86400)," d\xedas"):t<31104e3?"hace ".concat(Math.floor(t/2592e3)," meses"):"hace ".concat(Math.floor(t/31104e3)," a\xf1os")}function m(e){let a=s(e).replace(/[^0-9kK]/g,"");if(a.length<8)return a;let t=a.slice(0,-1),r=a.slice(-1),i=t.replace(/\B(?=(\d{3})+(?!\d))/g,".");return"".concat(i,"-").concat(r)}function x(e){let a=s(e).trim();return a?a.split(/\s+/).map(e=>e[0]).join("").toUpperCase().slice(0,2):""}function v(e){let a=n(null!=e?e:null);if(isNaN(a.getTime()))return!1;let t=new Date;t.setHours(0,0,0,0);let r=new Date(a);return r.setHours(0,0,0,0),r<t}function h(e){let a="number"!=typeof e||isNaN(e)?0:e;if(a<=0)return"0 Bytes";let t=["Bytes","KB","MB","GB"],r=Math.min(Math.floor(Math.log(a)/Math.log(1024)),t.length-1),i=(a/Math.pow(1024,r)).toFixed(2);return"".concat(i," ").concat(t[r])}function g(e){let a=s(e),t=0;for(let e=0;e<a.length;e++)t=a.charCodeAt(e)+((t<<5)-t);let r=(t%360+360)%360;return"hsl(".concat(r,", 70%, 50%)")}}}]);