(()=>{var a={};a.id=457,a.ids=[457],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:a=>{"use strict";a.exports=require("punycode")},15352:(a,b,c)=>{"use strict";c.d(b,{R:()=>i,r:()=>j});var d=c(79106),e=c(57626),f=c(55124);let g="https://xsvvdshbhaheqymquzjl.supabase.co",h=process.env.SUPABASE_SERVICE_ROLE_KEY;async function i(){let a=await (0,d.UL)();return(0,e.createServerClient)(g,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzdnZkc2hiaGFoZXF5bXF1empsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MDUxMTMsImV4cCI6MjA3NTA4MTExM30.exy4Scb4paVi8tGs_-FXuHpIW9OFsbCS5sC8J_XdLv8",{cookies:{get:b=>a.get(b)?.value,set(b,c,d){try{d?a.set(b,c,d):a.set(b,c)}catch{}},remove(b,c){try{c?a.set(b,"",{...c,expires:new Date(0)}):a.set(b,"",{expires:new Date(0)})}catch{}}}})}function j(){return(0,f.UU)(g,h,{auth:{persistSession:!1}})}},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},27910:a=>{"use strict";a.exports=require("stream")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},32991:()=>{},44779:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>E,patchFetch:()=>D,routeModule:()=>z,serverHooks:()=>C,workAsyncStorage:()=>A,workUnitAsyncStorage:()=>B});var d={};c.r(d),c.d(d,{POST:()=>y,runtime:()=>x});var e=c(57800),f=c(82669),g=c(34684),h=c(50638),i=c(81492),j=c(261),k=c(69954),l=c(21504),m=c(73632),n=c(43699),o=c(2477),p=c(84287),q=c(97345),r=c(50886),s=c(86439),t=c(84300),u=c(48673),v=c(15352),w=c(47550);let x="nodejs";async function y(a){await (0,w.oC)();let{caseId:b,fileName:c}=await a.json().catch(()=>({}));if(!b||!c)return u.NextResponse.json({error:"Par\xe1metros inv\xe1lidos"},{status:400});if(!await (0,w.Nf)(b))return u.NextResponse.json({error:"Sin permisos"},{status:403});let d=await (0,v.r)(),e=`cases/${b}/${c}`,{data:f,error:g}=await d.storage.from("documents").createSignedUploadUrl(e,{upsert:!1});return g||!f?u.NextResponse.json({error:"No se pudo generar la firma"},{status:500}):u.NextResponse.json({success:!0,path:e,signedUrl:f.signedUrl,token:f.token})}let z=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/uploads/policy/route",pathname:"/api/uploads/policy",filename:"route",bundlePath:"app/api/uploads/policy/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/hh/Downloads/lexchile/src/app/api/uploads/policy/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:A,workUnitAsyncStorage:B,serverHooks:C}=z;function D(){return(0,g.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:B})}async function E(a,b,c){var d;let e="/api/uploads/policy/route";"/index"===e&&(e="/");let g=await z.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:A,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(y.dynamicRoutes[E]||y.routes[D]);if(F&&!x){let a=!!y.routes[D],b=y.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||z.isDev||x||(G="/index"===(G=D)?"/":G);let H=!0===z.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>z.onRequestError(a,b,d,A)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>z.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&B&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await z.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})},A),b}},l=await z.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",B?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await z.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47550:(a,b,c)=>{"use strict";c.d(b,{Nf:()=>i,Rk:()=>g,oC:()=>h});var d=c(15352);let e={admin:"admin_firma",admin_firma:"admin_firma",adminfirma:"admin_firma","admin-firma":"admin_firma",adminlex:"admin_firma",firma_admin:"admin_firma",abogado:"abogado",analista:"analista",cliente:"cliente"};async function f(){let a=await (0,d.R)(),{data:b,error:c}=await a.auth.getUser();if(c||!b?.user)return console.warn("[AUTH] No hay usuario autenticado:",c),null;let f=b.user,g=f.id,h=function(a){let b=[],c=a.app_metadata??{},d=a.user_metadata??{};for(let a of(b.push(c.role,c.roles?.[0],c.user_role),b.push(d.role,d.roles?.[0],d.user_role),b.push(d.perfil_rol,d.profile_role,d.tipo,d.rol),(!0===c.claims_admin||!0===d.is_admin)&&b.push("admin_firma"),b)){let b=function a(b){if(null==b)return null;if(Array.isArray(b))return b.length?a(b[0]):null;if("boolean"==typeof b)return b?"admin_firma":null;let c=String(b).trim();return c?e[c.toLowerCase().replace(/[\s-]+/g,"_")]??null:null}(a);if(b)return b}return null}(f),{data:i,error:j}=await a.from("profiles").select("*").eq("id",g).maybeSingle();if(j)return console.error("[AUTH] Error seleccionando profiles por id:",j),null;if(i){let b=f.email??i.email??"";if(b&&b!==i.email){let{error:c}=await a.from("profiles").update({email:b}).eq("id",g);c&&console.warn("[AUTH] No se pudo sincronizar email en profiles:",c)}let c=f.user_metadata?.nombre??f.user_metadata?.name??null;if(c&&c!==i.nombre){let{error:b}=await a.from("profiles").update({nombre:String(c)}).eq("id",g);if(b)console.warn("[AUTH] No se pudo sincronizar nombre en profiles:",b);else{let{data:b}=await a.from("profiles").select("*").eq("id",g).maybeSingle();if(b){let a=h&&h!==b.role?h:null;return{...b,_role_override:a}}let c=h&&h!==i.role?h:null;return{...i,_role_override:c}}}if(h&&h!==i.role){let{data:b,error:c}=await a.from("profiles").update({role:h}).eq("id",g).select("*").maybeSingle();return c?(console.warn("[AUTH] No se pudo sincronizar rol en profiles:",c),{...i,_role_override:h??null}):b?{...b,_role_override:null}:(console.warn("[AUTH] Actualizaci\xf3n de rol no devolvi\xf3 datos, usando override local"),{...i,_role_override:h??null})}let d=h&&h!==i.role?h:null;return{...i,_role_override:d}}let k=f.user_metadata?.nombre??f.user_metadata?.name??(f.email??"").split("@")[0]??"Usuario",l={id:g,user_id:g,email:f.email??"",nombre:String(k),role:h??"cliente",activo:!0},{data:m,error:n}=await a.from("profiles").insert(l).select("*").maybeSingle();if(n)return console.error("[AUTH] Error creando perfil por primera vez:",n),null;if(console.info("[AUTH] Perfil creado autom\xe1ticamente:",{id:m?.id,email:m?.email,role:m?.role,metadataRole:h}),!m)return null;let o=h&&h!==m.role?h:null;return{...m,_role_override:o}}async function g(){let a=await f();if(!a)return null;let b=a._role_override,c=b??a.role??"cliente"??"cliente";return console.warn("[ROLE DEBUG] getCurrentProfile()",{auth_id:a.id,table_user_id:a.user_id,email:a.email,role_db:a.role,role_override:b,role_effective:c}),{...a,role:c}}async function h(a){let b=await g();if(!b)throw Error("No autenticado");let c=b.role;if(!a)return{...b,role:c};if(!(Array.isArray(a)?a:[a]).includes(c))throw Error("Sin permisos");return{...b,role:c}}async function i(a){return!0}},55591:a=>{"use strict";a.exports=require("https")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:a=>{"use strict";a.exports=require("zlib")},79551:a=>{"use strict";a.exports=require("url")},81630:a=>{"use strict";a.exports=require("http")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},93239:()=>{}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[858,106,626,444],()=>b(b.s=44779));module.exports=c})();