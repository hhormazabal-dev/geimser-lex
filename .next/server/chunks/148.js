"use strict";exports.id=148,exports.ids=[148],exports.modules={5842:(a,b,c)=>{c.d(b,{_:()=>w});var d=c(59356),e=c(56389),f=c(38388),g=c(8618),h=c(88275),i=c(9256),j=c(30724);let k=(0,j.createServerReference)("40c65ac279e16daf07c1a74f8b3ab765a3040f1ce2",j.callServer,void 0,j.findSourceMapURL,"getNotes"),l=(0,j.createServerReference)("4012b70a5d87f841ea19b6c7403670ab3f6f53982d",j.callServer,void 0,j.findSourceMapURL,"createNote"),m=(0,j.createServerReference)("60e9b52677848e6ec117b36775fbbc96c53c2d4b8b",j.callServer,void 0,j.findSourceMapURL,"updateNote"),n=(0,j.createServerReference)("40bcd3afb7420703f0e38188f3b26c056f4dd76913",j.callServer,void 0,j.findSourceMapURL,"deleteNote");var o=c(16815),p=c(49798),q=c(69984),r=c(82118),s=c(72895),t=c(91775),u=c(28482),v=c(44878);function w({caseId:a,canCreateNotes:b=!1,canEditNotes:c=!1,showPrivateNotes:j=!0}){let[o,u]=(0,e.useState)([]),[v,w]=(0,e.useState)(!0),[y,z]=(0,e.useState)(!1),[A,B]=(0,e.useState)(null),[C,D]=(0,e.useState)({tipo:"privada",contenido:""}),{toast:E}=(0,i.dj)(),F=async()=>{w(!0);try{let b=await k({case_id:a,page:1,limit:50});b.success?u(b.notes):E({title:"Error",description:b.error||"Error al cargar notas",variant:"destructive"})}catch(a){console.error("Error loading notes:",a),E({title:"Error",description:"Error inesperado al cargar notas",variant:"destructive"})}finally{w(!1)}},G=async()=>{if(!C.contenido.trim())return void E({title:"Error",description:"El contenido de la nota es requerido",variant:"destructive"});z(!0);try{let b={case_id:a,tipo:C.tipo,contenido:C.contenido.trim()},c=await l(b);c.success?(E({title:"Nota creada",description:"La nota ha sido creada exitosamente"}),D({tipo:"privada",contenido:""}),await F()):E({title:"Error",description:c.error||"Error al crear la nota",variant:"destructive"})}catch(a){console.error("Error creating note:",a),E({title:"Error",description:"Error inesperado al crear la nota",variant:"destructive"})}finally{z(!1)}},H=async(a,b)=>{try{let c=await m(a,{contenido:b.trim()});c.success?(E({title:"Nota actualizada",description:"La nota ha sido actualizada exitosamente"}),B(null),await F()):E({title:"Error",description:c.error||"Error al actualizar la nota",variant:"destructive"})}catch(a){console.error("Error updating note:",a),E({title:"Error",description:"Error inesperado al actualizar la nota",variant:"destructive"})}},I=async a=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar esta nota?"))try{let b=await n(a);b.success?(E({title:"Nota eliminada",description:"La nota ha sido eliminada exitosamente"}),await F()):E({title:"Error",description:b.error||"Error al eliminar la nota",variant:"destructive"})}catch(a){console.error("Error deleting note:",a),E({title:"Error",description:"Error inesperado al eliminar la nota",variant:"destructive"})}},J=a=>"publica"===a?(0,d.jsx)(p.A,{className:"h-4 w-4 text-blue-600"}):(0,d.jsx)(q.A,{className:"h-4 w-4 text-gray-600"}),K=a=>"publica"===a?(0,d.jsx)(h.E,{variant:"default",children:"P\xfablica"}):(0,d.jsx)(h.E,{variant:"secondary",children:"Privada"}),L=j?o:o.filter(a=>"publica"===a.tipo);return v?(0,d.jsxs)(g.Zp,{children:[(0,d.jsx)(g.aR,{children:(0,d.jsxs)(g.ZB,{className:"flex items-center gap-2",children:[(0,d.jsx)(r.A,{className:"h-5 w-5"}),"Notas"]})}),(0,d.jsx)(g.Wu,{children:(0,d.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,d.jsx)(s.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,d.jsxs)(g.Zp,{children:[(0,d.jsx)(g.aR,{children:(0,d.jsxs)("div",{className:"flex items-center justify-between",children:[(0,d.jsxs)(g.ZB,{className:"flex items-center gap-2",children:[(0,d.jsx)(r.A,{className:"h-5 w-5"}),"Notas (",L.length,")"]}),b&&(0,d.jsxs)(f.$,{size:"sm",onClick:()=>z(!y),disabled:y,children:[(0,d.jsx)(t.A,{className:"h-4 w-4 mr-2"}),"Nueva Nota"]})]})}),(0,d.jsxs)(g.Wu,{className:"space-y-4",children:[y&&b&&(0,d.jsx)(g.Zp,{className:"border-dashed",children:(0,d.jsx)(g.Wu,{className:"pt-6",children:(0,d.jsxs)("div",{className:"space-y-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Tipo de nota"}),(0,d.jsxs)("select",{value:C.tipo,onChange:a=>D({...C,tipo:a.target.value}),className:"form-input",children:[(0,d.jsx)("option",{value:"privada",children:"Privada (solo abogados)"}),(0,d.jsx)("option",{value:"publica",children:"P\xfablica (visible para cliente)"})]})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Contenido"}),(0,d.jsx)("textarea",{value:C.contenido,onChange:a=>D({...C,contenido:a.target.value}),placeholder:"Escribe tu nota aqu\xed...",rows:4,className:"form-input"})]}),(0,d.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,d.jsx)(f.$,{variant:"outline",onClick:()=>{z(!1),D({tipo:"privada",contenido:""})},children:"Cancelar"}),(0,d.jsx)(f.$,{onClick:G,children:"Crear Nota"})]})]})})}),(0,d.jsx)("div",{className:"space-y-3",children:L.map(a=>(0,d.jsx)(x,{note:a,canEdit:c,isEditing:A===a.id,onEdit:()=>B(a.id),onCancelEdit:()=>B(null),onSave:b=>H(a.id,b),onDelete:()=>I(a.id),getTypeIcon:J,getTypeBadge:K},a.id))}),0===L.length&&(0,d.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,d.jsx)(r.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,d.jsx)("p",{children:"No hay notas para este caso"}),b&&(0,d.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Nueva Nota" para agregar la primera nota'})]})]})]})}function x({note:a,canEdit:b,isEditing:c,onEdit:h,onCancelEdit:i,onSave:j,onDelete:k,getTypeIcon:l,getTypeBadge:m}){let[n,p]=(0,e.useState)(a.contenido);return(0,d.jsx)(g.Zp,{className:"border-l-4 border-l-blue-500",children:(0,d.jsxs)(g.Wu,{className:"pt-4",children:[(0,d.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[l(a.tipo),m(a.tipo),(0,d.jsxs)("span",{className:"text-sm text-gray-500",children:["por ",a.author?.nombre||"Usuario"]}),(0,d.jsx)("span",{className:"text-sm text-gray-400",children:(0,o.fw)(a.created_at)})]}),b&&(0,d.jsx)("div",{className:"flex items-center gap-1",children:c?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(f.$,{variant:"ghost",size:"sm",onClick:i,children:"Cancelar"}),(0,d.jsx)(f.$,{size:"sm",onClick:()=>{n.trim()&&j(n)},children:"Guardar"})]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(f.$,{variant:"ghost",size:"sm",onClick:h,children:(0,d.jsx)(u.A,{className:"h-4 w-4"})}),(0,d.jsx)(f.$,{variant:"ghost",size:"sm",onClick:k,children:(0,d.jsx)(v.A,{className:"h-4 w-4"})})]})})]}),c?(0,d.jsx)("textarea",{value:n,onChange:a=>p(a.target.value),rows:4,className:"form-input w-full"}):(0,d.jsx)("div",{className:"prose prose-sm max-w-none",children:(0,d.jsx)("p",{className:"whitespace-pre-wrap text-gray-700",children:a.contenido})})]})})}},9562:(a,b,c)=>{c.d(b,{p4:()=>m,Iy:()=>o,jU:()=>q,CS:()=>p,w3:()=>n});var d=c(61776);c(70958);var e=c(46221),f=c(83273),g=c(60619),h=c(56931),i=c(73771);let j=i.Ik({case_id:i.Yj().uuid("ID de caso inv\xe1lido"),tipo:i.k5(["privada","publica"]).default("privada"),contenido:i.Yj().min(1,"El contenido es requerido").max(1e4,"El contenido no puede exceder 10,000 caracteres")}),k=i.Ik({tipo:i.k5(["privada","publica"]).optional(),contenido:i.Yj().min(1,"El contenido es requerido").max(1e4,"El contenido no puede exceder 10,000 caracteres").optional()}),l=i.Ik({case_id:i.Yj().uuid().optional(),tipo:i.k5(["privada","publica"]).optional(),author_id:i.Yj().uuid().optional(),search:i.Yj().optional(),page:i.ai().min(1).default(1),limit:i.ai().min(1).max(100).default(20)});async function m(a){try{let b=await (0,g.oC)(),c=j.parse(a);if(!await (0,g.Nf)(c.case_id))throw Error("Sin permisos para acceder a este caso");if("cliente"===b.role)throw Error("Sin permisos para crear notas");let d=await (0,f.R)(),i={...c,author_id:b.id},{data:k,error:l}=await d.from("notes").insert(i).select(`
        *,
        author:profiles(nombre),
        case:cases(caratulado)
      `).single();if(l)throw console.error("Error creating note:",l),Error("Error al crear la nota");return await (0,h.UU)({action:"CREATE",entity_type:"note",entity_id:k.id,diff_json:{created:i}}),c.tipo,(0,e.revalidatePath)(`/cases/${c.case_id}`),{success:!0,note:k}}catch(a){return console.error("Error in createNote:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function n(a,b){try{let c=await (0,g.oC)(),d=k.parse(b),i=await (0,f.R)(),{data:j,error:l}=await i.from("notes").select("*, case:cases(id)").eq("id",a).single();if(l||!j)throw Error("Nota no encontrada");if("admin_firma"!==c.role&&j.author_id!==c.id)throw Error("Sin permisos para editar esta nota");if(!await (0,g.Nf)(j.case_id))throw Error("Sin permisos para acceder a este caso");let m={};void 0!==d.contenido&&(m.contenido=d.contenido),void 0!==d.tipo&&(m.tipo=d.tipo);let{data:n,error:o}=await i.from("notes").update(m).eq("id",a).select(`
        *,
        author:profiles(nombre),
        case:cases(caratulado)
      `).single();if(o)throw console.error("Error updating note:",o),Error("Error al actualizar la nota");return await (0,h.UU)({action:"UPDATE",entity_type:"note",entity_id:a,diff_json:{from:j,to:n}}),(0,e.revalidatePath)(`/cases/${j.case_id}`),{success:!0,note:n}}catch(a){return console.error("Error in updateNote:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function o(a){try{let b=await (0,g.oC)(),c=await (0,f.R)(),{data:d,error:i}=await c.from("notes").select("*").eq("id",a).single();if(i||!d)throw Error("Nota no encontrada");if("admin_firma"!==b.role&&d.author_id!==b.id)throw Error("Sin permisos para eliminar esta nota");if(!await (0,g.Nf)(d.case_id))throw Error("Sin permisos para acceder a este caso");let{error:j}=await c.from("notes").delete().eq("id",a);if(j)throw console.error("Error deleting note:",j),Error("Error al eliminar la nota");return await (0,h.UU)({action:"DELETE",entity_type:"note",entity_id:a,diff_json:{deleted:d}}),(0,e.revalidatePath)(`/cases/${d.case_id}`),{success:!0}}catch(a){return console.error("Error in deleteNote:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function p(a){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c={page:1,limit:20,...a??{}},d=l.parse(c),e=await (0,f.R)(),h=e.from("notes").select(`
        *,
        author:profiles(id, nombre),
        case:cases(id, caratulado)
      `,{count:"exact"});if("cliente"===b.role){h=h.eq("tipo","publica");let{data:a}=await e.from("case_clients").select("case_id").eq("client_profile_id",b.id),c=a?.map(a=>a.case_id)||[];if(0===c.length)return{success:!0,notes:[],total:0,page:d.page,limit:d.limit};h=h.in("case_id",c)}else if("abogado"===b.role){let{data:a}=await e.from("cases").select("id").eq("abogado_responsable",b.id),c=a?.map(a=>a.id)||[];if(0===c.length)return{success:!0,notes:[],total:0,page:d.page,limit:d.limit};h=h.in("case_id",c)}if(d.case_id){if(!await (0,g.Nf)(d.case_id))throw Error("Sin permisos para acceder a este caso");h=h.eq("case_id",d.case_id)}d.tipo&&(h=h.eq("tipo",d.tipo)),d.author_id&&(h=h.eq("author_id",d.author_id)),d.search&&(h=h.ilike("contenido",`%${d.search}%`));let i=(d.page-1)*d.limit,j=i+d.limit-1,{data:k,error:m,count:n}=await h.range(i,j).order("created_at",{ascending:!1});if(m)throw console.error("Error fetching notes:",m),Error("Error al obtener notas");return{success:!0,notes:k||[],total:n||0,page:d.page,limit:d.limit}}catch(a){return console.error("Error in getNotes:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido",notes:[],total:0}}}async function q(a){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c=await (0,f.R)(),{data:d,error:e}=await c.from("notes").select(`
        *,
        author:profiles(id, nombre),
        case:cases(id, caratulado)
      `).eq("id",a).single();if(e||!d)throw Error("Nota no encontrada");if(!await (0,g.Nf)(d.case_id)||"cliente"===b.role&&"privada"===d.tipo)throw Error("Sin permisos para ver esta nota");return{success:!0,note:d}}catch(a){return console.error("Error in getNoteById:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}(0,c(92714).D)([m,n,o,p,q]),(0,d.A)(m,"4012b70a5d87f841ea19b6c7403670ab3f6f53982d",null),(0,d.A)(n,"60e9b52677848e6ec117b36775fbbc96c53c2d4b8b",null),(0,d.A)(o,"40bcd3afb7420703f0e38188f3b26c056f4dd76913",null),(0,d.A)(p,"40c65ac279e16daf07c1a74f8b3ab765a3040f1ce2",null),(0,d.A)(q,"4046c55dd48dfc05591bece3f47d7e8b618bb30357",null)},14506:(a,b,c)=>{c.d(b,{$:()=>B});var d=c(59356),e=c(56389),f=c(38388),g=c(8618),h=c(88275),i=c(9256),j=c(30724);let k=(0,j.createServerReference)("4068b2aad6bb5abca1df8e575b8900239c3f91e123",j.callServer,void 0,j.findSourceMapURL,"getDocuments");var l=c(83527);let m=(0,j.createServerReference)("60a05bb0cd24233599cf9f92c53da27432d198f23b",j.callServer,void 0,j.findSourceMapURL,"updateDocument"),n=(0,j.createServerReference)("40a5ed4d1a022e18d6d1f8ccc8da589a299ef3c127",j.callServer,void 0,j.findSourceMapURL,"deleteDocument"),o=(0,j.createServerReference)("404011b5219b751b45cbe3934d0daa074a2cfba13f",j.callServer,void 0,j.findSourceMapURL,"getDocumentDownloadUrl");var p=c(16815),q=c(5358),r=c(18230),s=c(18137),t=c(72895),u=c(91775),v=c(32877),w=c(80207),x=c(28482),y=c(44878),z=c(82968);z.Ik({case_id:z.Yj().uuid("ID de caso inv\xe1lido"),nombre:z.Yj().min(1,"El nombre del archivo es requerido").max(255,"El nombre no puede exceder 255 caracteres"),visibilidad:z.k5(["privado","cliente"]).default("privado"),file:z.bz().optional()}),z.Ik({nombre:z.Yj().min(1,"El nombre del archivo es requerido").max(255,"El nombre no puede exceder 255 caracteres").optional(),visibilidad:z.k5(["privado","cliente"]).optional()}),z.Ik({case_id:z.Yj().uuid().optional(),visibilidad:z.k5(["privado","cliente"]).optional(),uploader_id:z.Yj().uuid().optional(),tipo_mime:z.Yj().optional(),search:z.Yj().optional(),page:z.ai().min(1).default(1),limit:z.ai().min(1).max(100).default(20)}),z.Ik({maxFileSize:z.ai().default(0x1400000),allowedTypes:z.YO(z.Yj()).default(["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","image/jpeg","image/png","image/gif","text/plain"])});let A={"application/pdf":{extension:"pdf",icon:"\uD83D\uDCC4",name:"PDF"},"application/msword":{extension:"doc",icon:"\uD83D\uDCDD",name:"Word"},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{extension:"docx",icon:"\uD83D\uDCDD",name:"Word"},"image/jpeg":{extension:"jpg",icon:"\uD83D\uDDBC️",name:"Imagen"},"image/png":{extension:"png",icon:"\uD83D\uDDBC️",name:"Imagen"},"image/gif":{extension:"gif",icon:"\uD83D\uDDBC️",name:"Imagen"},"text/plain":{extension:"txt",icon:"\uD83D\uDCC4",name:"Texto"}};function B({caseId:a,canUpload:b=!1,canEdit:c=!1,canDelete:j=!1,showPrivateDocuments:p=!0}){let[w,x]=(0,e.useState)([]),[y,z]=(0,e.useState)(!0),[B,D]=(0,e.useState)(!1),[E,F]=(0,e.useState)(null),[G,H]=(0,e.useState)(!1),I=(0,e.useRef)(null),{toast:J}=(0,i.dj)(),K=async()=>{z(!0);try{let b=await k({case_id:a,page:1,limit:50});b.success?x(b.documents):J({title:"Error",description:b.error||"Error al cargar documentos",variant:"destructive"})}catch(a){console.error("Error loading documents:",a),J({title:"Error",description:"Error inesperado al cargar documentos",variant:"destructive"})}finally{z(!1)}},L=async b=>{let c=b.target.files?.[0];if(c){if(c.size>0x1400000)return void J({title:"Archivo demasiado grande",description:"El archivo debe ser menor a 20MB",variant:"destructive"});if(!Object.keys(A).includes(c.type))return void J({title:"Tipo de archivo no permitido",description:"Solo se permiten archivos PDF, Word, im\xe1genes y texto",variant:"destructive"});D(!0);try{let b=new FormData;b.append("file",c),b.append("case_id",a),b.append("nombre",c.name),b.append("visibilidad","privado");let d=await (0,l.X)(b);d.success?(J({title:"Documento subido",description:"El documento ha sido subido exitosamente"}),H(!1),await K()):J({title:"Error",description:d.error||"Error al subir el documento",variant:"destructive"})}catch(a){console.error("Error uploading document:",a),J({title:"Error",description:"Error inesperado al subir el documento",variant:"destructive"})}finally{D(!1),I.current&&(I.current.value="")}}},M=async(a,b)=>{try{let c=await m(a,b);c.success?(J({title:"Documento actualizado",description:"El documento ha sido actualizado exitosamente"}),F(null),await K()):J({title:"Error",description:c.error||"Error al actualizar el documento",variant:"destructive"})}catch(a){console.error("Error updating document:",a),J({title:"Error",description:"Error inesperado al actualizar el documento",variant:"destructive"})}},N=async a=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar este documento?"))try{let b=await n(a);b.success?(J({title:"Documento eliminado",description:"El documento ha sido eliminado exitosamente"}),await K()):J({title:"Error",description:b.error||"Error al eliminar el documento",variant:"destructive"})}catch(a){console.error("Error deleting document:",a),J({title:"Error",description:"Error inesperado al eliminar el documento",variant:"destructive"})}},O=async(a,b)=>{try{let c=await o(a);if(c.success&&c.url){let a=document.createElement("a");a.href=c.url,a.download=b,document.body.appendChild(a),a.click(),document.body.removeChild(a),J({title:"Descarga iniciada",description:"El documento se est\xe1 descargando"})}else J({title:"Error",description:c.error||"Error al generar enlace de descarga",variant:"destructive"})}catch(a){console.error("Error downloading document:",a),J({title:"Error",description:"Error inesperado al descargar el documento",variant:"destructive"})}},P=a=>{let b=A[a];return b?b.icon:"\uD83D\uDCC4"},Q=a=>"cliente"===a?(0,d.jsx)(q.A,{className:"h-4 w-4 text-blue-600"}):(0,d.jsx)(r.A,{className:"h-4 w-4 text-gray-600"}),R=a=>"cliente"===a?(0,d.jsx)(h.E,{variant:"default",children:"Cliente"}):(0,d.jsx)(h.E,{variant:"secondary",children:"Privado"}),S=p?w:w.filter(a=>"cliente"===a.visibilidad);return y?(0,d.jsxs)(g.Zp,{children:[(0,d.jsx)(g.aR,{children:(0,d.jsxs)(g.ZB,{className:"flex items-center gap-2",children:[(0,d.jsx)(s.A,{className:"h-5 w-5"}),"Documentos"]})}),(0,d.jsx)(g.Wu,{children:(0,d.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,d.jsx)(t.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,d.jsxs)(g.Zp,{children:[(0,d.jsx)(g.aR,{children:(0,d.jsxs)("div",{className:"flex items-center justify-between",children:[(0,d.jsxs)(g.ZB,{className:"flex items-center gap-2",children:[(0,d.jsx)(s.A,{className:"h-5 w-5"}),"Documentos (",S.length,")"]}),b&&(0,d.jsxs)(f.$,{size:"sm",onClick:()=>H(!G),disabled:B,children:[(0,d.jsx)(u.A,{className:"h-4 w-4 mr-2"}),"Subir Documento"]})]})}),(0,d.jsxs)(g.Wu,{className:"space-y-4",children:[G&&b&&(0,d.jsx)(g.Zp,{className:"border-dashed",children:(0,d.jsx)(g.Wu,{className:"pt-6",children:(0,d.jsxs)("div",{className:"space-y-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Seleccionar archivo"}),(0,d.jsx)("input",{ref:I,type:"file",onChange:L,accept:Object.keys(A).join(","),className:"form-input",disabled:B}),(0,d.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["M\xe1ximo ",20,"MB. Formatos: PDF, Word, im\xe1genes, texto"]})]}),B&&(0,d.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[(0,d.jsx)(t.A,{className:"h-4 w-4 animate-spin"}),"Subiendo archivo..."]}),(0,d.jsx)("div",{className:"flex justify-end space-x-2",children:(0,d.jsx)(f.$,{variant:"outline",onClick:()=>H(!1),disabled:B,children:"Cancelar"})})]})})}),(0,d.jsx)("div",{className:"space-y-3",children:S.map(a=>(0,d.jsx)(C,{document:a,canEdit:c,canDelete:j,isEditing:E===a.id,onEdit:()=>F(a.id),onCancelEdit:()=>F(null),onSave:b=>M(a.id,b),onDelete:()=>N(a.id),onDownload:()=>O(a.id,a.nombre),getFileIcon:P,getVisibilityIcon:Q,getVisibilityBadge:R},a.id))}),0===S.length&&(0,d.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,d.jsx)(v.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,d.jsx)("p",{children:"No hay documentos para este caso"}),b&&(0,d.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Subir Documento" para agregar el primer documento'})]})]})]})}function C({document:a,canEdit:b,canDelete:c,isEditing:h,onEdit:i,onCancelEdit:j,onSave:k,onDelete:l,onDownload:m,getFileIcon:n,getVisibilityIcon:o,getVisibilityBadge:q}){let[r,s]=(0,e.useState)({nombre:a.nombre,visibilidad:a.visibilidad});return(0,d.jsx)(g.Zp,{className:"border-l-4 border-l-green-500",children:(0,d.jsx)(g.Wu,{className:"pt-4",children:(0,d.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,d.jsxs)("div",{className:"flex items-center gap-3",children:[(0,d.jsx)("span",{className:"text-2xl",children:n(a.tipo_mime||"")}),(0,d.jsxs)("div",{children:[h?(0,d.jsx)("input",{type:"text",value:r.nombre,onChange:a=>s({...r,nombre:a.target.value}),className:"form-input text-sm"}):(0,d.jsx)("h4",{className:"font-medium text-gray-900",children:a.nombre}),(0,d.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[o(a.visibilidad||"privado"),h?(0,d.jsxs)("select",{value:r.visibilidad,onChange:a=>s({...r,visibilidad:a.target.value}),className:"form-input text-xs",children:[(0,d.jsx)("option",{value:"privado",children:"Privado"}),(0,d.jsx)("option",{value:"cliente",children:"Cliente"})]}):q(a.visibilidad||"privado"),(0,d.jsx)("span",{className:"text-xs text-gray-500",children:(0,p.v7)(a.size_bytes||0)})]}),(0,d.jsxs)("div",{className:"text-xs text-gray-400 mt-1",children:["Subido por ",a.uploader?.nombre||"Usuario"," • ",(0,p.fw)(a.created_at)]})]})]}),(0,d.jsxs)("div",{className:"flex items-center gap-1",children:[(0,d.jsx)(f.$,{variant:"ghost",size:"sm",onClick:m,children:(0,d.jsx)(w.A,{className:"h-4 w-4"})}),b&&(0,d.jsx)(d.Fragment,{children:h?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(f.$,{variant:"ghost",size:"sm",onClick:j,children:"Cancelar"}),(0,d.jsx)(f.$,{size:"sm",onClick:()=>{r.nombre.trim()&&k(r)},children:"Guardar"})]}):(0,d.jsx)(f.$,{variant:"ghost",size:"sm",onClick:i,children:(0,d.jsx)(x.A,{className:"h-4 w-4"})})}),c&&!h&&(0,d.jsx)(f.$,{variant:"ghost",size:"sm",onClick:l,children:(0,d.jsx)(y.A,{className:"h-4 w-4"})})]})]})})})}},17704:(a,b,c)=>{c.d(b,{L:()=>E});var d=c(59356),e=c(56389),f=c(38388),g=c(8618),h=c(88275),i=c(9256),j=c(30724);let k=(0,j.createServerReference)("409b0a64c97bfe61b6e8814829fd1beb5b3c0ce84b",j.callServer,void 0,j.findSourceMapURL,"getInfoRequests"),l=(0,j.createServerReference)("40590b8aeb9cfa434beea52a3b54560f16fb3251f6",j.callServer,void 0,j.findSourceMapURL,"createInfoRequest"),m=(0,j.createServerReference)("606404fa1c57a53adafcdadd0b4189028f4b743e65",j.callServer,void 0,j.findSourceMapURL,"respondInfoRequest"),n=(0,j.createServerReference)("40b3ae676bee74d4c392577de287d9a07360d67bdc",j.callServer,void 0,j.findSourceMapURL,"closeInfoRequest");var o=c(16815),p=c(20048),q=c(88237),r=c(9239),s=c(39309),t=c(72895),u=c(91775),v=c(87114),w=c(45324),x=c(58637),y=c(84963),z=c(6997),A=c(82968);A.Ik({case_id:A.Yj().uuid("ID de caso inv\xe1lido"),titulo:A.Yj().min(1,"El t\xedtulo es requerido").max(1e3,"El t\xedtulo no puede exceder 1000 caracteres"),descripcion:A.Yj().min(1,"La descripci\xf3n es requerida").max(2e3,"La descripci\xf3n no puede exceder 2000 caracteres"),tipo:A.k5(["documento","informacion","reunion","otro"]).default("informacion"),prioridad:A.k5(["baja","media","alta","urgente"]).default("media"),fecha_limite:A.Yj().optional(),es_publica:A.zM().default(!0)}).partial().omit({case_id:!0}),A.Ik({respuesta:A.Yj().min(1,"La respuesta es requerida").max(2e3,"La respuesta no puede exceder 2000 caracteres"),archivo_adjunto:A.Yj().optional()}),A.Ik({case_id:A.Yj().uuid().optional(),estado:A.k5(["pendiente","en_revision","respondida","cerrada"]).optional(),tipo:A.k5(["documento","informacion","reunion","otro"]).optional(),prioridad:A.k5(["baja","media","alta","urgente"]).optional(),creador_id:A.Yj().uuid().optional(),es_publica:A.zM().optional(),fecha_desde:A.Yj().optional(),fecha_hasta:A.Yj().optional(),search:A.Yj().optional(),page:A.ai().min(1).default(1),limit:A.ai().min(1).max(100).default(20)});let B=[{value:"documento",label:"Documento",description:"Solicitud de documentos espec\xedficos"},{value:"informacion",label:"Informaci\xf3n",description:"Solicitud de informaci\xf3n general"},{value:"reunion",label:"Reuni\xf3n",description:"Solicitud de reuni\xf3n o cita"},{value:"otro",label:"Otro",description:"Otro tipo de solicitud"}],C=[{value:"pendiente",label:"Pendiente",color:"yellow"},{value:"en_revision",label:"En Revisi\xf3n",color:"blue"},{value:"respondida",label:"Respondida",color:"green"},{value:"cerrada",label:"Cerrada",color:"gray"}],D=[{value:"baja",label:"Baja",color:"gray"},{value:"media",label:"Media",color:"blue"},{value:"alta",label:"Alta",color:"orange"},{value:"urgente",label:"Urgente",color:"red"}];function E({caseId:a,canCreateRequests:b=!1,canRespondRequests:c=!1,showPrivateRequests:h=!0}){let[j,o]=(0,e.useState)([]),[v,w]=(0,e.useState)(!0),[x,y]=(0,e.useState)(!1),[z,A]=(0,e.useState)(null),[E,G]=(0,e.useState)(!1),[H,I]=(0,e.useState)({titulo:"",descripcion:"",tipo:"informacion",prioridad:"media",fecha_limite:"",es_publica:!0}),[J,K]=(0,e.useState)({respuesta:"",archivo_adjunto:""}),{toast:L}=(0,i.dj)(),M=async()=>{w(!0);try{let b=await k({case_id:a,page:1,limit:50});b.success?o(b.requests):L({title:"Error",description:b.error||"Error al cargar solicitudes",variant:"destructive"})}catch(a){console.error("Error loading requests:",a),L({title:"Error",description:"Error inesperado al cargar solicitudes",variant:"destructive"})}finally{w(!1)}},N=async()=>{if(!H.titulo.trim()||!H.descripcion.trim())return void L({title:"Error",description:"El t\xedtulo y la descripci\xf3n son requeridos",variant:"destructive"});y(!0);try{let b={case_id:a,titulo:H.titulo.trim(),descripcion:H.descripcion.trim(),tipo:H.tipo,prioridad:H.prioridad,fecha_limite:H.fecha_limite||void 0,es_publica:H.es_publica},c=await l(b);c.success?(L({title:"Solicitud creada",description:"La solicitud ha sido creada exitosamente"}),I({titulo:"",descripcion:"",tipo:"informacion",prioridad:"media",fecha_limite:"",es_publica:!0}),G(!1),await M()):L({title:"Error",description:c.error||"Error al crear la solicitud",variant:"destructive"})}catch(a){console.error("Error creating request:",a),L({title:"Error",description:"Error inesperado al crear la solicitud",variant:"destructive"})}finally{y(!1)}},O=async a=>{if(!J.respuesta.trim())return void L({title:"Error",description:"La respuesta es requerida",variant:"destructive"});try{let b={respuesta:J.respuesta.trim(),archivo_adjunto:J.archivo_adjunto||void 0},c=await m(a,b);c.success?(L({title:"Respuesta enviada",description:"La respuesta ha sido enviada exitosamente"}),K({respuesta:"",archivo_adjunto:""}),A(null),await M()):L({title:"Error",description:c.error||"Error al enviar la respuesta",variant:"destructive"})}catch(a){console.error("Error responding to request:",a),L({title:"Error",description:"Error inesperado al enviar la respuesta",variant:"destructive"})}},P=async a=>{try{let b=await n(a);b.success?(L({title:"Solicitud cerrada",description:"La solicitud ha sido cerrada"}),await M()):L({title:"Error",description:b.error||"Error al cerrar la solicitud",variant:"destructive"})}catch(a){console.error("Error closing request:",a),L({title:"Error",description:"Error inesperado al cerrar la solicitud",variant:"destructive"})}},Q=a=>{switch(a){case"respondida":return(0,d.jsx)(p.A,{className:"h-5 w-5 text-green-600"});case"en_revision":return(0,d.jsx)(q.A,{className:"h-5 w-5 text-blue-600"});case"cerrada":return(0,d.jsx)(r.A,{className:"h-5 w-5 text-gray-600"});default:return(0,d.jsx)(s.A,{className:"h-5 w-5 text-yellow-600"})}},R=a=>{let b=C.find(b=>b.value===a);return b?(0,d.jsx)("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${{yellow:"bg-yellow-100 text-yellow-800",blue:"bg-blue-100 text-blue-800",green:"bg-green-100 text-green-800",gray:"bg-gray-100 text-gray-800"}[b.color]}`,children:b.label}):null},S=a=>{let b=D.find(b=>b.value===a);return b?(0,d.jsx)("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${{gray:"bg-gray-100 text-gray-800",blue:"bg-blue-100 text-blue-800",orange:"bg-orange-100 text-orange-800",red:"bg-red-100 text-red-800"}[b.color]}`,children:b.label}):null},T=a=>{let b=B.find(b=>b.value===a);return b?b.label:a},U=h?j:j.filter(a=>a.es_publica);return v?(0,d.jsxs)(g.Zp,{children:[(0,d.jsx)(g.aR,{children:(0,d.jsxs)(g.ZB,{className:"flex items-center gap-2",children:[(0,d.jsx)(s.A,{className:"h-5 w-5"}),"Solicitudes de Informaci\xf3n"]})}),(0,d.jsx)(g.Wu,{children:(0,d.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,d.jsx)(t.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,d.jsxs)(g.Zp,{children:[(0,d.jsx)(g.aR,{children:(0,d.jsxs)("div",{className:"flex items-center justify-between",children:[(0,d.jsxs)(g.ZB,{className:"flex items-center gap-2",children:[(0,d.jsx)(s.A,{className:"h-5 w-5"}),"Solicitudes de Informaci\xf3n (",U.length,")"]}),b&&(0,d.jsxs)(f.$,{size:"sm",onClick:()=>G(!E),disabled:x,children:[(0,d.jsx)(u.A,{className:"h-4 w-4 mr-2"}),"Nueva Solicitud"]})]})}),(0,d.jsxs)(g.Wu,{className:"space-y-4",children:[E&&b&&(0,d.jsx)(g.Zp,{className:"border-dashed",children:(0,d.jsx)(g.Wu,{className:"pt-6",children:(0,d.jsxs)("div",{className:"space-y-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"T\xedtulo *"}),(0,d.jsx)("input",{type:"text",value:H.titulo,onChange:a=>I({...H,titulo:a.target.value}),placeholder:"T\xedtulo de la solicitud",className:"form-input"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Descripci\xf3n *"}),(0,d.jsx)("textarea",{value:H.descripcion,onChange:a=>I({...H,descripcion:a.target.value}),placeholder:"Describe detalladamente lo que necesitas...",rows:4,className:"form-input"})]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Tipo"}),(0,d.jsx)("select",{value:H.tipo,onChange:a=>I({...H,tipo:a.target.value}),className:"form-input",children:B.map(a=>(0,d.jsx)("option",{value:a.value,children:a.label},a.value))})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Prioridad"}),(0,d.jsx)("select",{value:H.prioridad,onChange:a=>I({...H,prioridad:a.target.value}),className:"form-input",children:D.map(a=>(0,d.jsx)("option",{value:a.value,children:a.label},a.value))})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Fecha l\xedmite (opcional)"}),(0,d.jsx)("input",{type:"date",value:H.fecha_limite,onChange:a=>I({...H,fecha_limite:a.target.value}),className:"form-input"})]})]}),(0,d.jsx)("div",{children:(0,d.jsxs)("label",{className:"flex items-center gap-2",children:[(0,d.jsx)("input",{type:"checkbox",checked:H.es_publica,onChange:a=>I({...H,es_publica:a.target.checked})}),(0,d.jsx)("span",{className:"text-sm",children:"Visible para el abogado"})]})}),(0,d.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,d.jsx)(f.$,{variant:"outline",onClick:()=>{G(!1),I({titulo:"",descripcion:"",tipo:"informacion",prioridad:"media",fecha_limite:"",es_publica:!0})},disabled:x,children:"Cancelar"}),(0,d.jsx)(f.$,{onClick:N,disabled:x,children:x?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(t.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Creando..."]}):"Crear Solicitud"})]})]})})}),(0,d.jsx)("div",{className:"space-y-3",children:U.map(a=>(0,d.jsx)(F,{request:a,canRespond:c,isResponding:z===a.id,response:J,onStartResponding:()=>A(a.id),onCancelResponding:()=>{A(null),K({respuesta:"",archivo_adjunto:""})},onResponseChange:K,onSendResponse:()=>O(a.id),onClose:()=>P(a.id),getStatusIcon:Q,getStatusBadge:R,getPriorityBadge:S,getTypeIcon:T},a.id))}),0===U.length&&(0,d.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,d.jsx)(s.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,d.jsx)("p",{children:"No hay solicitudes de informaci\xf3n"}),b&&(0,d.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Nueva Solicitud" para crear la primera solicitud'})]})]})]})}function F({request:a,canRespond:b,isResponding:c,response:e,onStartResponding:i,onCancelResponding:j,onResponseChange:k,onSendResponse:l,onClose:m,getStatusIcon:n,getStatusBadge:p,getPriorityBadge:q,getTypeIcon:s}){let t=a.fecha_limite&&(0,o.m7)(a.fecha_limite)&&"respondida"!==a.estado&&"cerrada"!==a.estado;return(0,d.jsx)(g.Zp,{className:`border-l-4 ${t?"border-l-red-500":"border-l-blue-500"}`,children:(0,d.jsxs)(g.Wu,{className:"pt-4",children:[(0,d.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,d.jsxs)("div",{className:"flex items-center gap-3",children:[n(a.estado||"pendiente"),(0,d.jsxs)("div",{children:[(0,d.jsx)("h4",{className:"font-medium text-gray-900",children:a.titulo}),(0,d.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[p(a.estado||"pendiente"),q(a.prioridad||"media"),(0,d.jsx)(h.E,{variant:"outline",children:s(a.tipo||"informacion")}),!a.es_publica&&(0,d.jsx)(h.E,{variant:"outline",children:"Privada"})]})]})]}),t&&(0,d.jsx)(v.A,{className:"h-5 w-5 text-red-500"})]}),(0,d.jsx)("p",{className:"text-sm text-gray-700 mb-3",children:a.descripcion}),(0,d.jsxs)("div",{className:"flex items-center gap-4 text-sm text-gray-500 mb-3",children:[(0,d.jsxs)("div",{className:"flex items-center gap-1",children:[(0,d.jsx)(w.A,{className:"h-4 w-4"}),(0,d.jsx)("span",{children:a.creador?.nombre||"Usuario"})]}),(0,d.jsx)("span",{children:(0,o.fw)(a.created_at)}),a.fecha_limite&&(0,d.jsxs)("div",{className:"flex items-center gap-1",children:[(0,d.jsx)(x.A,{className:"h-4 w-4"}),(0,d.jsxs)("span",{className:t?"text-red-600 font-medium":"",children:["L\xedmite: ",new Date(a.fecha_limite).toLocaleDateString("es-CL")]})]})]}),a.respuesta&&(0,d.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 mb-3",children:[(0,d.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,d.jsx)(y.A,{className:"h-4 w-4 text-blue-600"}),(0,d.jsxs)("span",{className:"text-sm font-medium",children:["Respuesta de ",a.respondido_por_profile?.nombre||"Abogado"]}),(0,d.jsx)("span",{className:"text-xs text-gray-500",children:a.respondido_at&&(0,o.fw)(a.respondido_at)})]}),(0,d.jsx)("p",{className:"text-sm text-gray-700",children:a.respuesta}),a.archivo_adjunto&&(0,d.jsx)("a",{href:a.archivo_adjunto,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:underline mt-2 inline-block",children:"Ver archivo adjunto"})]}),c&&(0,d.jsx)("div",{className:"bg-blue-50 rounded-lg p-3 mb-3",children:(0,d.jsxs)("div",{className:"space-y-3",children:[(0,d.jsx)("textarea",{value:e.respuesta,onChange:a=>k({...e,respuesta:a.target.value}),placeholder:"Escribe tu respuesta...",rows:3,className:"form-input"}),(0,d.jsx)("input",{type:"url",value:e.archivo_adjunto,onChange:a=>k({...e,archivo_adjunto:a.target.value}),placeholder:"URL del archivo adjunto (opcional)",className:"form-input"}),(0,d.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,d.jsx)(f.$,{size:"sm",variant:"outline",onClick:j,children:"Cancelar"}),(0,d.jsxs)(f.$,{size:"sm",onClick:l,children:[(0,d.jsx)(z.A,{className:"h-4 w-4 mr-1"}),"Enviar Respuesta"]})]})]})}),b&&"cerrada"!==a.estado&&(0,d.jsxs)("div",{className:"flex items-center gap-2",children:["respondida"!==a.estado&&!c&&(0,d.jsxs)(f.$,{size:"sm",variant:"outline",onClick:i,children:[(0,d.jsx)(y.A,{className:"h-4 w-4 mr-1"}),"Responder"]}),"respondida"===a.estado&&(0,d.jsxs)(f.$,{size:"sm",variant:"outline",onClick:m,children:[(0,d.jsx)(r.A,{className:"h-4 w-4 mr-1"}),"Cerrar"]})]})]})})}},19529:(a,b,c)=>{c.d(b,{B:()=>q});var d=c(59356),e=c(56389),f=c(30724);let g=(0,f.createServerReference)("40117251fa73708d6ea58a8a7fc4a4d3f84edd2290",f.callServer,void 0,f.findSourceMapURL,"sendCaseMessage"),h=(0,f.createServerReference)("6033992cdb782388fc84bef8a2922fd17c703a695a",f.callServer,void 0,f.findSourceMapURL,"listCaseMessages");var i=c(38388),j=c(98558),k=c(8618),l=c(88275),m=c(16815),n=c(72895),o=c(6997),p=c(9256);function q({caseId:a,initialMessages:b,currentProfileId:c,allowSend:f=!0}){let[q,r]=(0,e.useState)(b),[s,t]=(0,e.useState)(""),[u,v]=(0,e.useTransition)(),[w,x]=(0,e.useState)(!1),{toast:y}=(0,p.dj)(),z=(0,e.useMemo)(()=>q.slice().sort((a,b)=>new Date(a.created_at).getTime()-new Date(b.created_at).getTime()),[q]),A=async()=>{x(!0);try{let b=await h(a,{limit:100});r(b)}catch(a){y({title:"Error al actualizar",description:a?.message??"No fue posible obtener los mensajes.",variant:"destructive"})}finally{x(!1)}};return(0,d.jsxs)("div",{className:"space-y-6",children:[(0,d.jsxs)("div",{className:"flex items-center justify-between",children:[(0,d.jsx)("h3",{className:"text-lg font-semibold text-lexser-gray-900",children:"Mensajes del caso"}),(0,d.jsx)(i.$,{variant:"outline",size:"sm",onClick:A,disabled:w,children:w?(0,d.jsx)(n.A,{className:"h-4 w-4 animate-spin"}):"Actualizar"})]}),(0,d.jsx)("div",{className:"space-y-4",children:0===z.length?(0,d.jsx)("p",{className:"text-sm text-muted-foreground",children:"A\xfan no hay mensajes para este caso."}):z.map(a=>{let b=a.sender_profile_id===c;return(0,d.jsx)(k.Zp,{className:`border ${b?"border-lexser-blue-200 bg-lexser-blue-50":"border-lexser-gray-100"}`,children:(0,d.jsxs)(k.Wu,{className:"p-4 space-y-2",children:[(0,d.jsxs)("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[(0,d.jsxs)("span",{children:[a.sender?.nombre??"Usuario",a.sender?.role&&(0,d.jsx)(l.E,{variant:"outline",className:"ml-2 capitalize text-[10px]",children:a.sender.role})]}),(0,d.jsx)("span",{children:(0,m.r6)(a.created_at)})]}),(0,d.jsx)("p",{className:"text-sm text-lexser-gray-900 whitespace-pre-wrap",children:a.contenido}),a.attachment_url&&(0,d.jsx)("a",{href:a.attachment_url,target:"_blank",rel:"noopener noreferrer",className:"text-xs font-medium text-lexser-blue-600 hover:text-lexser-blue-700",children:"Ver adjunto"})]})},a.id)})}),f&&(0,d.jsxs)("div",{className:"rounded-lg border border-lexser-gray-200 p-4 space-y-3",children:[(0,d.jsx)(j.T,{placeholder:"Escribe un mensaje para tu cliente o equipo...",value:s,onChange:a=>t(a.target.value),disabled:u,className:"min-h-[120px]"}),(0,d.jsx)("div",{className:"flex items-center justify-end",children:(0,d.jsxs)(i.$,{onClick:()=>{if(!s.trim())return void y({title:"Mensaje vac\xedo",description:"Escribe un mensaje antes de enviarlo.",variant:"destructive"});v(async()=>{try{let b=await g({caseId:a,contenido:s.trim()});r(a=>[...a,b]),t("")}catch(a){y({title:"No se pudo enviar",description:a?.message??"Intenta nuevamente en unos minutos.",variant:"destructive"})}})},disabled:u,children:[u?(0,d.jsx)(n.A,{className:"mr-2 h-4 w-4 animate-spin"}):(0,d.jsx)(o.A,{className:"mr-2 h-4 w-4"}),"Enviar"]})})]})]})}},62235:(a,b,c)=>{c.d(b,{S:()=>O});var d=c(59356),e=c(56389),f=c(38388),g=c(8618),h=c(88275),i=c(9256),j=c(30724);let k=(0,j.createServerReference)("407d6cb4ff2bd39dcaf5f15fa9d0e06606b79d5032",j.callServer,void 0,j.findSourceMapURL,"getStages"),l=(0,j.createServerReference)("4085495ff5376de2d9544dda91281e646ae494c949",j.callServer,void 0,j.findSourceMapURL,"createStage"),m=(0,j.createServerReference)("60ca260422e043e8d031aa4e5ec5aa5cec62c69295",j.callServer,void 0,j.findSourceMapURL,"completeStage"),n=(0,j.createServerReference)("400967a73b9add91995e0337cec7f66ae699a36c62",j.callServer,void 0,j.findSourceMapURL,"deleteStage"),o=(0,j.createServerReference)("608da5f884100b9fa525729204e6c90fb38047921a",j.callServer,void 0,j.findSourceMapURL,"updateStage"),p=(0,j.createServerReference)("60d22c0eee3e81479564a5d2c578cd4d8d7527f1eb",j.callServer,void 0,j.findSourceMapURL,"requestCaseAdvance");var q=c(16815),r=c(20048),s=c(88237),t=c(52419),u=c(72895),v=c(91775),w=c(87872),x=c(16559),y=c(58637),z=c(45324),A=c(69719),B=c(65230),C=c(96782),D=c(82998),E=c(55757),F=c(41752),G=c(28482),H=c(44878),I=c(82968);I.Ik({case_id:I.Yj().uuid("ID de caso inv\xe1lido"),etapa:I.Yj().min(1,"El nombre de la etapa es requerido").max(1e3,"El nombre no puede exceder 1000 caracteres"),descripcion:I.Yj().optional(),fecha_programada:I.Yj().optional(),fecha_completada:I.Yj().optional(),estado:I.k5(["pendiente","en_proceso","completado"]).default("pendiente"),es_publica:I.zM().default(!0),orden:I.ai().int().positive("El orden debe ser un n\xfamero positivo"),responsable_id:I.Yj().uuid("ID de responsable inv\xe1lido").optional(),audiencia_tipo:I.k5(["preparatoria","juicio"]).optional(),requiere_testigos:I.zM().default(!1),requiere_pago:I.zM().default(!1),costo_uf:I.ai().min(0,"El costo debe ser positivo").optional(),porcentaje_variable:I.ai().min(0,"El porcentaje debe ser positivo").max(100,"El porcentaje no puede exceder 100").optional(),estado_pago:I.k5(["pendiente","en_proceso","parcial","pagado","vencido"]).default("pendiente"),enlace_pago:I.Yj().url("Debe ser una URL v\xe1lida").optional(),notas_pago:I.Yj().max(1e3,"Las notas no pueden exceder 1000 caracteres").optional(),monto_variable_base:I.Yj().optional(),monto_pagado_uf:I.ai().min(0,"El monto pagado debe ser positivo").optional()}).partial().omit({case_id:!0}),I.Ik({fecha_completada:I.Yj().optional(),observaciones:I.Yj().optional()}),I.Ik({case_id:I.Yj().uuid().optional(),estado:I.k5(["pendiente","en_proceso","completado"]).optional(),responsable_id:I.Yj().uuid().optional(),es_publica:I.zM().optional(),fecha_desde:I.Yj().optional(),fecha_hasta:I.Yj().optional(),page:I.ai().min(1).default(1),limit:I.ai().min(1).max(100).default(20)});let J={Civil:[.15,.1,.1,.1,.15,.2,.1,.05,.05],Comercial:[.2,.15,.15,.2,.15,.1,.05],Laboral:[.2,.2,.2,.2,.1,.1],Familia:[.2,.15,.15,.15,.2,.15]},K={Civil:[{etapa:"Ingreso Demanda",descripcion:"Presentaci\xf3n de la demanda con antecedentes y revisi\xf3n formal del tribunal.",diasEstimados:0},{etapa:"Notificaci\xf3n a la contraparte",descripcion:"Gestiones de notificaci\xf3n personal o por c\xe9dula al demandado.",diasEstimados:30},{etapa:"Contestaci\xf3n de la demanda",descripcion:"Plazo legal para que la contraparte conteste y proponga excepciones.",diasEstimados:20},{etapa:"R\xe9plicas y d\xfaplicas",descripcion:"Intercambio de escritos aclarando puntos controvertidos.",diasEstimados:15},{etapa:"Audiencia preparatoria",descripcion:"Fijaci\xf3n de puntos de prueba y acuerdos probatorios.",diasEstimados:30},{etapa:"Periodo probatorio",descripcion:"Recepci\xf3n de declaraciones, oficios, peritajes y documental.",diasEstimados:45},{etapa:"Alegatos y vista de la causa",descripcion:"Audiencia de cierre donde las partes exponen sus argumentos finales.",diasEstimados:20},{etapa:"Sentencia de primera instancia",descripcion:"Redacci\xf3n y publicaci\xf3n del fallo por el tribunal.",diasEstimados:60},{etapa:"Recursos y cumplimiento",descripcion:"Interposici\xf3n de recursos o cumplimiento voluntario/forzado.",diasEstimados:30}],Comercial:[{etapa:"Ingreso Demanda",descripcion:"Presentaci\xf3n de la demanda y verificaci\xf3n formal.",diasEstimados:0},{etapa:"Notificaci\xf3n demandado",descripcion:"Gesti\xf3n de notificaci\xf3n a la contraparte y acreditaci\xf3n en autos.",diasEstimados:20},{etapa:"Contestaci\xf3n y reconvenci\xf3n",descripcion:"Respuesta del demandado y eventuales reconvenciones.",diasEstimados:20},{etapa:"Audiencia preparatoria",descripcion:"Determinaci\xf3n de hechos a probar y medios de prueba.",diasEstimados:25},{etapa:"Prueba y alegatos",descripcion:"Producci\xf3n de prueba documental, testimonial y alegatos finales.",diasEstimados:40},{etapa:"Sentencia",descripcion:"Decisi\xf3n del tribunal y notificaci\xf3n a las partes.",diasEstimados:45},{etapa:"Ejecuci\xf3n o recursos",descripcion:"Cumplimiento del fallo o tramitaci\xf3n de recursos.",diasEstimados:30}],Laboral:[{etapa:"Ingreso tutela o demanda laboral",descripcion:"Ingreso del escrito y asignaci\xf3n de audiencia preliminar.",diasEstimados:0},{etapa:"Citaciones y notificaci\xf3n empleador",descripcion:"Notificaci\xf3n de la demanda y citaci\xf3n a audiencia preparatoria.",diasEstimados:10},{etapa:"Audiencia preparatoria",descripcion:"Intento de conciliaci\xf3n y fijaci\xf3n de puntos controvertidos.",diasEstimados:15},{etapa:"Audiencia de juicio",descripcion:"Producci\xf3n de prueba y alegatos finales.",diasEstimados:20},{etapa:"Sentencia laboral",descripcion:"Pronunciamiento del tribunal y notificaci\xf3n a las partes.",diasEstimados:15},{etapa:"Cumplimiento / Recurso de nulidad",descripcion:"Tramitaci\xf3n de recursos o ejecuci\xf3n de la sentencia.",diasEstimados:20}],Familia:[{etapa:"Ingreso demanda o escrito inicial",descripcion:"Ingreso de medida de protecci\xf3n o demanda ante tribunal de familia.",diasEstimados:0},{etapa:"Notificaci\xf3n y citaci\xf3n a audiencia",descripcion:"Notificaci\xf3n a la contraparte y citaci\xf3n a audiencia preparatoria.",diasEstimados:10},{etapa:"Audiencia preparatoria",descripcion:"Determinaci\xf3n de puntos controvertidos y acumulaci\xf3n de prueba.",diasEstimados:15},{etapa:"Audiencia de juicio",descripcion:"Presentaci\xf3n de prueba, declaraciones y alegatos.",diasEstimados:20},{etapa:"Sentencia",descripcion:"Redacci\xf3n y comunicaci\xf3n del fallo.",diasEstimados:20},{etapa:"Cumplimiento y seguimiento",descripcion:"Ejecuci\xf3n de medidas decretadas y seguimiento del cumplimiento.",diasEstimados:25}]},L=[{value:"preparatoria",label:"Audiencia preparatoria"},{value:"juicio",label:"Audiencia de juicio"}],M=[{value:"pendiente",label:"Pendiente",color:"gray"},{value:"en_proceso",label:"En Proceso",color:"blue"},{value:"completado",label:"Completado",color:"green"}],N=[{value:"pendiente",label:"Pendiente",color:"gray"},{value:"solicitado",label:"Solicitado por cliente",color:"blue"},{value:"en_proceso",label:"En proceso",color:"amber"},{value:"parcial",label:"Pago parcial",color:"blue"},{value:"pagado",label:"Pagado",color:"green"},{value:"vencido",label:"Vencido",color:"red"}];function O({caseId:a,caseMateria:b="Civil",canManageStages:c=!1,showPrivateStages:j=!0,clientContext:I,onClientProgressChange:O,onStagesLoaded:P}){let[Q,R]=(0,e.useState)([]),[S,T]=(0,e.useState)(!0),[U,V]=(0,e.useState)(!1),[W,X]=(0,e.useState)(null),[Y,Z]=(0,e.useState)(!1),[$,_]=(0,e.useState)({etapa:"",descripcion:"",fecha_programada:"",es_publica:!0,isCustom:!1,audiencia_tipo:"",requiere_testigos:!1,requiere_pago:!1,costo_uf:"",porcentaje_variable:"",enlace_pago:"",notas_pago:"",monto_variable_base:"",estado_pago:"pendiente",monto_pagado_uf:""}),{toast:aa}=(0,i.dj)(),[ab,ac]=(0,e.useState)(null),[ad,ae]=(0,e.useState)(null),af=I?.alcanceAutorizado??0,ag=I?.alcanceSolicitado??0,ah="cliente"===(I?.role??"cliente"),[ai,aj]=(0,e.useState)({solicitado:ag,autorizado:af}),[ak,al]=(0,e.useState)(null),am=async()=>{T(!0);try{let b=await k({case_id:a,page:1,limit:50});b.success?(R(b.stages),P?.(b.stages)):aa({title:"Error",description:b.error||"Error al cargar etapas",variant:"destructive"})}catch(a){console.error("Error loading stages:",a),aa({title:"Error",description:"Error inesperado al cargar etapas",variant:"destructive"})}finally{T(!1)}},an=async()=>{if(!$.etapa.trim())return void aa({title:"Error",description:"El nombre de la etapa es requerido",variant:"destructive"});let b=$.costo_uf?Number($.costo_uf):void 0;if($.requiere_pago&&(void 0===b||Number.isNaN(b)))return void aa({title:"Costo requerido",description:"Debes indicar el costo en UF de la etapa para poder cobrarla.",variant:"destructive"});if(void 0!==b&&b<0)return void aa({title:"Monto inv\xe1lido",description:"El costo en UF debe ser un n\xfamero positivo.",variant:"destructive"});let c=$.porcentaje_variable?Number($.porcentaje_variable):void 0;if(void 0!==c&&(Number.isNaN(c)||c<0||c>100))return void aa({title:"Porcentaje inv\xe1lido",description:"El porcentaje variable debe estar entre 0% y 100%.",variant:"destructive"});let d=$.monto_pagado_uf?Number($.monto_pagado_uf):void 0;if(void 0!==d&&(Number.isNaN(d)||d<0))return void aa({title:"Monto pagado inv\xe1lido",description:"El monto pagado debe ser un n\xfamero positivo.",variant:"destructive"});let e=$.enlace_pago?.trim();if(e&&!/^https?:\/\//i.test(e))return void aa({title:"URL inv\xe1lida",description:"El enlace de pago debe comenzar con http:// o https://",variant:"destructive"});V(!0);try{let f=Math.max(...Q.map(a=>a.orden||0),0),g=$.audiencia_tipo?$.audiencia_tipo:void 0,h={case_id:a,etapa:$.etapa.trim(),descripcion:$.descripcion.trim()||void 0,fecha_programada:$.fecha_programada||void 0,es_publica:$.es_publica,estado:"pendiente",orden:f+1,audiencia_tipo:g,requiere_testigos:$.requiere_testigos,requiere_pago:$.requiere_pago,costo_uf:b,porcentaje_variable:c,estado_pago:$.estado_pago||"pendiente",enlace_pago:e||void 0,notas_pago:$.notas_pago?.trim()||void 0,monto_variable_base:$.monto_variable_base?.trim()||void 0,monto_pagado_uf:d},i=await l(h);i.success?(aa({title:"Etapa creada",description:"La etapa ha sido creada exitosamente"}),_({etapa:"",descripcion:"",fecha_programada:"",es_publica:!0,isCustom:!1,audiencia_tipo:"",requiere_testigos:!1,requiere_pago:!1,costo_uf:"",porcentaje_variable:"",enlace_pago:"",notas_pago:"",monto_variable_base:"",estado_pago:"pendiente",monto_pagado_uf:""}),Z(!1),await am()):aa({title:"Error",description:i.error||"Error al crear la etapa",variant:"destructive"})}catch(a){console.error("Error creating stage:",a),aa({title:"Error",description:"Error inesperado al crear la etapa",variant:"destructive"})}finally{V(!1)}},ao=async a=>{if(a.requiere_pago&&"pagado"!==a.estado_pago)return void aa({title:"Pago pendiente",description:"Debes registrar el pago de esta etapa antes de marcarla como completada.",variant:"destructive"});try{ac(a.id);let b=await m(a.id);b.success?(aa({title:"Etapa completada",description:"La etapa ha sido marcada como completada"}),await am()):aa({title:"Error",description:b.error||"Error al completar la etapa",variant:"destructive"})}catch(a){console.error("Error completing stage:",a),aa({title:"Error",description:"Error inesperado al completar la etapa",variant:"destructive"})}finally{ac(null)}},ap=async a=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar esta etapa?"))try{let b=await n(a);b.success?(aa({title:"Etapa eliminada",description:"La etapa ha sido eliminada exitosamente"}),await am()):aa({title:"Error",description:b.error||"Error al eliminar la etapa",variant:"destructive"})}catch(a){console.error("Error deleting stage:",a),aa({title:"Error",description:"Error inesperado al eliminar la etapa",variant:"destructive"})}},aq=a=>null==a?"—":`${new Intl.NumberFormat("es-CL",{minimumFractionDigits:2,maximumFractionDigits:2}).format(a)} UF`,ar=async b=>{if(ah&&b.id){al(b.id);try{let c=await p(a,b.id);c.success?(aj(a=>({autorizado:a.autorizado,solicitado:c.requestedOrder??a.solicitado})),aa({title:"Solicitud enviada",description:`Solicitaste avanzar hasta la etapa "${b.etapa}".`}),await am()):aa({title:"No se pudo solicitar el avance",description:c.error??"Intenta nuevamente en unos minutos.",variant:"destructive"})}catch(a){console.error("Error requesting case advance:",a),aa({title:"Error inesperado",description:"No pudimos registrar tu solicitud, intenta nuevamente.",variant:"destructive"})}finally{al(null)}}},as=async a=>{let b=prompt("Ingresa el enlace de pago de Payku para esta etapa",a.enlace_pago??"");if(null===b)return;let c=b.trim();if(c&&!/^https?:\/\//i.test(c))return void aa({title:"URL inv\xe1lida",description:"Ingresa una URL v\xe1lida que comience con http:// o https://",variant:"destructive"});try{ae(a.id);let b=await o(a.id,{enlace_pago:c||void 0,requiere_pago:!!c||a.requiere_pago});b.success?(aa({title:c?"Enlace de pago actualizado":"Enlace eliminado",description:c?"Comparte este enlace con el cliente para cobrar la etapa.":"Se elimin\xf3 el enlace asociado a la etapa."}),await am()):aa({title:"No se pudo guardar el enlace",description:b.error||"Intenta nuevamente.",variant:"destructive"})}catch(a){console.error("Error setting payment link:",a),aa({title:"Error inesperado",description:"No pudimos guardar el enlace en este momento.",variant:"destructive"})}finally{ae(null)}},at=async a=>{let b=a.monto_pagado_uf??a.costo_uf??0,c=prompt("Monto pagado (UF)",b>0?b.toString():a.costo_uf?.toString()??"");if(null===c)return;let d=Number(c.replace(",","."));if(Number.isNaN(d)||d<0)return void aa({title:"Monto inv\xe1lido",description:"Ingresa un n\xfamero v\xe1lido en UF.",variant:"destructive"});let e=a.costo_uf??0,f=e>0&&d>=e?"pagado":"parcial";try{ae(a.id);let b=await o(a.id,{estado_pago:f,monto_pagado_uf:d,requiere_pago:!0});b.success?(aa({title:"Pago registrado",description:"pagado"===f?"La etapa qued\xf3 marcada como pagada.":"Se registr\xf3 un pago parcial."}),await am()):aa({title:"No se pudo registrar el pago",description:b.error||"Vuelve a intentarlo.",variant:"destructive"})}catch(a){console.error("Error setting payment status:",a),aa({title:"Error inesperado",description:"No pudimos registrar el pago.",variant:"destructive"})}finally{ae(null)}},au=async a=>{if(!a.costo_uf||!a.monto_pagado_uf||!(a.monto_pagado_uf<a.costo_uf)||confirm("El monto registrado como pagado es menor al costo de la etapa. \xbfDeseas marcarla como pagada de todas maneras?"))try{ae(a.id);let b=await o(a.id,{estado_pago:"pagado",monto_pagado_uf:a.costo_uf??a.monto_pagado_uf??0,requiere_pago:!0});b.success?(aa({title:"Pago completado",description:"Esta etapa qued\xf3 marcada como pagada."}),await am()):aa({title:"No se pudo marcar como pagado",description:b.error||"Intenta nuevamente.",variant:"destructive"})}catch(a){console.error("Error marking stage paid:",a),aa({title:"Error inesperado",description:"No fue posible marcar la etapa como pagada.",variant:"destructive"})}finally{ae(null)}},av=j?Q:Q.filter(a=>a.es_publica),aw=function(a){if(!a)return K.Civil;let b=a.toLowerCase(),c=Object.keys(K).find(a=>a.toLowerCase()===b),d=c?K[c]:K.Civil,e=c&&J[c]?J[c]:J.Civil??[];return d.map((a,b)=>({...a,porcentajeHonorario:e[b]??0}))}(b),ax=Q.reduce((a,b)=>a+(b.costo_uf??0),0),ay=Q.reduce((a,b)=>a+(b.monto_pagado_uf??0),0),az=Q.filter(a=>a.requiere_pago),aA=az.filter(a=>"pagado"===a.estado_pago).length,aB=az.filter(a=>"pagado"!==a.estado_pago).length,aC=az.filter(a=>"solicitado"===a.estado_pago).length,aD=a=>{if(!a)return null;let b=Q.find(b=>(b.orden??0)===a);return b?.etapa??null},aE=ah?aD(ai.solicitado):null,aF=ah?aD(ai.autorizado):null;return S?(0,d.jsxs)(g.Zp,{children:[(0,d.jsx)(g.aR,{children:(0,d.jsxs)(g.ZB,{className:"flex items-center gap-2",children:[(0,d.jsx)(s.A,{className:"h-5 w-5"}),"Timeline Procesal"]})}),(0,d.jsx)(g.Wu,{children:(0,d.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,d.jsx)(u.A,{className:"h-6 w-6 animate-spin"})})})]}):(0,d.jsxs)(g.Zp,{children:[(0,d.jsx)(g.aR,{children:(0,d.jsxs)("div",{className:"flex items-center justify-between",children:[(0,d.jsxs)(g.ZB,{className:"flex items-center gap-2",children:[(0,d.jsx)(s.A,{className:"h-5 w-5"}),"Timeline Procesal (",av.length,")"]}),c&&(0,d.jsxs)(f.$,{size:"sm",onClick:()=>Z(!Y),disabled:U,children:[(0,d.jsx)(v.A,{className:"h-4 w-4 mr-2"}),"Nueva Etapa"]})]})}),(0,d.jsxs)(g.Wu,{className:"space-y-6",children:[az.length>0&&(0,d.jsxs)("div",{className:`grid grid-cols-1 ${ah?"md:grid-cols-4":"md:grid-cols-3"} gap-3 rounded-lg border border-blue-100 bg-blue-50 p-4 text-sm text-blue-900`,children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Honorario distribuido"}),(0,d.jsx)("p",{className:"text-lg font-semibold",children:aq(ax)})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Pagado"}),(0,d.jsx)("p",{className:"text-lg font-semibold",children:aq(ay)})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Etapas liberadas"}),(0,d.jsxs)("p",{className:"text-lg font-semibold",children:[aA," / ",az.length]}),aB>0&&(0,d.jsxs)("p",{className:"text-xs text-blue-700 mt-1",children:["Faltan ",aB," pago(s) para completar el plan."]})]}),ah&&(0,d.jsxs)("div",{children:[(0,d.jsx)("p",{className:"text-xs uppercase tracking-wide text-blue-600",children:"Solicitadas por el cliente"}),(0,d.jsx)("p",{className:"text-lg font-semibold",children:aC})]})]}),ah&&(0,d.jsxs)("div",{className:"rounded-xl border border-slate-200 bg-white/80 px-4 py-4 text-sm text-slate-600 shadow-sm",children:[(0,d.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Alcance solicitado"}),(0,d.jsx)("p",{className:"text-base font-semibold text-slate-900",children:ai.solicitado>0?aE??`Etapa ${ai.solicitado}`:"A\xfan no definido"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Autorizado por el estudio"}),(0,d.jsx)("p",{className:"text-base font-semibold text-slate-900",children:ai.autorizado>0?aF??`Etapa ${ai.autorizado}`:"Pendiente"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Etapas solicitadas"}),(0,d.jsxs)("p",{className:"text-base font-semibold text-slate-900",children:[aC," / ",az.length]})]})]}),ai.solicitado>ai.autorizado&&(0,d.jsx)("p",{className:"mt-3 text-xs text-slate-500",children:"Estamos revisando tu solicitud para avanzar. Te notificaremos cuando est\xe9 aprobada."})]}),Y&&c&&(0,d.jsx)(g.Zp,{className:"border-dashed",children:(0,d.jsx)(g.Wu,{className:"pt-6",children:(0,d.jsxs)("div",{className:"space-y-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Etapa"}),(0,d.jsxs)("select",{value:$.isCustom?"custom":$.etapa,onChange:a=>{let b=a.target.value;if("custom"===b)return void _({...$,etapa:"",descripcion:"",isCustom:!0});let c=aw.find(a=>a.etapa===b);_({...$,etapa:b,descripcion:c?.descripcion||$.descripcion,isCustom:!1,requiere_pago:c?.requierePago??$.requiere_pago,costo_uf:c?.costoUF!==void 0?c.costoUF.toString():"",porcentaje_variable:c?.porcentajeVariable!==void 0?c.porcentajeVariable.toString():"",monto_variable_base:c?.notasPago||"",estado_pago:"pendiente",notas_pago:c?.notasPago||""})},className:"form-input",children:[(0,d.jsx)("option",{value:"",children:"Seleccionar etapa"}),aw.map(a=>(0,d.jsxs)("option",{value:a.etapa,children:[a.etapa," ",a.diasEstimados?`(≈ ${a.diasEstimados} d\xedas)`:""]},a.etapa)),(0,d.jsx)("option",{value:"custom",children:"Etapa personalizada..."})]}),$.isCustom&&(0,d.jsx)("input",{type:"text",placeholder:"Nombre de la etapa personalizada",value:$.etapa,onChange:a=>_({...$,etapa:a.target.value}),className:"form-input mt-2"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Descripci\xf3n (opcional)"}),(0,d.jsx)("textarea",{value:$.descripcion,onChange:a=>_({...$,descripcion:a.target.value}),placeholder:"Descripci\xf3n de la etapa...",rows:3,className:"form-input"})]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("label",{className:"block text-sm font-medium",children:"Tipo de audiencia"}),(0,d.jsxs)("select",{value:$.audiencia_tipo,onChange:a=>{let b=a.target.value;_(a=>({...a,audiencia_tipo:b,requiere_testigos:""!==b&&a.requiere_testigos}))},className:"form-input",children:[(0,d.jsx)("option",{value:"",children:"Sin audiencia definida"}),L.map(a=>(0,d.jsx)("option",{value:a.value,children:a.label},a.value))]})]}),(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("label",{className:"block text-sm font-medium",children:"Participaci\xf3n de testigos"}),(0,d.jsxs)("label",{className:`flex items-center gap-2 rounded-md border px-3 py-2 text-sm ${$.audiencia_tipo?"border-gray-300 bg-white text-gray-700":"border-dashed border-gray-300 bg-gray-50 text-gray-500"}`,children:[(0,d.jsx)("input",{type:"checkbox",className:"rounded border-gray-300",checked:$.requiere_testigos,disabled:!$.audiencia_tipo,onChange:a=>_({...$,requiere_testigos:a.target.checked})}),"Se coordinar\xe1n testigos para esta audiencia"]}),(0,d.jsx)("p",{className:"text-xs text-gray-500",children:"Esta informaci\xf3n ayuda al equipo a planificar con tiempo la asistencia."})]})]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Fecha programada (opcional)"}),(0,d.jsx)("input",{type:"date",value:$.fecha_programada,onChange:a=>_({...$,fecha_programada:a.target.value}),className:"form-input"})]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Visibilidad"}),(0,d.jsxs)("select",{value:$.es_publica?"publica":"privada",onChange:a=>_({...$,es_publica:"publica"===a.target.value}),className:"form-input",children:[(0,d.jsx)("option",{value:"publica",children:"P\xfablica (visible para cliente)"}),(0,d.jsx)("option",{value:"privada",children:"Privada (solo abogados)"})]})]})]}),(0,d.jsxs)("div",{className:"space-y-4 border-t border-gray-200 pt-4",children:[(0,d.jsxs)("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700",children:[(0,d.jsx)("input",{type:"checkbox",className:"rounded border-gray-300",checked:$.requiere_pago,onChange:a=>_({...$,requiere_pago:a.target.checked,estado_pago:"pendiente"})}),"Esta etapa requiere pago para avanzar"]}),$.requiere_pago&&(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("label",{className:"block text-sm font-medium",children:"Monto fijo (UF)"}),(0,d.jsx)("input",{type:"number",min:"0",step:"0.01",value:$.costo_uf,onChange:a=>_({...$,costo_uf:a.target.value}),className:"form-input",placeholder:"Ej: 5.0"})]}),(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("label",{className:"block text-sm font-medium",children:"Componente variable (%)"}),(0,d.jsx)("input",{type:"number",min:"0",max:"100",step:"0.1",value:$.porcentaje_variable,onChange:a=>_({...$,porcentaje_variable:a.target.value}),className:"form-input",placeholder:"Ej: 10"})]}),(0,d.jsxs)("div",{className:"md:col-span-2 space-y-2",children:[(0,d.jsx)("label",{className:"block text-sm font-medium",children:"Base del variable"}),(0,d.jsx)("textarea",{rows:2,value:$.monto_variable_base,onChange:a=>_({...$,monto_variable_base:a.target.value}),className:"form-input",placeholder:"Ej: 10% de lo obtenido o ahorrado."})]}),(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("label",{className:"block text-sm font-medium",children:"Link de pago (Payku)"}),(0,d.jsx)("input",{type:"url",value:$.enlace_pago,onChange:a=>_({...$,enlace_pago:a.target.value}),className:"form-input",placeholder:"https://..."})]}),(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("label",{className:"block text-sm font-medium",children:"Notas internas"}),(0,d.jsx)("textarea",{rows:2,value:$.notas_pago,onChange:a=>_({...$,notas_pago:a.target.value}),className:"form-input",placeholder:"Instrucciones u observaciones sobre el cobro."})]}),(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("label",{className:"block text-sm font-medium",children:"Estado inicial del pago"}),(0,d.jsx)("select",{value:$.estado_pago,onChange:a=>_({...$,estado_pago:a.target.value}),className:"form-input",children:N.map(a=>(0,d.jsx)("option",{value:a.value,children:a.label},a.value))})]}),(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("label",{className:"block text-sm font-medium",children:"Monto ya pagado (UF)"}),(0,d.jsx)("input",{type:"number",min:"0",step:"0.01",value:$.monto_pagado_uf,onChange:a=>_({...$,monto_pagado_uf:a.target.value}),className:"form-input",placeholder:"0.00"})]})]}),(0,d.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,d.jsx)(f.$,{variant:"outline",onClick:()=>{Z(!1),_({etapa:"",descripcion:"",fecha_programada:"",es_publica:!0,isCustom:!1,audiencia_tipo:"",requiere_testigos:!1,requiere_pago:!1,costo_uf:"",porcentaje_variable:"",enlace_pago:"",notas_pago:"",monto_variable_base:"",estado_pago:"pendiente",monto_pagado_uf:""})},disabled:U,children:"Cancelar"}),(0,d.jsx)(f.$,{onClick:an,disabled:U,children:U?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(u.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Creando..."]}):"Crear Etapa"})]})]})]})})}),(0,d.jsx)("div",{className:"relative",children:av.map((a,b)=>{let e=a.responsable,i=a.orden??b+1,j=ah&&i<=ai.autorizado,k=ah&&i<=ai.solicitado&&i>ai.autorizado,l=["completado"===a.estado?"bg-green-50":"",j?"border-green-200 bg-green-50/70":"",!j&&k?"border-blue-200 bg-blue-50/70":""].filter(Boolean).join(" "),m="completado"===a.estado,n=j||m||(a.estado_pago??"pendiente")==="pagado"||i<=ai.solicitado||ak===a.id,o=a.audiencia_tipo?L.find(b=>b.value===a.audiencia_tipo)?.label??`Audiencia ${a.audiencia_tipo}`:null;return(0,d.jsxs)("div",{className:"relative flex items-start space-x-4 pb-8",children:[b<av.length-1&&(0,d.jsx)("div",{className:"absolute left-2.5 top-8 w-0.5 h-full bg-gray-200"}),(0,d.jsx)("div",{className:"relative z-10 flex-shrink-0",children:(a=>{switch(a){case"completado":return(0,d.jsx)(r.A,{className:"h-5 w-5 text-green-600"});case"en_proceso":return(0,d.jsx)(s.A,{className:"h-5 w-5 text-blue-600"});default:return(0,d.jsx)(t.A,{className:"h-5 w-5 text-gray-400"})}})(a.estado||"pendiente")}),(0,d.jsx)("div",{className:"flex-1 min-w-0",children:(0,d.jsx)(g.Zp,{className:l,children:(0,d.jsxs)(g.Wu,{className:"pt-4",children:[(0,d.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,d.jsxs)("div",{className:"flex-1",children:[(0,d.jsx)("h4",{className:"font-medium text-gray-900",children:a.etapa}),a.descripcion&&(0,d.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:a.descripcion}),(o||a.requiere_testigos)&&(0,d.jsxs)("div",{className:"mt-3 flex flex-wrap items-center gap-2 text-xs",children:[o&&(0,d.jsxs)("span",{className:"inline-flex items-center gap-1 rounded-full bg-blue-100 px-2 py-0.5 font-medium text-blue-700",children:[(0,d.jsx)(w.A,{className:"h-3 w-3"}),o]}),a.requiere_testigos&&(0,d.jsxs)("span",{className:"inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 font-medium text-amber-800",children:[(0,d.jsx)(x.A,{className:"h-3 w-3"}),"Requiere testigos"]})]})]}),(0,d.jsxs)("div",{className:"flex items-center gap-2 ml-4",children:[(a=>{let b=M.find(b=>b.value===a);return b?(0,d.jsx)("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${{gray:"bg-gray-100 text-gray-800",blue:"bg-blue-100 text-blue-800",green:"bg-green-100 text-green-800",red:"bg-red-100 text-red-800"}[b.color]}`,children:b.label}):null})(a.estado||"pendiente"),!a.es_publica&&(0,d.jsx)(h.E,{variant:"outline",children:"Privada"})]})]}),(0,d.jsxs)("div",{className:"flex items-center gap-4 text-sm text-gray-500 mb-3",children:[a.fecha_programada&&(0,d.jsxs)("div",{className:"flex items-center gap-1",children:[(0,d.jsx)(y.A,{className:"h-4 w-4"}),(0,d.jsx)("span",{className:(0,q.m7)(a.fecha_programada)&&"completado"!==a.estado?"text-red-600 font-medium":"",children:(0,q.Yq)(a.fecha_programada)})]}),e?.nombre&&(0,d.jsxs)("div",{className:"flex items-center gap-1",children:[(0,d.jsx)(z.A,{className:"h-4 w-4"}),(0,d.jsx)("span",{children:e.nombre})]}),a.fecha_cumplida&&(0,d.jsxs)("div",{className:"text-green-600",children:["Completado ",(0,q.fw)(a.fecha_cumplida)]})]}),a.requiere_pago&&(0,d.jsxs)("div",{className:"mt-3 rounded-lg border border-amber-200 bg-amber-50 p-3 text-sm space-y-2 text-amber-900",children:[(0,d.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[(0,d.jsxs)("div",{className:"flex items-center gap-2 font-semibold",children:[(0,d.jsx)(A.A,{className:"h-4 w-4"}),(0,d.jsx)("span",{children:"Costo de la etapa:"}),(0,d.jsx)("span",{children:aq(a.costo_uf)})]}),(a=>{if(!a)return null;let b=N.find(b=>b.value===a);if(!b)return null;let c={gray:"bg-gray-100 text-gray-800",amber:"bg-amber-100 text-amber-800",blue:"bg-blue-100 text-blue-800",green:"bg-green-100 text-green-800",red:"bg-red-100 text-red-800"}[b.color]||"bg-gray-100 text-gray-800";return(0,d.jsx)(h.E,{className:c,variant:"outline",children:b.label})})(a.estado_pago||"pendiente")]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 text-amber-800",children:[(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)(B.A,{className:"h-4 w-4"}),(0,d.jsxs)("span",{children:["Pagado: ",aq(a.monto_pagado_uf)]})]}),a.porcentaje_variable&&(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)(C.A,{className:"h-4 w-4"}),(0,d.jsxs)("span",{children:["Variable: ",a.porcentaje_variable,"% ",a.monto_variable_base?`(${a.monto_variable_base})`:""]})]})]}),a.notas_pago&&(0,d.jsx)("p",{className:"text-xs text-amber-700 bg-white/60 border border-amber-200 rounded-md px-3 py-2",children:a.notas_pago}),"solicitado"===a.estado_pago&&(0,d.jsxs)("p",{className:"flex items-center gap-2 text-xs text-amber-700",children:[(0,d.jsx)(D.A,{className:"h-3 w-3"}),"Solicitud enviada"," ",a.solicitado_at?(0,q.fw)(a.solicitado_at):"recientemente","."]}),(0,d.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[a.enlace_pago&&(0,d.jsx)(f.$,{size:"sm",variant:"outline",asChild:!0,children:(0,d.jsxs)("a",{href:a.enlace_pago,target:"_blank",rel:"noopener noreferrer",children:[(0,d.jsx)(E.A,{className:"h-4 w-4 mr-2"}),"Abrir enlace Payku"]})}),c&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(f.$,{size:"sm",variant:"ghost",onClick:()=>as(a),disabled:ad===a.id,children:ad===a.id?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(u.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Guardando…"]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(F.A,{className:"h-4 w-4 mr-2"}),a.enlace_pago?"Editar enlace":"Asignar enlace"]})}),(0,d.jsx)(f.$,{size:"sm",variant:"ghost",onClick:()=>at(a),disabled:ad===a.id,children:ad===a.id?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(u.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Registrando…"]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(B.A,{className:"h-4 w-4 mr-2"}),"Registrar pago"]})}),(0,d.jsx)(f.$,{size:"sm",variant:"outline",onClick:()=>au(a),disabled:ad===a.id,children:ad===a.id?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(u.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Confirmando…"]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(C.A,{className:"h-4 w-4 mr-2"}),"Marcar pagado"]})})]}),ah&&!c&&(0,d.jsx)(f.$,{size:"sm",variant:"outline",onClick:()=>ar(a),disabled:n,children:ak===a.id?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(u.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Enviando…"]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(A.A,{className:"h-4 w-4 mr-2"}),"Solicitar prepago"]})})]}),"pagado"!==a.estado_pago&&a.enlace_pago&&(0,d.jsxs)("p",{className:"text-xs text-amber-700 flex items-center gap-1",children:[(0,d.jsx)(D.A,{className:"h-3 w-3"}),"Comparte el enlace con el cliente para liberar esta etapa."]})]}),c&&(0,d.jsxs)("div",{className:"flex items-center gap-2",children:["completado"!==a.estado&&(0,d.jsx)(f.$,{size:"sm",variant:"outline",onClick:()=>ao(a),disabled:ab===a.id||a.requiere_pago&&"pagado"!==a.estado_pago,children:ab===a.id?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(u.A,{className:"h-4 w-4 mr-1 animate-spin"}),"Procesando…"]}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(r.A,{className:"h-4 w-4 mr-1"}),"Completar"]})}),(0,d.jsx)(f.$,{size:"sm",variant:"ghost",onClick:()=>X(a.id),children:(0,d.jsx)(G.A,{className:"h-4 w-4"})}),(0,d.jsx)(f.$,{size:"sm",variant:"ghost",onClick:()=>ap(a.id),children:(0,d.jsx)(H.A,{className:"h-4 w-4"})})]})]})})})]},a.id)})}),0===av.length&&(0,d.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,d.jsx)(s.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,d.jsx)("p",{children:"No hay etapas definidas para este caso"}),c&&(0,d.jsx)("p",{className:"text-sm mt-2",children:'Haz clic en "Nueva Etapa" para agregar la primera etapa'})]}),aw.length>0&&(0,d.jsxs)("div",{className:"border-t pt-4 mt-2",children:[(0,d.jsxs)("h3",{className:"text-sm font-semibold text-gray-700",children:["Plan estimado de referencia para materia ",b||"Civil"]}),(0,d.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Duraciones aproximadas en d\xedas a partir del inicio del caso."}),(0,d.jsx)("ul",{className:"mt-3 space-y-2 text-sm text-gray-600",children:aw.map((a,b)=>(0,d.jsxs)("li",{className:"flex items-start gap-2",children:[(0,d.jsx)("span",{className:"mt-1 h-2 w-2 rounded-full bg-blue-500 flex-shrink-0"}),(0,d.jsxs)("span",{children:[(0,d.jsx)("span",{className:"font-medium text-gray-800",children:a.etapa}),(0,d.jsxs)("span",{className:"block text-gray-500",children:[a.descripcion,a.diasEstimados?` \xb7 ≈ ${a.diasEstimados} d\xedas`:""]})]})]},`${a.etapa}-${b}`))})]})]})]})}},71095:(a,b,c)=>{c.d(b,{e2:()=>s,Qw:()=>p,iI:()=>u,F8:()=>t,tT:()=>r,Z0:()=>q});var d=c(61776);c(70958);var e=c(46221),f=c(83273),g=c(60619),h=c(56931),i=c(73771);let j=i.Ik({case_id:i.Yj().uuid("ID de caso inv\xe1lido"),titulo:i.Yj().min(1,"El t\xedtulo es requerido").max(1e3,"El t\xedtulo no puede exceder 1000 caracteres"),descripcion:i.Yj().min(1,"La descripci\xf3n es requerida").max(2e3,"La descripci\xf3n no puede exceder 2000 caracteres"),tipo:i.k5(["documento","informacion","reunion","otro"]).default("informacion"),prioridad:i.k5(["baja","media","alta","urgente"]).default("media"),fecha_limite:i.Yj().optional(),es_publica:i.zM().default(!0)}),k=j.partial().omit({case_id:!0}),l=i.Ik({respuesta:i.Yj().min(1,"La respuesta es requerida").max(2e3,"La respuesta no puede exceder 2000 caracteres"),archivo_adjunto:i.Yj().optional()}),m=i.Ik({case_id:i.Yj().uuid().optional(),estado:i.k5(["pendiente","en_revision","respondida","cerrada"]).optional(),tipo:i.k5(["documento","informacion","reunion","otro"]).optional(),prioridad:i.k5(["baja","media","alta","urgente"]).optional(),creador_id:i.Yj().uuid().optional(),es_publica:i.zM().optional(),fecha_desde:i.Yj().optional(),fecha_hasta:i.Yj().optional(),search:i.Yj().optional(),page:i.ai().min(1).default(1),limit:i.ai().min(1).max(100).default(20)});function n(a,b,c){void 0!==c&&(a[b]=c)}function o(a){return a?a.trim()||null:null}async function p(a){try{let b=await (0,g.oC)(),c=j.parse(a);if(!await (0,g.Nf)(c.case_id))throw Error("Sin permisos para acceder a este caso");let d=await (0,f.R)(),i={case_id:c.case_id,creador_id:b.id,titulo:c.titulo,descripcion:c.descripcion,tipo:c.tipo,prioridad:c.prioridad,es_publica:c.es_publica??!0,fecha_limite:o(c.fecha_limite)},{data:k,error:l}=await d.from("info_requests").insert(i).select(`
        *,
        creador:profiles!info_requests_creador_id_fkey(id, nombre),
        case:cases(id, caratulado)
      `).single();if(l)throw console.error("createInfoRequest insert error:",l),Error("Error al crear la solicitud");return await (0,h.UU)({action:"CREATE",entity_type:"info_request",entity_id:k.id,diff_json:{created:i}}),(0,e.revalidatePath)(`/cases/${c.case_id}`),{success:!0,request:k}}catch(a){return console.error("Error in createInfoRequest:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function q(a,b){try{let c=await (0,g.oC)(),d=k.parse(b),i=await (0,f.R)(),{data:j,error:l}=await i.from("info_requests").select("*").eq("id",a).single();if(l||!j)throw Error("Solicitud no encontrada");if(!await (0,g.Nf)(j.case_id))throw Error("Sin permisos para acceder a este caso");if("admin_firma"!==c.role&&j.creador_id!==c.id)if("abogado"===c.role){let{data:a}=await i.from("cases").select("abogado_responsable").eq("id",j.case_id).single();if(!a||a.abogado_responsable!==c.id)throw Error("Sin permisos para editar esta solicitud")}else throw Error("Sin permisos para editar esta solicitud");let m={};n(m,"titulo",d.titulo),n(m,"descripcion",d.descripcion),n(m,"tipo",d.tipo),n(m,"prioridad",d.prioridad),n(m,"es_publica",d.es_publica),n(m,"fecha_limite",o(d.fecha_limite));let{data:p,error:q}=await i.from("info_requests").update(m).eq("id",a).select(`
        *,
        creador:profiles!info_requests_creador_id_fkey(id, nombre),
        case:cases(id, caratulado)
      `).single();if(q)throw console.error("updateInfoRequest update error:",q),Error("Error al actualizar la solicitud");return await (0,h.UU)({action:"UPDATE",entity_type:"info_request",entity_id:a,diff_json:{from:j,to:p}}),(0,e.revalidatePath)(`/cases/${j.case_id}`),{success:!0,request:p}}catch(a){return console.error("Error in updateInfoRequest:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function r(a,b){try{let c=await (0,g.oC)(),d=l.parse(b),i=await (0,f.R)(),{data:j,error:k}=await i.from("info_requests").select("*").eq("id",a).single();if(k||!j)throw Error("Solicitud no encontrada");if(!await (0,g.Nf)(j.case_id))throw Error("Sin permisos para acceder a este caso");if("cliente"===c.role)throw Error("Sin permisos para responder solicitudes");let m=new Date().toISOString(),n={respuesta:d.respuesta,archivo_adjunto:b?.archivo_adjunto??null,respondido_por:c.id,respondido_at:m,estado:"respondida"},{data:o,error:p}=await i.from("info_requests").update(n).eq("id",a).select(`
        *,
        creador:profiles!info_requests_creador_id_fkey(id, nombre),
        respondido_por_profile:profiles!info_requests_respondido_por_fkey(id, nombre),
        case:cases(id, caratulado)
      `).single();if(p)throw console.error("respondInfoRequest update error:",p),Error("Error al responder la solicitud");return await (0,h.UU)({action:"RESPOND",entity_type:"info_request",entity_id:a,diff_json:{response:n}}),(0,e.revalidatePath)(`/cases/${j.case_id}`),{success:!0,request:o}}catch(a){return console.error("Error in respondInfoRequest:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function s(a){try{let b=await (0,g.oC)(),c=await (0,f.R)(),{data:d,error:i}=await c.from("info_requests").select("*").eq("id",a).single();if(i||!d)throw Error("Solicitud no encontrada");if(!await (0,g.Nf)(d.case_id))throw Error("Sin permisos para acceder a este caso");if("admin_firma"!==b.role&&d.creador_id!==b.id)if("abogado"===b.role){let{data:a}=await c.from("cases").select("abogado_responsable").eq("id",d.case_id).single();if(!a||a.abogado_responsable!==b.id)throw Error("Sin permisos para cerrar esta solicitud")}else throw Error("Sin permisos para cerrar esta solicitud");let{data:j,error:k}=await c.from("info_requests").update({estado:"cerrada"}).eq("id",a).select(`
        *,
        creador:profiles!info_requests_creador_id_fkey(id, nombre),
        case:cases(id, caratulado)
      `).single();if(k)throw console.error("closeInfoRequest update error:",k),Error("Error al cerrar la solicitud");return await (0,h.UU)({action:"CLOSE",entity_type:"info_request",entity_id:a,diff_json:{closed:!0}}),(0,e.revalidatePath)(`/cases/${d.case_id}`),{success:!0,request:j}}catch(a){return console.error("Error in closeInfoRequest:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function t(a={page:1,limit:20}){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c=m.parse(a),d=await (0,f.R)(),e=d.from("info_requests").select(`
        *,
        creador:profiles!info_requests_creador_id_fkey(id, nombre),
        respondido_por_profile:profiles!info_requests_respondido_por_fkey(id, nombre),
        case:cases(id, caratulado)
        `,{count:"exact"});if("cliente"===b.role){e=e.or(`creador_id.eq.${b.id},es_publica.eq.true`);let{data:a}=await d.from("case_clients").select("case_id").eq("client_profile_id",b.id),c=a?.map(a=>a.case_id)||[];if(0===c.length)return{success:!0,requests:[],total:0};e=e.in("case_id",c)}else if("abogado"===b.role){let{data:a}=await d.from("cases").select("id").eq("abogado_responsable",b.id),c=a?.map(a=>a.id)||[];if(0===c.length)return{success:!0,requests:[],total:0};e=e.in("case_id",c)}if(c.case_id){if(!await (0,g.Nf)(c.case_id))throw Error("Sin permisos para acceder a este caso");e=e.eq("case_id",c.case_id)}c.estado&&(e=e.eq("estado",c.estado)),c.tipo&&(e=e.eq("tipo",c.tipo)),c.prioridad&&(e=e.eq("prioridad",c.prioridad)),c.creador_id&&(e=e.eq("creador_id",c.creador_id)),void 0!==c.es_publica&&(e=e.eq("es_publica",c.es_publica)),c.search&&(e=e.or(`titulo.ilike.%${c.search}%,descripcion.ilike.%${c.search}%`));let h=(c.page-1)*c.limit,i=h+c.limit-1,{data:j,error:k,count:l}=await e.range(h,i).order("created_at",{ascending:!1});if(k)throw console.error("getInfoRequests query error:",k),Error("Error al obtener solicitudes");return{success:!0,requests:j||[],total:l??j?.length??0,page:c.page,limit:c.limit}}catch(a){return console.error("Error in getInfoRequests:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido",requests:[],total:0}}}async function u(a){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c=await (0,f.R)(),{data:d,error:e}=await c.from("info_requests").select(`
        *,
        creador:profiles!info_requests_creador_id_fkey(id, nombre),
        respondido_por_profile:profiles!info_requests_respondido_por_fkey(id, nombre),
        case:cases(id, caratulado)
      `).eq("id",a).single();if(e||!d)throw Error("Solicitud no encontrada");if(!await (0,g.Nf)(d.case_id)||"cliente"===b.role&&!d.es_publica&&d.creador_id!==b.id)throw Error("Sin permisos para ver esta solicitud");return{success:!0,request:d}}catch(a){return console.error("Error in getInfoRequestById:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}(0,c(92714).D)([p,q,r,s,t,u]),(0,d.A)(p,"40590b8aeb9cfa434beea52a3b54560f16fb3251f6",null),(0,d.A)(q,"6057ea57e92354db7cb219830a61283b94f321f9f0",null),(0,d.A)(r,"606404fa1c57a53adafcdadd0b4189028f4b743e65",null),(0,d.A)(s,"40b3ae676bee74d4c392577de287d9a07360d67bdc",null),(0,d.A)(t,"409b0a64c97bfe61b6e8814829fd1beb5b3c0ce84b",null),(0,d.A)(u,"40291cb4187258610e549e252bb229cdb8b701d948",null)},88275:(a,b,c)=>{c.d(b,{E:()=>h});var d=c(59356);c(56389);var e=c(28321),f=c(16815);let g=(0,e.F)("inline-flex items-center gap-1 rounded-full border px-3 py-0.5 text-xs font-medium tracking-tight transition-all focus:outline-none focus:ring-2 focus:ring-offset-2",{variants:{variant:{default:"border-white/30 bg-white/70 text-foreground/80 shadow-sm backdrop-blur-md",secondary:"border-white/20 bg-white/30 text-foreground/70",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/90",outline:"border-white/40 text-foreground/70",success:"border-transparent bg-emerald-500/15 text-emerald-500",warning:"border-transparent bg-amber-400/20 text-amber-600",info:"border-transparent bg-sky-500/15 text-sky-500"}},defaultVariants:{variant:"default"}});function h({className:a,variant:b,...c}){return(0,d.jsx)("div",{className:(0,f.cn)(g({variant:b}),a),...c})}},98366:(a,b,c)=>{c.d(b,{Io:()=>l,Ku:()=>n,Mf:()=>m,ai:()=>o,xS:()=>k});var d=c(61776);c(70958);var e=c(46221),f=c(83273),g=c(60619),h=c(56931),i=c(23024);function j(a,b,c,d,e){if(a&&Object.prototype.hasOwnProperty.call(a,c)){let f=a[c];b[d]=e?e(f):f}}async function k(a){try{let b=await (0,g.oC)(),c=i.ON.parse(a);if(!await (0,g.Nf)(c.case_id))throw Error("Sin permisos para acceder a este caso");if("cliente"===b.role)throw Error("Sin permisos para crear etapas");let d=await (0,f.R)(),j={case_id:c.case_id,etapa:c.etapa,orden:c.orden,estado:c.estado,es_publica:c.es_publica,responsable_id:c.responsable_id??b.id,descripcion:c.descripcion??null,fecha_programada:c.fecha_programada??null,fecha_cumplida:c.fecha_completada??null,audiencia_tipo:c.audiencia_tipo??null,requiere_testigos:c.requiere_testigos??!1,requiere_pago:c.requiere_pago??!1,costo_uf:c.costo_uf??null,porcentaje_variable:c.porcentaje_variable??null,estado_pago:c.estado_pago??"pendiente",enlace_pago:c.enlace_pago??null,notas_pago:c.notas_pago??null,monto_variable_base:c.monto_variable_base??null,monto_pagado_uf:c.monto_pagado_uf??0,solicitado_por:null,solicitado_at:null},{data:k,error:l}=await d.from("case_stages").insert(j).select(`
        *,
        responsable:profiles(nombre),
        case:cases(caratulado)
      `).single();if(l)throw Error("Error al crear la etapa");return await (0,h.UU)({action:"CREATE",entity_type:"case_stage",entity_id:k.id,diff_json:{created:j}}),(0,e.revalidatePath)(`/cases/${c.case_id}`),{success:!0,stage:k}}catch(a){return console.error("Error in createStage:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function l(a,b){try{let c=await (0,g.oC)(),d=i.l6.parse(b),k=await (0,f.R)(),{data:l,error:m}=await k.from("case_stages").select("*").eq("id",a).single();if(m||!l)throw Error("Etapa no encontrada");if(!await (0,g.Nf)(l.case_id))throw Error("Sin permisos para acceder a este caso");if("cliente"===c.role)throw Error("Sin permisos para editar etapas");if("abogado"===c.role&&l.responsable_id!==c.id)throw Error("Solo puedes editar etapas de las que eres responsable");let n={};j(d,n,"etapa","etapa"),j(d,n,"orden","orden"),j(d,n,"estado","estado"),j(d,n,"es_publica","es_publica"),j(d,n,"responsable_id","responsable_id"),j(d,n,"descripcion","descripcion",a=>a??null),j(d,n,"fecha_programada","fecha_programada",a=>a??null),j(d,n,"fecha_completada","fecha_cumplida",a=>a??null),j(d,n,"audiencia_tipo","audiencia_tipo",a=>a??null),j(d,n,"requiere_testigos","requiere_testigos",a=>!!a),j(d,n,"requiere_pago","requiere_pago"),j(d,n,"costo_uf","costo_uf",a=>a??null),j(d,n,"porcentaje_variable","porcentaje_variable",a=>a??null),j(d,n,"estado_pago","estado_pago"),j(d,n,"enlace_pago","enlace_pago",a=>a??null),j(d,n,"notas_pago","notas_pago",a=>a??null),j(d,n,"monto_variable_base","monto_variable_base",a=>a??null),j(d,n,"monto_pagado_uf","monto_pagado_uf",a=>a??null),j(d,n,"solicitado_por","solicitado_por"),j(d,n,"solicitado_at","solicitado_at",a=>a??null);let{data:o,error:p}=await k.from("case_stages").update(n).eq("id",a).select(`
        *,
        responsable:profiles(nombre),
        case:cases(caratulado)
      `).single();if(p)throw Error("Error al actualizar la etapa");return await (0,h.UU)({action:"UPDATE",entity_type:"case_stage",entity_id:a,diff_json:{from:l,to:o}}),(0,e.revalidatePath)(`/cases/${l.case_id}`),{success:!0,stage:o}}catch(a){return console.error("Error in updateStage:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function m(a,b={}){try{let c=await (0,g.oC)(),d=i.rw.parse(b),k=await (0,f.R)(),{data:l,error:m}=await k.from("case_stages").select("*").eq("id",a).single();if(m||!l)throw Error("Etapa no encontrada");if(!await (0,g.Nf)(l.case_id))throw Error("Sin permisos para acceder a este caso");if("cliente"===c.role)throw Error("Sin permisos para completar etapas");if("abogado"===c.role&&l.responsable_id!==c.id)throw Error("Solo puedes completar etapas de las que eres responsable");if(l.requiere_pago&&"pagado"!==l.estado_pago)throw Error("Debes registrar el pago de esta etapa antes de completarla");let n=d.fecha_completada||new Date().toISOString(),o={estado:"completado",fecha_cumplida:n};j(d,o,"observaciones","descripcion",a=>a??null);let{data:q,error:r}=await k.from("case_stages").update(o).eq("id",a).select(`
        *,
        responsable:profiles(nombre),
        case:cases(caratulado)
      `).single();if(r)throw Error("Error al completar la etapa");return await p(l.case_id),await (0,h.UU)({action:"COMPLETE",entity_type:"case_stage",entity_id:a,diff_json:{completed:o}}),(0,e.revalidatePath)(`/cases/${l.case_id}`),{success:!0,stage:q}}catch(a){return console.error("Error in completeStage:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function n(a){try{let b=await (0,g.oC)(),c=await (0,f.R)(),{data:d,error:i}=await c.from("case_stages").select("*").eq("id",a).single();if(i||!d)throw Error("Etapa no encontrada");if(!await (0,g.Nf)(d.case_id))throw Error("Sin permisos para acceder a este caso");if("admin_firma"!==b.role)throw Error("Sin permisos para eliminar etapas");let{error:j}=await c.from("case_stages").delete().eq("id",a);if(j)throw Error("Error al eliminar la etapa");return await (0,h.UU)({action:"DELETE",entity_type:"case_stage",entity_id:a,diff_json:{deleted:d}}),(0,e.revalidatePath)(`/cases/${d.case_id}`),{success:!0}}catch(a){return console.error("Error in deleteStage:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function o(a){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c={page:1,limit:20,...a??{}},d=i.T4.parse(c),e=await (0,f.R)(),h=e.from("case_stages").select(`
        *,
        responsable:profiles(id, nombre),
        case:cases(id, caratulado)
      `,{count:"exact"});if("cliente"===b.role){h=h.eq("es_publica",!0);let{data:a}=await e.from("case_clients").select("case_id").eq("client_profile_id",b.id),c=a?.map(a=>a.case_id)||[];if(0===c.length)return{success:!0,stages:[],total:0,page:d.page,limit:d.limit};h=h.in("case_id",c)}else if("abogado"===b.role){let{data:a}=await e.from("cases").select("id").eq("abogado_responsable",b.id),c=a?.map(a=>a.id)||[];if(0===c.length)return{success:!0,stages:[],total:0,page:d.page,limit:d.limit};h=h.in("case_id",c)}if(d.case_id){if(!await (0,g.Nf)(d.case_id))throw Error("Sin permisos para acceder a este caso");h=h.eq("case_id",d.case_id)}d.estado&&(h=h.eq("estado",d.estado)),d.responsable_id&&(h=h.eq("responsable_id",d.responsable_id)),void 0!==d.es_publica&&(h=h.eq("es_publica",d.es_publica)),d.fecha_desde&&(h=h.gte("fecha_programada",d.fecha_desde)),d.fecha_hasta&&(h=h.lte("fecha_programada",d.fecha_hasta));let j=(d.page-1)*d.limit,k=j+d.limit-1,{data:l,error:m,count:n}=await h.range(j,k).order("orden",{ascending:!0});if(m)throw Error("Error al obtener etapas");return{success:!0,stages:l||[],total:n||0,page:d.page,limit:d.limit}}catch(a){return console.error("Error in getStages:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido",stages:[],total:0}}}async function p(a){let b=await (0,f.R)(),{data:c}=await b.from("case_stages").select("etapa").eq("case_id",a).eq("estado","pendiente").order("orden",{ascending:!0}).limit(1).maybeSingle(),d=c?.etapa??null;d&&await b.from("cases").update({etapa_actual:d}).eq("id",a)}(0,c(92714).D)([k,l,m,n,o]),(0,d.A)(k,"4085495ff5376de2d9544dda91281e646ae494c949",null),(0,d.A)(l,"608da5f884100b9fa525729204e6c90fb38047921a",null),(0,d.A)(m,"60ca260422e043e8d031aa4e5ec5aa5cec62c69295",null),(0,d.A)(n,"400967a73b9add91995e0337cec7f66ae699a36c62",null),(0,d.A)(o,"407d6cb4ff2bd39dcaf5f15fa9d0e06606b79d5032",null)}};