"use strict";exports.id=91,exports.ids=[91],exports.modules={7515:(a,b,c)=>{c.d(b,{X:()=>e});var d=c(30724);let e=(0,d.createServerReference)("403ecf2e2e00e98f7491362cb1a475942512f602ba",d.callServer,void 0,d.findSourceMapURL,"uploadDocument")},72895:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(97145).A)("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},88932:(a,b,c)=>{c.d(b,{Nn:()=>p,_L:()=>r,Pe:()=>s,HK:()=>q,lU:()=>o,XX:()=>n});var d=c(61776);c(70958);var e=c(46221),f=c(83273),g=c(60619),h=c(56931),i=c(73771);let j=i.Ik({case_id:i.Yj().uuid("ID de caso inv\xe1lido"),nombre:i.Yj().min(1,"El nombre del archivo es requerido").max(255,"El nombre no puede exceder 255 caracteres"),visibilidad:i.k5(["privado","cliente"]).default("privado"),file:i.bz().optional()}),k=i.Ik({nombre:i.Yj().min(1,"El nombre del archivo es requerido").max(255,"El nombre no puede exceder 255 caracteres").optional(),visibilidad:i.k5(["privado","cliente"]).optional()}),l=i.Ik({case_id:i.Yj().uuid().optional(),visibilidad:i.k5(["privado","cliente"]).optional(),uploader_id:i.Yj().uuid().optional(),tipo_mime:i.Yj().optional(),search:i.Yj().optional(),page:i.ai().min(1).default(1),limit:i.ai().min(1).max(100).default(20)});i.Ik({maxFileSize:i.ai().default(0x1400000),allowedTypes:i.YO(i.Yj()).default(["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","image/jpeg","image/png","image/gif","text/plain"])});let m={"application/pdf":{extension:"pdf",icon:"\uD83D\uDCC4",name:"PDF"},"application/msword":{extension:"doc",icon:"\uD83D\uDCDD",name:"Word"},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{extension:"docx",icon:"\uD83D\uDCDD",name:"Word"},"image/jpeg":{extension:"jpg",icon:"\uD83D\uDDBC️",name:"Imagen"},"image/png":{extension:"png",icon:"\uD83D\uDDBC️",name:"Imagen"},"image/gif":{extension:"gif",icon:"\uD83D\uDDBC️",name:"Imagen"},"text/plain":{extension:"txt",icon:"\uD83D\uDCC4",name:"Texto"}};async function n(a){try{let b=await (0,g.oC)(),c=a.get("case_id"),d=a.get("nombre"),i=a.get("visibilidad"),k=a.get("file");if(!k)throw Error("No se ha seleccionado ning\xfan archivo");let l=j.parse({case_id:c,nombre:d&&d.trim()||k.name,visibilidad:i||"privado"});if(!await (0,g.Nf)(l.case_id))throw Error("Sin permisos para acceder a este caso");if(k.size>0x1400000)throw Error(`El archivo es demasiado grande. M\xe1ximo ${Math.floor(20)}MB`);if(!Object.prototype.hasOwnProperty.call(m,k.type))throw Error("Tipo de archivo no permitido");let n=await (0,f.r)(),o=k.name.includes(".")?k.name.split(".").pop():"",p=Math.random().toString(36).slice(2,9),q=`${Date.now()}-${p}${o?"."+o:""}`,r=`cases/${l.case_id}/${q}`,{error:s}=await n.storage.from("documents").upload(r,k,{cacheControl:"3600",upsert:!1});if(s)throw console.error("Error uploading file:",s),Error("Error al subir el archivo");let{data:t}=n.storage.from("documents").getPublicUrl(r),u={case_id:l.case_id,uploader_id:b.id,nombre:l.nombre,tipo_mime:k.type,size_bytes:k.size,url:t.publicUrl,visibilidad:l.visibilidad},{data:v,error:w}=await n.from("documents").insert(u).select(`
        *,
        uploader:profiles(nombre),
        case:cases(caratulado)
      `).single();if(w)throw console.error("Error saving document metadata:",w),await n.storage.from("documents").remove([r]).catch(()=>{}),Error("Error al guardar los metadatos del documento");return await (0,h.UU)({action:"UPLOAD",entity_type:"document",entity_id:v.id,diff_json:{uploaded:u}}),(0,e.revalidatePath)(`/cases/${l.case_id}`),{success:!0,document:v}}catch(a){return console.error("Error in uploadDocument:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function o(a,b){try{let c=await (0,g.oC)(),d=k.parse(b),i=await (0,f.R)(),{data:j,error:l}=await i.from("documents").select("*").eq("id",a).single();if(l||!j)throw Error("Documento no encontrado");if("admin_firma"!==c.role&&j.uploader_id!==c.id)if("abogado"===c.role){if(!await (0,g.Nf)(j.case_id))throw Error("Sin permisos para editar este documento")}else throw Error("Sin permisos para editar este documento");let m={...void 0!==d.nombre&&{nombre:d.nombre},...void 0!==d.visibilidad&&{visibilidad:d.visibilidad}},{data:n,error:o}=await i.from("documents").update(m).eq("id",a).select(`
        *,
        uploader:profiles(nombre),
        case:cases(caratulado)
      `).single();if(o)throw console.error("Error updating document:",o),Error("Error al actualizar el documento");return await (0,h.UU)({action:"UPDATE",entity_type:"document",entity_id:a,diff_json:{from:j,to:n}}),(0,e.revalidatePath)(`/cases/${j.case_id}`),{success:!0,document:n}}catch(a){return console.error("Error in updateDocument:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function p(a){try{let b=await (0,g.oC)(),c=await (0,f.r)(),{data:d,error:i}=await c.from("documents").select("*").eq("id",a).single();if(i||!d)throw Error("Documento no encontrado");if("admin_firma"!==b.role&&d.uploader_id!==b.id)if("abogado"===b.role){if(!await (0,g.Nf)(d.case_id))throw Error("Sin permisos para eliminar este documento")}else throw Error("Sin permisos para eliminar este documento");let j=d.url.split("/").slice(-2).join("/"),{error:k}=await c.storage.from("documents").remove([j]);k&&console.error("Error deleting file from storage:",k);let{error:l}=await c.from("documents").delete().eq("id",a);if(l)throw console.error("Error deleting document metadata:",l),Error("Error al eliminar el documento");return await (0,h.UU)({action:"DELETE",entity_type:"document",entity_id:a,diff_json:{deleted:d}}),(0,e.revalidatePath)(`/cases/${d.case_id}`),{success:!0}}catch(a){return console.error("Error in deleteDocument:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function q(a={}){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c={...a??{}};null==c.page&&(c.page=1),null==c.limit&&(c.limit=10);let d=l.parse(c),e=await (0,f.R)(),h=e.from("documents").select(`
        *,
        uploader:profiles(id, nombre),
        case:cases(id, caratulado)
      `,{count:"exact"});if("cliente"===b.role){h=h.eq("visibilidad","cliente");let{data:a}=await e.from("case_clients").select("case_id").eq("client_profile_id",b.id),c=a?.map(a=>a.case_id)||[];if(0===c.length)return{success:!0,documents:[],total:0,page:d.page,limit:d.limit};h=h.in("case_id",c)}else if("abogado"===b.role){let{data:a}=await e.from("cases").select("id").eq("abogado_responsable",b.id),c=a?.map(a=>a.id)||[];if(0===c.length)return{success:!0,documents:[],total:0,page:d.page,limit:d.limit};h=h.in("case_id",c)}if(d.case_id){if(!await (0,g.Nf)(d.case_id))throw Error("Sin permisos para acceder a este caso");h=h.eq("case_id",d.case_id)}d.visibilidad&&(h=h.eq("visibilidad",d.visibilidad)),d.uploader_id&&(h=h.eq("uploader_id",d.uploader_id)),d.tipo_mime&&(h=h.eq("tipo_mime",d.tipo_mime)),d.search&&(h=h.ilike("nombre",`%${d.search}%`));let i=(d.page-1)*d.limit,j=i+d.limit-1,{data:k,error:m,count:n}=await h.range(i,j).order("created_at",{ascending:!1});if(m)throw console.error("Error fetching documents:",m),Error("Error al obtener documentos");return{success:!0,documents:k||[],total:n||0,page:d.page,limit:d.limit}}catch(a){return console.error("Error in getDocuments:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido",documents:[],total:0}}}async function r(a){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c=await (0,f.R)(),{data:d,error:e}=await c.from("documents").select(`
        *,
        uploader:profiles(id, nombre),
        case:cases(id, caratulado)
      `).eq("id",a).single();if(e||!d)throw Error("Documento no encontrado");if(!await (0,g.Nf)(d.case_id)||"cliente"===b.role&&"privado"===d.visibilidad)throw Error("Sin permisos para ver este documento");return{success:!0,document:d}}catch(a){return console.error("Error in getDocumentById:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function s(a){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c=await (0,f.r)(),{data:d,error:e}=await c.from("documents").select("*").eq("id",a).single();if(e||!d)throw Error("Documento no encontrado");if(!await (0,g.Nf)(d.case_id)||"cliente"===b.role&&"privado"===d.visibilidad)throw Error("Sin permisos para descargar este documento");let i=d.url.split("/").slice(-2).join("/"),{data:j,error:k}=await c.storage.from("documents").createSignedUrl(i,3600);if(k)throw console.error("Error creating signed URL:",k),Error("Error al generar URL de descarga");return await (0,h.UU)({action:"DOWNLOAD",entity_type:"document",entity_id:a,diff_json:{downloaded:!0}}),{success:!0,url:j.signedUrl}}catch(a){return console.error("Error in getDocumentDownloadUrl:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}(0,c(92714).D)([n,o,p,q,r,s]),(0,d.A)(n,"403ecf2e2e00e98f7491362cb1a475942512f602ba",null),(0,d.A)(o,"609d6fde2046d1536a173ef6460e6019ebe636596d",null),(0,d.A)(p,"406044a123b8b7a5866f2f5f01cf370cbf6075392d",null),(0,d.A)(q,"401c3e5e9fb1d5c2bc713922df9b49cc9506e4102a",null),(0,d.A)(r,"40adc97247bf2b32d93f7520a19d3bef406f283602",null),(0,d.A)(s,"4042a9d932eaf5c250a1d37041a85d12b5ce6080a7",null)},98558:(a,b,c)=>{c.d(b,{T:()=>g});var d=c(59356),e=c(56389),f=c(16815);let g=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("textarea",{ref:c,className:(0,f.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",a),...b}));g.displayName="Textarea"}};