"use strict";exports.id=458,exports.ids=[458],exports.modules={44541:(a,b,c)=>{c.r(b),c.d(b,{"4005ee7254afb4611af8875139dc5a2557d207248f":()=>x,"401aaaf800a1f16c132dde5f9588ffbaf9da69a52b":()=>D,"404b793976c20ab1ffc9192a82ee384237a7650d01":()=>y,"404bc83d9a543e611258759390787c7cb6576f1ced":()=>C,"40d60bf749a6aea141d6303248fc1697421893fdfd":()=>A,"40f83224155e3423d55a4c895d3546a01ab48df807":()=>B,"600ae10f5197efbf0d781e426ef0c63665a14b6095":()=>z});var d=c(61776);c(70958);var e=c(46221),f=c(83273),g=c(60619),h=c(56931),i=c(73771),j=c(88852);let k=i.Yj().optional().refine(function(a){if("string"!=typeof a||0===a.trim().length)return!0;let b=a.replace(/[^0-9kK]/g,"");if(b.length<8||b.length>9)return!1;let c=b.slice(0,-1),d=b.slice(-1).toUpperCase(),e=0,f=2;for(let a=c.length-1;a>=0;a--)e+=parseInt(c[a],10)*f,f=7===f?2:f+1;let g=11-e%11;return d===(11===g?"0":10===g?"K":String(g))},{message:"RUT inv\xe1lido"}),l=i.Ik({numero_causa:i.Yj().optional(),caratulado:i.Yj().min(1,"El caratulado es requerido").max(500,"El caratulado no puede exceder 500 caracteres"),materia:i.Yj().min(1,"La materia es requerida").max(100,"La materia no puede exceder 100 caracteres"),tribunal:i.Yj().optional(),region:i.Yj().optional(),comuna:i.Yj().optional(),rut_cliente:k,nombre_cliente:i.Yj().min(1,"El nombre del cliente es requerido").max(200,"El nombre no puede exceder 200 caracteres"),contraparte:i.Yj().optional(),etapa_actual:i.Yj().default("Ingreso Demanda"),estado:i.k5(["activo","suspendido","archivado","terminado"]).default("activo"),fecha_inicio:i.Yj().optional(),abogado_responsable:i.Yj().uuid("ID de abogado inv\xe1lido").optional(),analista_id:i.Yj().uuid("ID de analista inv\xe1lido").optional(),cliente_principal_id:i.Yj().uuid("ID de cliente inv\xe1lido").optional(),workflow_state:i.k5(["preparacion","en_revision","activo","cerrado"]).default("preparacion"),prioridad:i.k5(["baja","media","alta","urgente"]).default("media"),valor_estimado:i.ai().positive("El valor debe ser positivo").optional(),observaciones:i.Yj().optional(),descripcion_inicial:i.Yj().min(20,"Describe el contexto del caso con al menos 20 caracteres").max(2e3,"La descripci\xf3n inicial no puede exceder 2000 caracteres"),objetivo_cliente:i.Yj().max(1e3,"El objetivo del cliente no puede exceder 1000 caracteres").optional(),documentacion_recibida:i.Yj().max(2e3,"El listado de documentaci\xf3n no puede exceder 2000 caracteres").optional(),validado_at:i.Yj().optional().nullable(),marcar_validado:i.zM().optional()});function m(a,b){a.marcar_validado&&(a.abogado_responsable||b.addIssue({code:j.eq.custom,message:"Debes asignar un abogado responsable para validar el caso",path:["abogado_responsable"]}),a.cliente_principal_id||b.addIssue({code:j.eq.custom,message:"Debes vincular al menos un cliente principal para validar el caso",path:["cliente_principal_id"]}))}let n=l.superRefine((a,b)=>{m(a,b)}),o=l.partial().superRefine((a,b)=>{m(a,b)}),p=i.Ik({brief:i.Yj().min(10,"El brief debe tener al menos 10 caracteres").max(2e3,"El brief no puede exceder 2000 caracteres"),overrides:l.partial().optional()}),q=i.Ik({case_id:i.Yj().uuid("ID de caso inv\xe1lido"),abogado_id:i.Yj().uuid("ID de abogado inv\xe1lido")}),r=i.Ik({estado:i.k5(["activo","suspendido","archivado","terminado"]).optional(),prioridad:i.k5(["baja","media","alta","urgente"]).optional(),abogado_responsable:i.Yj().uuid().optional(),materia:i.Yj().optional(),fecha_inicio_desde:i.Yj().optional(),fecha_inicio_hasta:i.Yj().optional(),search:i.Yj().optional(),page:i.ai().min(1).default(1),limit:i.ai().min(1).max(100).default(10)});i.Ik({abogado_id:i.Yj().uuid().optional(),fecha_desde:i.Yj().optional(),fecha_hasta:i.Yj().optional()});var s=c(23024),t=c(92714);async function u(){return process.env.SUPABASE_SERVICE_KEY?(0,f.r)():(0,f.R)()}let v="preparacion";function w(a){return"string"==typeof a&&["activo","preparacion","en_revision","cerrado"].includes(a)?a:v}async function x(a){try{let b=await (0,g.oC)(["abogado","analista"]),{marcar_validado:c,...d}=n.parse(a),f=await u(),i=new Date().toISOString(),j={caratulado:d.caratulado,nombre_cliente:d.nombre_cliente,numero_causa:d.numero_causa??null,materia:d.materia??null,tribunal:d.tribunal??null,region:d.region??null,comuna:d.comuna??null,rut_cliente:d.rut_cliente??null,contraparte:d.contraparte??null,etapa_actual:d.etapa_actual??null,fecha_inicio:d.fecha_inicio??null,abogado_responsable:d.abogado_responsable??("abogado"===b.role?b.id:null),estado:d.estado??"activo",workflow_state:w(d.workflow_state??(c?"en_revision":"preparacion")),prioridad:d.prioridad??"media",valor_estimado:d.valor_estimado??null,observaciones:d.observaciones??null,cliente_principal_id:d.cliente_principal_id??null,descripcion_inicial:d.descripcion_inicial??null,documentacion_recibida:d.documentacion_recibida??null,objetivo_cliente:d.objetivo_cliente??null,created_at:i,updated_at:i,validado_at:c?d.validado_at??i:null},{data:k,error:l}=await f.from("cases").insert(j).select().single();if(l)throw l;return await E(k.id,j.cliente_principal_id),await F(k),await (0,h.UU)({action:"CREATE",entity_type:"case",entity_id:k.id,diff_json:{created:j}}),(0,e.revalidatePath)("/cases"),(0,e.revalidatePath)("/dashboard"),{success:!0,case:k}}catch(a){return console.error("Error in createCase:",a),{success:!1,error:a.message}}}async function y(a){try{let b=await (0,g.oC)("abogado"),c=p.parse(a),d=await G(c.brief),e=function(a){if(!a)return{};let b={};for(let[c,d]of Object.entries(a))void 0!==d&&(b[c]=d);return b}(c.overrides),f={caratulado:d.caratulado??"Caso generado desde brief",nombre_cliente:d.nombre_cliente??"Cliente por definir",materia:d.materia??"Civil",etapa_actual:d.etapa_actual??"Ingreso Demanda",estado:d.estado??"activo",workflow_state:w(d.workflow_state??v),prioridad:d.prioridad??"media",numero_causa:d.numero_causa??void 0,tribunal:d.tribunal??void 0,region:d.region??void 0,comuna:d.comuna??void 0,contraparte:d.contraparte??void 0,descripcion_inicial:d.descripcion_inicial??"Caso creado desde brief.",documentacion_recibida:d.documentacion_recibida??void 0,objetivo_cliente:d.objetivo_cliente??void 0,observaciones:d.observaciones??`Caso creado desde brief:

${c.brief}`,valor_estimado:d.valor_estimado??void 0,rut_cliente:d.rut_cliente??void 0,cliente_principal_id:d.cliente_principal_id??void 0,fecha_inicio:d.fecha_inicio??void 0,abogado_responsable:b.id},h={...f,...e,workflow_state:w(e?.workflow_state??f.workflow_state),caratulado:e?.caratulado??f.caratulado,nombre_cliente:e?.nombre_cliente??f.nombre_cliente,materia:e?.materia??f.materia,etapa_actual:e?.etapa_actual??f.etapa_actual,estado:e?.estado??f.estado,prioridad:e?.prioridad??f.prioridad,descripcion_inicial:e?.descripcion_inicial??f.descripcion_inicial??""};return await x(h)}catch(a){return console.error("Error in createCaseFromBrief:",a),{success:!1,error:a.message}}}async function z(a,b){try{let c=await (0,g.oC)(),{marcar_validado:d,...f}=o.parse(b),i=await u(),{data:j,error:k}=await i.from("cases").select("*").eq("id",a).single();if(k||!j)throw Error("Caso no encontrado");let l="admin_firma"===c.role,m="abogado"===c.role&&j.abogado_responsable===c.id,n="analista"===c.role&&j.analista_id===c.id;if(!l&&!m&&!n)throw Error("Sin permisos para editar este caso");if(n&&"cerrado"===j.workflow_state)throw Error("El caso ya fue cerrado");let p=new Date().toISOString(),q={updated_at:p,...void 0!==f.caratulado&&{caratulado:f.caratulado},...void 0!==f.nombre_cliente&&{nombre_cliente:f.nombre_cliente},...void 0!==f.materia&&{materia:f.materia},...void 0!==f.etapa_actual&&{etapa_actual:f.etapa_actual},...void 0!==f.fecha_inicio&&{fecha_inicio:f.fecha_inicio},...void 0!==f.numero_causa&&{numero_causa:f.numero_causa},...void 0!==f.tribunal&&{tribunal:f.tribunal},...void 0!==f.region&&{region:f.region},...void 0!==f.comuna&&{comuna:f.comuna},...void 0!==f.contraparte&&{contraparte:f.contraparte},...void 0!==f.descripcion_inicial&&{descripcion_inicial:f.descripcion_inicial},...void 0!==f.documentacion_recibida&&{documentacion_recibida:f.documentacion_recibida},...void 0!==f.objetivo_cliente&&{objetivo_cliente:f.objetivo_cliente},...void 0!==f.observaciones&&{observaciones:f.observaciones},...void 0!==f.valor_estimado&&{valor_estimado:f.valor_estimado??null},...void 0!==f.rut_cliente&&{rut_cliente:f.rut_cliente},...void 0!==f.cliente_principal_id&&{cliente_principal_id:f.cliente_principal_id??null},...void 0!==f.abogado_responsable&&{abogado_responsable:f.abogado_responsable??null},...void 0!==f.analista_id&&{analista_id:f.analista_id??null}};void 0!==f.estado&&(q.estado=f.estado),void 0!==f.prioridad&&(q.prioridad=f.prioridad),void 0!==f.workflow_state&&(q.workflow_state=w(f.workflow_state)),void 0!==d&&(q.validado_at=d?f.validado_at??j.validado_at??p:null,void 0===f.workflow_state&&(q.workflow_state=d?"cerrado"===j.workflow_state?"cerrado":"en_revision":"preparacion")),n&&!j.analista_id&&(q.analista_id=c.id);let{data:r,error:s}=await i.from("cases").update(q).eq("id",a).select().single();if(s)throw s;return await E(a,f.cliente_principal_id??void 0),await (0,h.UU)({action:"UPDATE",entity_type:"case",entity_id:a,diff_json:{from:j,to:r}}),(0,e.revalidatePath)(`/cases/${a}`),(0,e.revalidatePath)("/cases"),(0,e.revalidatePath)("/dashboard"),{success:!0,case:r}}catch(a){return console.error("Error in updateCase:",a),{success:!1,error:a.message}}}async function A(a){try{await (0,g.oC)("admin_firma");let b=q.parse(a),c=await u(),{data:d,error:f}=await c.from("cases").update({abogado_responsable:b.abogado_id}).eq("id",b.case_id).select().single();if(f)throw f;return await (0,h.UU)({action:"ASSIGN_LAWYER",entity_type:"case",entity_id:b.case_id,diff_json:{abogado_responsable:b.abogado_id}}),(0,e.revalidatePath)(`/cases/${b.case_id}`),(0,e.revalidatePath)("/cases"),(0,e.revalidatePath)("/dashboard"),{success:!0,case:d}}catch(a){return console.error("Error in assignLawyer:",a),{success:!1,error:a.message}}}async function B(a){try{await (0,g.oC)("admin_firma");let b=await u(),{error:c}=await b.from("cases").delete().eq("id",a);if(c)throw c;return await (0,h.UU)({action:"DELETE",entity_type:"case",entity_id:a,diff_json:{deleted:!0}}),(0,e.revalidatePath)("/cases"),(0,e.revalidatePath)("/dashboard"),{success:!0}}catch(a){return console.error("Error in deleteCase:",a),{success:!1,error:a.message}}}async function C(a={}){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c={...a??{}};null==c.page&&(c.page=1),null==c.limit&&(c.limit=10);let d=r.parse(c),e=await u(),f=e.from("cases").select(`
        *,
        abogado_responsable:profiles!cases_abogado_responsable_fkey(id, nombre),
        case_stages(id, etapa, estado, fecha_programada, orden)
      `,{count:"exact"});if("abogado"===b.role)f=f.eq("abogado_responsable",b.id);else if("analista"===b.role)f=f.eq("analista_id",b.id);else if("cliente"===b.role){let{data:a}=await e.from("case_clients").select("case_id").eq("client_profile_id",b.id),c=a?.map(a=>a.case_id)??[];if(0===c.length)return{success:!0,cases:[],total:0,page:d.page,limit:d.limit};f=f.in("id",c)}if(d.estado&&(f=f.eq("estado",d.estado)),d.prioridad&&(f=f.eq("prioridad",d.prioridad)),d.abogado_responsable&&(f=f.eq("abogado_responsable",d.abogado_responsable)),d.materia&&(f=f.eq("materia",d.materia)),d.fecha_inicio_desde&&(f=f.gte("fecha_inicio",d.fecha_inicio_desde)),d.fecha_inicio_hasta&&(f=f.lte("fecha_inicio",d.fecha_inicio_hasta)),d.search){let a=d.search;f=f.or(`caratulado.ilike.%${a}%,nombre_cliente.ilike.%${a}%,numero_causa.ilike.%${a}%`)}let h=(d.page-1)*d.limit,i=h+d.limit-1,{data:j,error:k,count:l}=await f.range(h,i).order("created_at",{ascending:!1});if(k)throw k;return{success:!0,cases:j??[],total:l??0,page:d.page,limit:d.limit}}catch(a){return console.error("Error in getCases:",a),{success:!1,error:a.message,cases:[],total:0}}}async function D(a){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c=await u(),{data:d,error:e}=await c.from("cases").select("*").eq("id",a).single();if(e||!d)throw Error("Caso no encontrado");if("cliente"===b.role){let{data:d}=await c.from("case_clients").select("id").eq("case_id",a).eq("client_profile_id",b.id).maybeSingle();if(!d)throw Error("Sin permisos para ver este caso")}if("abogado"===b.role&&d.abogado_responsable&&d.abogado_responsable!==b.id||"analista"===b.role&&d.analista_id&&d.analista_id!==b.id)throw Error("Sin permisos para ver este caso");let[f,h,i,j,k]=await Promise.all([(async()=>{if(!d.abogado_responsable)return null;let{data:b,error:e}=await c.from("profiles").select("id, nombre, telefono, rut").eq("id",d.abogado_responsable).maybeSingle();return e?(console.error("Error fetching lawyer profile",a,e.message),null):b})(),c.from("case_stages").select("*, responsable:profiles(id, nombre)").eq("case_id",a).order("orden",{ascending:!0}),c.from("notes").select("*, author:profiles(id, nombre)").eq("case_id",a).order("created_at",{ascending:!1}),c.from("documents").select("*, uploader:profiles(id, nombre)").eq("case_id",a).order("created_at",{ascending:!1}),c.from("info_requests").select("*, creador:profiles(id, nombre)").eq("case_id",a).order("created_at",{ascending:!1})]),l={...d,abogado_responsable_id:d.abogado_responsable,abogado_responsable:f?{id:f.id,nombre:f.nombre,telefono:f.telefono,rut:f.rut}:null,case_stages:h?.data??[],notes:i?.data??[],documents:j?.data??[],info_requests:k?.data??[]};return{success:!0,case:l}}catch(a){return console.error("Error in getCaseById:",a),{success:!1,error:a.message}}}async function E(a,b){if(b)try{let c=await u();await c.from("case_clients").upsert([{case_id:a,client_profile_id:b}],{onConflict:"case_id,client_profile_id"})}catch(a){console.error("Error vinculando cliente principal al caso:",a)}}async function F(a){let b=await u(),c=(0,s.CT)(a.materia||"Civil"),d=a.fecha_inicio?new Date(a.fecha_inicio):new Date,e=0,f=c.map((b,c)=>{e+=b.diasEstimados;let f=new Date(d.getTime());f.setDate(f.getDate()+e);let g=f.toISOString().split("T")[0];return{case_id:a.id,etapa:b.etapa,descripcion:b.descripcion??null,estado:"pendiente",orden:c+1,es_publica:b.esPublica??!0,fecha_programada:g??null,fecha_cumplida:null,responsable_id:null}});0!==f.length&&await b.from("case_stages").insert(f)}async function G(a){let b={};for(let c of a.toLowerCase().split("\n")){if(c.includes("caratulado")||c.includes("caso")||c.includes("demanda")){let a=c.match(/(?:caratulado|caso|demanda)[:\s]+(.+)/),d=a?.[1]?.trim();d&&(b.caratulado=d)}if(c.includes("cliente")||c.includes("demandante")){let a=c.match(/(?:cliente|demandante)[:\s]+(.+)/),d=a?.[1]?.trim();d&&(b.nombre_cliente=d)}c.includes("laboral")&&(b.materia="Laboral"),c.includes("civil")&&(b.materia="Civil"),c.includes("comercial")&&(b.materia="Comercial"),c.includes("penal")&&(b.materia="Penal"),c.includes("familia")&&(b.materia="Familia"),c.includes("urgente")&&(b.prioridad="urgente"),c.includes("alta prioridad")&&(b.prioridad="alta"),c.includes("baja prioridad")&&(b.prioridad="baja")}return b.observaciones=b.observaciones??`Caso creado desde brief:

${a}`,b}(0,t.D)([x,y,z,A,B,C,D]),(0,d.A)(x,"4005ee7254afb4611af8875139dc5a2557d207248f",null),(0,d.A)(y,"404b793976c20ab1ffc9192a82ee384237a7650d01",null),(0,d.A)(z,"600ae10f5197efbf0d781e426ef0c63665a14b6095",null),(0,d.A)(A,"40d60bf749a6aea141d6303248fc1697421893fdfd",null),(0,d.A)(B,"40f83224155e3423d55a4c895d3546a01ab48df807",null),(0,d.A)(C,"404bc83d9a543e611258759390787c7cb6576f1ced",null),(0,d.A)(D,"401aaaf800a1f16c132dde5f9588ffbaf9da69a52b",null)},51134:(a,b,c)=>{c.d(b,{p:()=>g});var d=c(59356),e=c(56389),f=c(16815);let g=e.forwardRef(({className:a,type:b,...c},e)=>(0,d.jsx)("input",{type:b,className:(0,f.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),ref:e,...c}));g.displayName="Input"}};