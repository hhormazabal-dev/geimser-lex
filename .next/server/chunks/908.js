"use strict";exports.id=908,exports.ids=[908],exports.modules={25908:(a,b,c)=>{c.d(b,{Fc:()=>n,JN:()=>l,Pj:()=>p,Y2:()=>q,md:()=>r,w1:()=>m,wx:()=>k,xf:()=>o});var d=c(19703);c(71977);var e=c(15352),f=c(47550),g=c(42981);let h=a=>(a??"").trim().toLowerCase(),i=a=>["admin_firma","abogado","analista"].includes(a),j={totalCases:0,activeCases:0,completedCases:0,totalClients:0,totalDocuments:0,totalNotes:0,pendingRequests:0,overdueStages:0};async function k(){try{let a=await (0,f.oC)(),b=h(a.role);if(!i(b))return console.warn("⚠️ Rol sin permisos (getDashboardStats):",a.role),{success:!0,stats:{...j},highlights:{recentCases:[],clients:[],documents:[],pending:[]}};let c=await (0,e.R)(),d=c.from("cases").select("*"),g=(async()=>{if("abogado"===b){let{data:b,error:d}=await c.from("cases").select("id").eq("abogado_responsable",a.id);if(d)return{data:null,error:d};let e=b?.map(a=>a.id)||[];if(0===e.length)return{data:[],error:null};let{data:f,error:g}=await c.from("case_clients").select("client_profile_id").in("case_id",e);if(g)return{data:null,error:g};let h=f?.map(a=>a.client_profile_id)||[];return 0===h.length?{data:[],error:null}:c.from("profiles").select("*").in("id",h)}return c.from("profiles").select("*").eq("role","cliente")})();"abogado"===b&&(d=d.eq("abogado_responsable",a.id));let[k,l,m,n,o,p]=await Promise.all([d,g,c.from("documents").select("*"),c.from("notes").select("*"),c.from("info_requests").select("*").eq("estado","pendiente"),c.from("case_stages").select("*").eq("estado","pendiente").lt("fecha_programada",new Date().toISOString())]);if(k.error)throw k.error;if(l.error)throw l.error;if(m.error)throw m.error;if(n.error)throw n.error;if(o.error)throw o.error;if(p.error)throw p.error;let q=k.data??[],r=q.filter(a=>"activo"===a.estado).length,s=q.filter(a=>"terminado"===a.estado).length,t={totalCases:q.length,activeCases:r,completedCases:s,totalClients:l.data?.length||0,totalDocuments:m.data?.length||0,totalNotes:n.data?.length||0,pendingRequests:o.data?.length||0,overdueStages:p.data?.length||0},u={recentCases:q.sort((a,b)=>new Date(b.updated_at??b.created_at??"").getTime()-new Date(a.updated_at??a.created_at??"").getTime()).slice(0,6).map(a=>({id:a.id,caratulado:a.caratulado??"Sin caratulado",estado:a.estado??null,prioridad:a.prioridad??null,fecha_inicio:a.fecha_inicio??null,abogado_responsable:a.abogado_responsable??null,valor_estimado:a.valor_estimado??null})),clients:(l.data??[]).slice(0,6).map(a=>({id:a.id,nombre:a.nombre??null,email:a.email??null,telefono:a.telefono??null,created_at:a.created_at??null})),documents:(m.data??[]).sort((a,b)=>new Date(b.created_at??"").getTime()-new Date(a.created_at??"").getTime()).slice(0,6).map(a=>({id:a.id,nombre:a.nombre??"Documento",case_id:a.case_id??null,created_at:a.created_at??null})),pending:[...(o.data??[]).map(a=>({id:a.id,tipo:"solicitud",titulo:a.titulo??"Solicitud",descripcion:a.descripcion??null,fecha:a.fecha_limite??null,case_id:a.case_id??null,estado:a.estado??null})),...(p.data??[]).map(a=>({id:a.id,tipo:"etapa",titulo:a.etapa??"Etapa",descripcion:null,fecha:a.fecha_programada??null,case_id:a.case_id??null,estado:a.estado??null}))].slice(0,8)};return{success:!0,stats:t,highlights:u}}catch(a){return console.error("Error getting dashboard stats:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function l(){try{let a=await (0,f.oC)(),b=h(a.role);if(!i(b))return console.warn("⚠️ Rol sin permisos (getCasesByStatus):",a.role),{success:!0,data:[]};let c=(await (0,e.R)()).from("cases").select("estado");"abogado"===b&&(c=c.eq("abogado_responsable",a.id));let{data:d,error:g}=await c;if(g)throw g;let j=d??[],k=j.reduce((a,b)=>{let c=b.estado||"sin_estado";return a[c]=(a[c]||0)+1,a},{}),l=j.length,m=Object.entries(k).map(([a,b])=>({status:a,count:b,percentage:l>0?Math.round(b/l*100):0}));return{success:!0,data:m}}catch(a){return console.error("Error getting cases by status:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function m(){try{let a=await (0,f.oC)(),b=h(a.role);if(!i(b))return console.warn("⚠️ Rol sin permisos (getCasesByMateria):",a.role),{success:!0,data:[]};let c=(await (0,e.R)()).from("cases").select("materia");"abogado"===b&&(c=c.eq("abogado_responsable",a.id));let{data:d,error:g}=await c;if(g)throw g;let j=d??[],k=j.reduce((a,b)=>{let c=b.materia||"Sin especificar";return a[c]=(a[c]||0)+1,a},{}),l=j.length,m=Object.entries(k).map(([a,b])=>({materia:a,count:b,percentage:l>0?Math.round(b/l*100):0}));return{success:!0,data:m}}catch(a){return console.error("Error getting cases by materia:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function n(){try{let a=await (0,f.oC)(),b=h(a.role);if(!i(b))return console.warn("⚠️ Rol sin permisos (getCasesByPriority):",a.role),{success:!0,data:[]};let c=(await (0,e.R)()).from("cases").select("prioridad");"abogado"===b&&(c=c.eq("abogado_responsable",a.id));let{data:d,error:g}=await c;if(g)throw g;let j=d??[],k=j.reduce((a,b)=>{let c=b.prioridad||"media";return a[c]=(a[c]||0)+1,a},{}),l=j.length,m=Object.entries(k).map(([a,b])=>({priority:a,count:b,percentage:l>0?Math.round(b/l*100):0}));return{success:!0,data:m}}catch(a){return console.error("Error getting cases by priority:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function o(){try{let a=await (0,f.oC)(),b=h(a.role);if(!i(b)){console.warn("⚠️ Rol sin permisos (getMonthlyStats):",a.role);let b=Array.from({length:12}).map((a,b)=>{let c=new Date;return c.setMonth(c.getMonth()-(11-b)),{month:c.toLocaleDateString("es-CL",{year:"numeric",month:"short"}),newCases:0,completedCases:0,revenue:0}});return{success:!0,data:b}}let c=await (0,e.R)(),d=new Date;d.setMonth(d.getMonth()-11),d.setDate(1);let g=c.from("cases").select("fecha_inicio, valor_estimado").gte("fecha_inicio",d.toISOString()),j=c.from("cases").select("updated_at, valor_estimado").eq("estado","terminado").gte("updated_at",d.toISOString());"abogado"===b&&(g=g.eq("abogado_responsable",a.id),j=j.eq("abogado_responsable",a.id));let[k,l]=await Promise.all([g,j]);if(k.error)throw k.error;if(l.error)throw l.error;let m=k.data??[],n=l.data??[],o={};for(let a=0;a<12;a++){let b=new Date;b.setMonth(b.getMonth()-a);let c=b.toISOString().slice(0,7),d=b.toLocaleDateString("es-CL",{year:"numeric",month:"short"});o[c]={month:d,newCases:0,completedCases:0,revenue:0}}m.forEach(a=>{let b=a.fecha_inicio;if(b){let a=b.slice(0,7);o[a]&&o[a].newCases++}}),n.forEach(a=>{let b=a.updated_at,c=a.valor_estimado;if(b){let a=b.slice(0,7);o[a]&&(o[a].completedCases++,o[a].revenue+=c||0)}});let p=Object.values(o).reverse();return{success:!0,data:p}}catch(a){return console.error("Error getting monthly stats:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function p(){try{let a=await (0,f.oC)(),b=h(a.role);if("admin_firma"!==b)return console.warn("⚠️ Rol sin permisos (getAbogadoWorkload):",a.role),{success:!0,data:[]};let c=await (0,e.R)(),{data:d,error:g}=await c.from("profiles").select("id, nombre").in("role",["abogado","admin_firma"]);if(g)throw g;let i=(d??[]).map(async a=>{let[b,d]=await Promise.all([c.from("cases").select("valor_estimado").eq("abogado_responsable",a.id).eq("estado","activo"),c.from("cases").select("valor_estimado").eq("abogado_responsable",a.id).eq("estado","terminado")]),e=b.data??[],f=d.data??[],g=[...e,...f].reduce((a,b)=>a+(b.valor_estimado??0),0),h=e.length+f.length;return{abogado_id:a.id,nombre:a.nombre??"Sin nombre",activeCases:e.length,completedCases:f.length,totalValue:g,avgCaseValue:h>0?g/h:0}}),j=await Promise.all(i);return{success:!0,data:j}}catch(a){return console.error("Error getting abogado workload:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function q(a){try{let b=await (0,f.oC)(),c=h(b.role);if("admin_firma"!==c)return{success:!1,error:"Sin permisos para ver esta informaci\xf3n"};let d=await (0,e.R)(),{data:g,error:i}=await d.from("profiles").select("id, nombre, email, telefono, role").eq("id",a).single();if(i||!g)return{success:!1,error:"Abogado no encontrado"};let{data:j,error:k}=await d.from("cases").select("id, caratulado, estado, etapa_actual, prioridad, valor_estimado, fecha_inicio, workflow_state, nombre_cliente, updated_at").eq("abogado_responsable",a).order("created_at",{ascending:!1});if(k)throw k;let l=j??[],m=l.map(a=>a.id),n=new Map;if(m.length>0){let{data:a,error:b}=await d.from("case_stages").select("case_id, etapa, estado, fecha_programada, orden").in("case_id",m).order("orden",{ascending:!0});if(b)throw b;n=(a??[]).reduce((a,b)=>{let c=a.get(b.case_id)??[];return c.push(b),a.set(b.case_id,c),a},new Map)}let o=new Date().toISOString().slice(0,10),p=l.map(a=>{let b=n.get(a.id)??[],c=b.filter(a=>"completado"===a.estado),d=b.filter(a=>"completado"!==a.estado),e=d.length>0?d[0]:null,f=d.filter(a=>!!a.fecha_programada&&a.fecha_programada<o).length;return{id:a.id,caratulado:a.caratulado,estado:a.estado??null,etapa_actual:a.etapa_actual??null,prioridad:a.prioridad??null,valor_estimado:a.valor_estimado??null,fecha_inicio:a.fecha_inicio??null,workflow_state:a.workflow_state??null,nombre_cliente:a.nombre_cliente??null,nextStage:e?{etapa:e.etapa,fecha_programada:e.fecha_programada??null,estado:e.estado??"pendiente",orden:e.orden??null,isOverdue:!!e.fecha_programada&&e.fecha_programada<o}:null,pendingStages:d.length,completedStages:c.length,totalStages:b.length,overdueStages:f}}),q=p.filter(a=>"activo"===a.estado),r=p.filter(a=>"terminado"===a.estado),s=p.reduce((a,b)=>a+(b.valor_estimado??0),0),t=p.length,u=p.reduce((a,b)=>a+b.overdueStages,0);return{success:!0,data:{lawyer:{id:g.id,nombre:g.nombre??"Sin nombre",email:g.email??null,telefono:g.telefono??null,role:g.role??null},stats:{activeCases:q.length,completedCases:r.length,totalCases:t,totalValue:s,avgCaseValue:t>0?s/t:0,overdueStages:u},cases:p}}}catch(a){return console.error("Error getting lawyer detail:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}async function r(){try{let a=await (0,f.oC)(),b=h(a.role);if(!i(b))return console.warn("⚠️ Rol sin permisos (getUpcomingDeadlines):",a.role),{success:!0,data:[]};let c=await (0,e.R)(),d=new Date;d.setDate(d.getDate()+30);let g=c.from("case_stages").select(`
        *,
        case:cases(id, caratulado, abogado_responsable)
      `).eq("estado","pendiente").gte("fecha_programada",new Date().toISOString()).lte("fecha_programada",d.toISOString()).order("fecha_programada",{ascending:!0}),{data:j,error:k}=await g;if(k)throw k;let l=j??[];return"abogado"===b&&(l=l.filter(b=>b.case?.abogado_responsable===a.id)),{success:!0,data:l}}catch(a){return console.error("Error getting upcoming deadlines:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido"}}}(0,g.D)([k,l,m,n,o,p,q,r]),(0,d.A)(k,"00807ae5fbd0c1c1c2d4038b8498203777cb21de54",null),(0,d.A)(l,"0038d914007834db37101dd75339c895df362eee2f",null),(0,d.A)(m,"00869d7b9c68ab3ca0fa12ef34521449061e627fde",null),(0,d.A)(n,"005cdadd015853c55b045a48b1fba34c08042a6fe6",null),(0,d.A)(o,"004a51410e2b9c3b39c01e5fdf6ecc981274fd6bb5",null),(0,d.A)(p,"0041314c4e0e2232525a96f51ddedde5d71e595a44",null),(0,d.A)(q,"4049cef3e329e18c070e7cfd7f698040ed06160fd9",null),(0,d.A)(r,"0014e26fdf5f048ab6eeeb407aead3b5f7220442ce",null)}};