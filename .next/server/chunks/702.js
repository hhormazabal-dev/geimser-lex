"use strict";exports.id=702,exports.ids=[702],exports.modules={5074:(a,b,c)=>{var d=c(6730);c.o(d,"useRouter")&&c.d(b,{useRouter:function(){return d.useRouter}})},15352:(a,b,c)=>{c.d(b,{R:()=>i,r:()=>j});var d=c(79106),e=c(57626),f=c(55124);let g="https://xsvvdshbhaheqymquzjl.supabase.co",h=process.env.SUPABASE_SERVICE_ROLE_KEY;async function i(){let a=await (0,d.UL)();return(0,e.createServerClient)(g,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzdnZkc2hiaGFoZXF5bXF1empsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MDUxMTMsImV4cCI6MjA3NTA4MTExM30.exy4Scb4paVi8tGs_-FXuHpIW9OFsbCS5sC8J_XdLv8",{cookies:{get:b=>a.get(b)?.value,set(b,c,d){try{d?a.set(b,c,d):a.set(b,c)}catch{}},remove(b,c){try{c?a.set(b,"",{...c,expires:new Date(0)}):a.set(b,"",{expires:new Date(0)})}catch{}}}})}function j(){return(0,f.UU)(g,h,{auth:{persistSession:!1}})}},25667:(a,b,c)=>{c.d(b,{cN:()=>A,bx:()=>x,$E:()=>y,CH:()=>B,tT:()=>D,Eh:()=>C,Gm:()=>z});var d=c(19703);c(71977);var e=c(64604),f=c(15352),g=c(47550),h=c(97814),i=c(53433),j=c(98795);let k=i.Yj().optional().refine(function(a){if("string"!=typeof a||0===a.trim().length)return!0;let b=a.replace(/[^0-9kK]/g,"");if(b.length<8||b.length>9)return!1;let c=b.slice(0,-1),d=b.slice(-1).toUpperCase(),e=0,f=2;for(let a=c.length-1;a>=0;a--)e+=parseInt(c[a],10)*f,f=7===f?2:f+1;let g=11-e%11;return d===(11===g?"0":10===g?"K":String(g))},{message:"RUT inv\xe1lido"}),l=i.Ik({numero_causa:i.Yj().optional(),caratulado:i.Yj().min(1,"El caratulado es requerido").max(500,"El caratulado no puede exceder 500 caracteres"),materia:i.Yj().min(1,"La materia es requerida").max(100,"La materia no puede exceder 100 caracteres"),tribunal:i.Yj().optional(),region:i.Yj().optional(),comuna:i.Yj().optional(),rut_cliente:k,nombre_cliente:i.Yj().min(1,"El nombre del cliente es requerido").max(200,"El nombre no puede exceder 200 caracteres"),contraparte:i.Yj().optional(),etapa_actual:i.Yj().default("Ingreso Demanda"),estado:i.k5(["activo","suspendido","archivado","terminado"]).default("activo"),fecha_inicio:i.Yj().optional(),abogado_responsable:i.Yj().uuid("ID de abogado inv\xe1lido").optional(),analista_id:i.Yj().uuid("ID de analista inv\xe1lido").optional(),cliente_principal_id:i.Yj().uuid("ID de cliente inv\xe1lido").optional(),workflow_state:i.k5(["preparacion","en_revision","activo","cerrado"]).default("preparacion"),prioridad:i.k5(["baja","media","alta","urgente"]).default("media"),valor_estimado:i.ai().positive("El valor debe ser positivo").optional(),observaciones:i.Yj().optional(),descripcion_inicial:i.Yj().min(20,"Describe el contexto del caso con al menos 20 caracteres").max(2e3,"La descripci\xf3n inicial no puede exceder 2000 caracteres"),objetivo_cliente:i.Yj().max(1e3,"El objetivo del cliente no puede exceder 1000 caracteres").optional(),documentacion_recibida:i.Yj().max(2e3,"El listado de documentaci\xf3n no puede exceder 2000 caracteres").optional(),validado_at:i.Yj().optional().nullable(),marcar_validado:i.zM().optional()});function m(a,b){a.marcar_validado&&(a.abogado_responsable||b.addIssue({code:j.eq.custom,message:"Debes asignar un abogado responsable para validar el caso",path:["abogado_responsable"]}),a.cliente_principal_id||b.addIssue({code:j.eq.custom,message:"Debes vincular al menos un cliente principal para validar el caso",path:["cliente_principal_id"]}))}let n=l.superRefine((a,b)=>{m(a,b)}),o=l.partial().superRefine((a,b)=>{m(a,b)}),p=i.Ik({brief:i.Yj().min(10,"El brief debe tener al menos 10 caracteres").max(2e3,"El brief no puede exceder 2000 caracteres"),overrides:l.partial().optional()}),q=i.Ik({case_id:i.Yj().uuid("ID de caso inv\xe1lido"),abogado_id:i.Yj().uuid("ID de abogado inv\xe1lido")}),r=i.Ik({estado:i.k5(["activo","suspendido","archivado","terminado"]).optional(),prioridad:i.k5(["baja","media","alta","urgente"]).optional(),abogado_responsable:i.Yj().uuid().optional(),materia:i.Yj().optional(),fecha_inicio_desde:i.Yj().optional(),fecha_inicio_hasta:i.Yj().optional(),search:i.Yj().optional(),page:i.ai().min(1).default(1),limit:i.ai().min(1).max(100).default(10)});i.Ik({abogado_id:i.Yj().uuid().optional(),fecha_desde:i.Yj().optional(),fecha_hasta:i.Yj().optional()}),i.Ik({case_id:i.Yj().uuid("ID de caso inv\xe1lido"),etapa:i.Yj().min(1,"El nombre de la etapa es requerido").max(100,"El nombre no puede exceder 100 caracteres"),descripcion:i.Yj().optional(),fecha_programada:i.Yj().optional(),fecha_completada:i.Yj().optional(),estado:i.k5(["pendiente","en_proceso","completado"]).default("pendiente"),es_publica:i.zM().default(!0),orden:i.ai().int().positive("El orden debe ser un n\xfamero positivo"),responsable_id:i.Yj().uuid("ID de responsable inv\xe1lido").optional()}).partial().omit({case_id:!0}),i.Ik({fecha_completada:i.Yj().optional(),observaciones:i.Yj().optional()}),i.Ik({case_id:i.Yj().uuid().optional(),estado:i.k5(["pendiente","en_proceso","completado"]).optional(),responsable_id:i.Yj().uuid().optional(),es_publica:i.zM().optional(),fecha_desde:i.Yj().optional(),fecha_hasta:i.Yj().optional(),page:i.ai().min(1).default(1),limit:i.ai().min(1).max(100).default(20)});let s={Civil:[{etapa:"Ingreso Demanda",descripcion:"Presentaci\xf3n de la demanda con antecedentes y revisi\xf3n formal del tribunal.",diasEstimados:0},{etapa:"Notificaci\xf3n a la contraparte",descripcion:"Gestiones de notificaci\xf3n personal o por c\xe9dula al demandado.",diasEstimados:30},{etapa:"Contestaci\xf3n de la demanda",descripcion:"Plazo legal para que la contraparte conteste y proponga excepciones.",diasEstimados:20},{etapa:"R\xe9plicas y d\xfaplicas",descripcion:"Intercambio de escritos aclarando puntos controvertidos.",diasEstimados:15},{etapa:"Audiencia preparatoria",descripcion:"Fijaci\xf3n de puntos de prueba y acuerdos probatorios.",diasEstimados:30},{etapa:"Periodo probatorio",descripcion:"Recepci\xf3n de declaraciones, oficios, peritajes y documental.",diasEstimados:45},{etapa:"Alegatos y vista de la causa",descripcion:"Audiencia de cierre donde las partes exponen sus argumentos finales.",diasEstimados:20},{etapa:"Sentencia de primera instancia",descripcion:"Redacci\xf3n y publicaci\xf3n del fallo por el tribunal.",diasEstimados:60},{etapa:"Recursos y cumplimiento",descripcion:"Interposici\xf3n de recursos o cumplimiento voluntario/forzado.",diasEstimados:30}],Comercial:[{etapa:"Ingreso Demanda",descripcion:"Presentaci\xf3n de la demanda y verificaci\xf3n formal.",diasEstimados:0},{etapa:"Notificaci\xf3n demandado",descripcion:"Gesti\xf3n de notificaci\xf3n a la contraparte y acreditaci\xf3n en autos.",diasEstimados:20},{etapa:"Contestaci\xf3n y reconvenci\xf3n",descripcion:"Respuesta del demandado y eventuales reconvenciones.",diasEstimados:20},{etapa:"Audiencia preparatoria",descripcion:"Determinaci\xf3n de hechos a probar y medios de prueba.",diasEstimados:25},{etapa:"Prueba y alegatos",descripcion:"Producci\xf3n de prueba documental, testimonial y alegatos finales.",diasEstimados:40},{etapa:"Sentencia",descripcion:"Decisi\xf3n del tribunal y notificaci\xf3n a las partes.",diasEstimados:45},{etapa:"Ejecuci\xf3n o recursos",descripcion:"Cumplimiento del fallo o tramitaci\xf3n de recursos.",diasEstimados:30}],Laboral:[{etapa:"Ingreso tutela o demanda laboral",descripcion:"Ingreso del escrito y asignaci\xf3n de audiencia preliminar.",diasEstimados:0},{etapa:"Citaciones y notificaci\xf3n empleador",descripcion:"Notificaci\xf3n de la demanda y citaci\xf3n a audiencia preparatoria.",diasEstimados:10},{etapa:"Audiencia preparatoria",descripcion:"Intento de conciliaci\xf3n y fijaci\xf3n de puntos controvertidos.",diasEstimados:15},{etapa:"Audiencia de juicio",descripcion:"Producci\xf3n de prueba y alegatos finales.",diasEstimados:20},{etapa:"Sentencia laboral",descripcion:"Pronunciamiento del tribunal y notificaci\xf3n a las partes.",diasEstimados:15},{etapa:"Cumplimiento / Recurso de nulidad",descripcion:"Tramitaci\xf3n de recursos o ejecuci\xf3n de la sentencia.",diasEstimados:20}],Familia:[{etapa:"Ingreso demanda o escrito inicial",descripcion:"Ingreso de medida de protecci\xf3n o demanda ante tribunal de familia.",diasEstimados:0},{etapa:"Notificaci\xf3n y citaci\xf3n a audiencia",descripcion:"Notificaci\xf3n a la contraparte y citaci\xf3n a audiencia preparatoria.",diasEstimados:10},{etapa:"Audiencia preparatoria",descripcion:"Determinaci\xf3n de puntos controvertidos y acumulaci\xf3n de prueba.",diasEstimados:15},{etapa:"Audiencia de juicio",descripcion:"Presentaci\xf3n de prueba, declaraciones y alegatos.",diasEstimados:20},{etapa:"Sentencia",descripcion:"Redacci\xf3n y comunicaci\xf3n del fallo.",diasEstimados:20},{etapa:"Cumplimiento y seguimiento",descripcion:"Ejecuci\xf3n de medidas decretadas y seguimiento del cumplimiento.",diasEstimados:25}]};var t=c(42981);async function u(){return process.env.SUPABASE_SERVICE_KEY?(0,f.r)():(0,f.R)()}let v="preparacion";function w(a){return"string"==typeof a&&["activo","preparacion","en_revision","cerrado"].includes(a)?a:v}async function x(a){try{let b=await (0,g.oC)(["abogado","analista"]),{marcar_validado:c,...d}=n.parse(a),f=await u(),i=new Date().toISOString(),j={caratulado:d.caratulado,nombre_cliente:d.nombre_cliente,numero_causa:d.numero_causa??null,materia:d.materia??null,tribunal:d.tribunal??null,region:d.region??null,comuna:d.comuna??null,rut_cliente:d.rut_cliente??null,contraparte:d.contraparte??null,etapa_actual:d.etapa_actual??null,fecha_inicio:d.fecha_inicio??null,abogado_responsable:d.abogado_responsable??("abogado"===b.role?b.id:null),estado:d.estado??"activo",workflow_state:w(d.workflow_state??(c?"en_revision":"preparacion")),prioridad:d.prioridad??"media",valor_estimado:d.valor_estimado??null,observaciones:d.observaciones??null,cliente_principal_id:d.cliente_principal_id??null,descripcion_inicial:d.descripcion_inicial??null,documentacion_recibida:d.documentacion_recibida??null,objetivo_cliente:d.objetivo_cliente??null,created_at:i,updated_at:i,validado_at:c?d.validado_at??i:null},{data:k,error:l}=await f.from("cases").insert(j).select().single();if(l)throw l;return await E(k.id,j.cliente_principal_id),await F(k),await (0,h.UU)({action:"CREATE",entity_type:"case",entity_id:k.id,diff_json:{created:j}}),(0,e.revalidatePath)("/cases"),(0,e.revalidatePath)("/dashboard"),{success:!0,case:k}}catch(a){return console.error("Error in createCase:",a),{success:!1,error:a.message}}}async function y(a){try{let b=await (0,g.oC)("abogado"),c=p.parse(a),d=await G(c.brief),e=function(a){if(!a)return{};let b={};for(let[c,d]of Object.entries(a))void 0!==d&&(b[c]=d);return b}(c.overrides),f={caratulado:d.caratulado??"Caso generado desde brief",nombre_cliente:d.nombre_cliente??"Cliente por definir",materia:d.materia??"Civil",etapa_actual:d.etapa_actual??"Ingreso Demanda",estado:d.estado??"activo",workflow_state:w(d.workflow_state??v),prioridad:d.prioridad??"media",numero_causa:d.numero_causa??void 0,tribunal:d.tribunal??void 0,region:d.region??void 0,comuna:d.comuna??void 0,contraparte:d.contraparte??void 0,descripcion_inicial:d.descripcion_inicial??"Caso creado desde brief.",documentacion_recibida:d.documentacion_recibida??void 0,objetivo_cliente:d.objetivo_cliente??void 0,observaciones:d.observaciones??`Caso creado desde brief:

${c.brief}`,valor_estimado:d.valor_estimado??void 0,rut_cliente:d.rut_cliente??void 0,cliente_principal_id:d.cliente_principal_id??void 0,fecha_inicio:d.fecha_inicio??void 0,abogado_responsable:b.id},h={...f,...e,workflow_state:w(e?.workflow_state??f.workflow_state),caratulado:e?.caratulado??f.caratulado,nombre_cliente:e?.nombre_cliente??f.nombre_cliente,materia:e?.materia??f.materia,etapa_actual:e?.etapa_actual??f.etapa_actual,estado:e?.estado??f.estado,prioridad:e?.prioridad??f.prioridad,descripcion_inicial:e?.descripcion_inicial??f.descripcion_inicial??""};return await x(h)}catch(a){return console.error("Error in createCaseFromBrief:",a),{success:!1,error:a.message}}}async function z(a,b){try{let c=await (0,g.oC)(),{marcar_validado:d,...f}=o.parse(b),i=await u(),{data:j,error:k}=await i.from("cases").select("*").eq("id",a).single();if(k||!j)throw Error("Caso no encontrado");let l="admin_firma"===c.role,m="abogado"===c.role&&j.abogado_responsable===c.id,n="analista"===c.role&&j.analista_id===c.id;if(!l&&!m&&!n)throw Error("Sin permisos para editar este caso");if(n&&"cerrado"===j.workflow_state)throw Error("El caso ya fue cerrado");let p=new Date().toISOString(),q={updated_at:p,...void 0!==f.caratulado&&{caratulado:f.caratulado},...void 0!==f.nombre_cliente&&{nombre_cliente:f.nombre_cliente},...void 0!==f.materia&&{materia:f.materia},...void 0!==f.etapa_actual&&{etapa_actual:f.etapa_actual},...void 0!==f.fecha_inicio&&{fecha_inicio:f.fecha_inicio},...void 0!==f.numero_causa&&{numero_causa:f.numero_causa},...void 0!==f.tribunal&&{tribunal:f.tribunal},...void 0!==f.region&&{region:f.region},...void 0!==f.comuna&&{comuna:f.comuna},...void 0!==f.contraparte&&{contraparte:f.contraparte},...void 0!==f.descripcion_inicial&&{descripcion_inicial:f.descripcion_inicial},...void 0!==f.documentacion_recibida&&{documentacion_recibida:f.documentacion_recibida},...void 0!==f.objetivo_cliente&&{objetivo_cliente:f.objetivo_cliente},...void 0!==f.observaciones&&{observaciones:f.observaciones},...void 0!==f.valor_estimado&&{valor_estimado:f.valor_estimado??null},...void 0!==f.rut_cliente&&{rut_cliente:f.rut_cliente},...void 0!==f.cliente_principal_id&&{cliente_principal_id:f.cliente_principal_id??null},...void 0!==f.abogado_responsable&&{abogado_responsable:f.abogado_responsable??null},...void 0!==f.analista_id&&{analista_id:f.analista_id??null}};void 0!==f.estado&&(q.estado=f.estado),void 0!==f.prioridad&&(q.prioridad=f.prioridad),void 0!==f.workflow_state&&(q.workflow_state=w(f.workflow_state)),void 0!==d&&(q.validado_at=d?f.validado_at??j.validado_at??p:null,void 0===f.workflow_state&&(q.workflow_state=d?"cerrado"===j.workflow_state?"cerrado":"en_revision":"preparacion")),n&&!j.analista_id&&(q.analista_id=c.id);let{data:r,error:s}=await i.from("cases").update(q).eq("id",a).select().single();if(s)throw s;return await E(a,f.cliente_principal_id??void 0),await (0,h.UU)({action:"UPDATE",entity_type:"case",entity_id:a,diff_json:{from:j,to:r}}),(0,e.revalidatePath)(`/cases/${a}`),(0,e.revalidatePath)("/cases"),(0,e.revalidatePath)("/dashboard"),{success:!0,case:r}}catch(a){return console.error("Error in updateCase:",a),{success:!1,error:a.message}}}async function A(a){try{await (0,g.oC)("admin_firma");let b=q.parse(a),c=await u(),{data:d,error:f}=await c.from("cases").update({abogado_responsable:b.abogado_id}).eq("id",b.case_id).select().single();if(f)throw f;return await (0,h.UU)({action:"ASSIGN_LAWYER",entity_type:"case",entity_id:b.case_id,diff_json:{abogado_responsable:b.abogado_id}}),(0,e.revalidatePath)(`/cases/${b.case_id}`),(0,e.revalidatePath)("/cases"),(0,e.revalidatePath)("/dashboard"),{success:!0,case:d}}catch(a){return console.error("Error in assignLawyer:",a),{success:!1,error:a.message}}}async function B(a){try{await (0,g.oC)("admin_firma");let b=await u(),{error:c}=await b.from("cases").delete().eq("id",a);if(c)throw c;return await (0,h.UU)({action:"DELETE",entity_type:"case",entity_id:a,diff_json:{deleted:!0}}),(0,e.revalidatePath)("/cases"),(0,e.revalidatePath)("/dashboard"),{success:!0}}catch(a){return console.error("Error in deleteCase:",a),{success:!1,error:a.message}}}async function C(a={}){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c={...a??{}};null==c.page&&(c.page=1),null==c.limit&&(c.limit=10);let d=r.parse(c),e=await u(),f=e.from("cases").select(`
        *,
        abogado_responsable:profiles!cases_abogado_responsable_fkey(id, nombre),
        case_stages(id, etapa, estado, fecha_programada, orden)
      `,{count:"exact"});if("abogado"===b.role)f=f.eq("abogado_responsable",b.id);else if("analista"===b.role)f=f.eq("analista_id",b.id);else if("cliente"===b.role){let{data:a}=await e.from("case_clients").select("case_id").eq("client_profile_id",b.id),c=a?.map(a=>a.case_id)??[];if(0===c.length)return{success:!0,cases:[],total:0,page:d.page,limit:d.limit};f=f.in("id",c)}if(d.estado&&(f=f.eq("estado",d.estado)),d.prioridad&&(f=f.eq("prioridad",d.prioridad)),d.abogado_responsable&&(f=f.eq("abogado_responsable",d.abogado_responsable)),d.materia&&(f=f.eq("materia",d.materia)),d.fecha_inicio_desde&&(f=f.gte("fecha_inicio",d.fecha_inicio_desde)),d.fecha_inicio_hasta&&(f=f.lte("fecha_inicio",d.fecha_inicio_hasta)),d.search){let a=d.search;f=f.or(`caratulado.ilike.%${a}%,nombre_cliente.ilike.%${a}%,numero_causa.ilike.%${a}%`)}let h=(d.page-1)*d.limit,i=h+d.limit-1,{data:j,error:k,count:l}=await f.range(h,i).order("created_at",{ascending:!1});if(k)throw k;return{success:!0,cases:j??[],total:l??0,page:d.page,limit:d.limit}}catch(a){return console.error("Error in getCases:",a),{success:!1,error:a.message,cases:[],total:0}}}async function D(a){try{let b=await (0,g.Rk)();if(!b)throw Error("No autenticado");let c=await u(),{data:d,error:e}=await c.from("cases").select("*").eq("id",a).single();if(e||!d)throw Error("Caso no encontrado");if("cliente"===b.role){let{data:d}=await c.from("case_clients").select("id").eq("case_id",a).eq("client_profile_id",b.id).maybeSingle();if(!d)throw Error("Sin permisos para ver este caso")}if("abogado"===b.role&&d.abogado_responsable&&d.abogado_responsable!==b.id||"analista"===b.role&&d.analista_id&&d.analista_id!==b.id)throw Error("Sin permisos para ver este caso");let[f,h,i,j,k]=await Promise.all([(async()=>{if(!d.abogado_responsable)return null;let{data:b,error:e}=await c.from("profiles").select("id, nombre, telefono, rut").eq("id",d.abogado_responsable).maybeSingle();return e?(console.error("Error fetching lawyer profile",a,e.message),null):b})(),c.from("case_stages").select("*, responsable:profiles(id, nombre)").eq("case_id",a).order("orden",{ascending:!0}),c.from("notes").select("*, author:profiles(id, nombre)").eq("case_id",a).order("created_at",{ascending:!1}),c.from("documents").select("*, uploader:profiles(id, nombre)").eq("case_id",a).order("created_at",{ascending:!1}),c.from("info_requests").select("*, creador:profiles(id, nombre)").eq("case_id",a).order("created_at",{ascending:!1})]),l={...d,abogado_responsable_id:d.abogado_responsable,abogado_responsable:f?{id:f.id,nombre:f.nombre,telefono:f.telefono,rut:f.rut}:null,case_stages:h?.data??[],notes:i?.data??[],documents:j?.data??[],info_requests:k?.data??[]};return{success:!0,case:l}}catch(a){return console.error("Error in getCaseById:",a),{success:!1,error:a.message}}}async function E(a,b){if(b)try{let c=await u();await c.from("case_clients").upsert([{case_id:a,client_profile_id:b}],{onConflict:"case_id,client_profile_id"})}catch(a){console.error("Error vinculando cliente principal al caso:",a)}}async function F(a){let b=await u(),c=function(a){if(!a)return s.Civil;let b=a.toLowerCase(),c=Object.keys(s).find(a=>a.toLowerCase()===b);return c?s[c]:s.Civil}(a.materia||"Civil"),d=a.fecha_inicio?new Date(a.fecha_inicio):new Date,e=0,f=c.map((b,c)=>{e+=b.diasEstimados;let f=new Date(d.getTime());f.setDate(f.getDate()+e);let g=f.toISOString().split("T")[0];return{case_id:a.id,etapa:b.etapa,descripcion:b.descripcion??null,estado:"pendiente",orden:c+1,es_publica:b.esPublica??!0,fecha_programada:g??null,fecha_cumplida:null,responsable_id:null}});0!==f.length&&await b.from("case_stages").insert(f)}async function G(a){let b={};for(let c of a.toLowerCase().split("\n")){if(c.includes("caratulado")||c.includes("caso")||c.includes("demanda")){let a=c.match(/(?:caratulado|caso|demanda)[:\s]+(.+)/),d=a?.[1]?.trim();d&&(b.caratulado=d)}if(c.includes("cliente")||c.includes("demandante")){let a=c.match(/(?:cliente|demandante)[:\s]+(.+)/),d=a?.[1]?.trim();d&&(b.nombre_cliente=d)}c.includes("laboral")&&(b.materia="Laboral"),c.includes("civil")&&(b.materia="Civil"),c.includes("comercial")&&(b.materia="Comercial"),c.includes("penal")&&(b.materia="Penal"),c.includes("familia")&&(b.materia="Familia"),c.includes("urgente")&&(b.prioridad="urgente"),c.includes("alta prioridad")&&(b.prioridad="alta"),c.includes("baja prioridad")&&(b.prioridad="baja")}return b.observaciones=b.observaciones??`Caso creado desde brief:

${a}`,b}(0,t.D)([x,y,z,A,B,C,D]),(0,d.A)(x,"4005ee7254afb4611af8875139dc5a2557d207248f",null),(0,d.A)(y,"404b793976c20ab1ffc9192a82ee384237a7650d01",null),(0,d.A)(z,"600ae10f5197efbf0d781e426ef0c63665a14b6095",null),(0,d.A)(A,"40d60bf749a6aea141d6303248fc1697421893fdfd",null),(0,d.A)(B,"40f83224155e3423d55a4c895d3546a01ab48df807",null),(0,d.A)(C,"404bc83d9a543e611258759390787c7cb6576f1ced",null),(0,d.A)(D,"401aaaf800a1f16c132dde5f9588ffbaf9da69a52b",null)},47550:(a,b,c)=>{c.d(b,{Nf:()=>i,Rk:()=>g,oC:()=>h});var d=c(15352);let e={admin:"admin_firma",admin_firma:"admin_firma",adminfirma:"admin_firma","admin-firma":"admin_firma",adminlex:"admin_firma",firma_admin:"admin_firma",abogado:"abogado",analista:"analista",cliente:"cliente"};async function f(){let a=await (0,d.R)(),{data:b,error:c}=await a.auth.getUser();if(c||!b?.user)return console.warn("[AUTH] No hay usuario autenticado:",c),null;let f=b.user,g=f.id,h=function(a){let b=[],c=a.app_metadata??{},d=a.user_metadata??{};for(let a of(b.push(c.role,c.roles?.[0],c.user_role),b.push(d.role,d.roles?.[0],d.user_role),b.push(d.perfil_rol,d.profile_role,d.tipo,d.rol),(!0===c.claims_admin||!0===d.is_admin)&&b.push("admin_firma"),b)){let b=function a(b){if(null==b)return null;if(Array.isArray(b))return b.length?a(b[0]):null;if("boolean"==typeof b)return b?"admin_firma":null;let c=String(b).trim();return c?e[c.toLowerCase().replace(/[\s-]+/g,"_")]??null:null}(a);if(b)return b}return null}(f),{data:i,error:j}=await a.from("profiles").select("*").eq("id",g).maybeSingle();if(j)return console.error("[AUTH] Error seleccionando profiles por id:",j),null;if(i){let b=f.email??i.email??"";if(b&&b!==i.email){let{error:c}=await a.from("profiles").update({email:b}).eq("id",g);c&&console.warn("[AUTH] No se pudo sincronizar email en profiles:",c)}let c=f.user_metadata?.nombre??f.user_metadata?.name??null;if(c&&c!==i.nombre){let{error:b}=await a.from("profiles").update({nombre:String(c)}).eq("id",g);if(b)console.warn("[AUTH] No se pudo sincronizar nombre en profiles:",b);else{let{data:b}=await a.from("profiles").select("*").eq("id",g).maybeSingle();if(b){let a=h&&h!==b.role?h:null;return{...b,_role_override:a}}let c=h&&h!==i.role?h:null;return{...i,_role_override:c}}}if(h&&h!==i.role){let{data:b,error:c}=await a.from("profiles").update({role:h}).eq("id",g).select("*").maybeSingle();return c?(console.warn("[AUTH] No se pudo sincronizar rol en profiles:",c),{...i,_role_override:h??null}):b?{...b,_role_override:null}:(console.warn("[AUTH] Actualizaci\xf3n de rol no devolvi\xf3 datos, usando override local"),{...i,_role_override:h??null})}let d=h&&h!==i.role?h:null;return{...i,_role_override:d}}let k=f.user_metadata?.nombre??f.user_metadata?.name??(f.email??"").split("@")[0]??"Usuario",l={id:g,user_id:g,email:f.email??"",nombre:String(k),role:h??"cliente",activo:!0},{data:m,error:n}=await a.from("profiles").insert(l).select("*").maybeSingle();if(n)return console.error("[AUTH] Error creando perfil por primera vez:",n),null;if(console.info("[AUTH] Perfil creado autom\xe1ticamente:",{id:m?.id,email:m?.email,role:m?.role,metadataRole:h}),!m)return null;let o=h&&h!==m.role?h:null;return{...m,_role_override:o}}async function g(){let a=await f();if(!a)return null;let b=a._role_override,c=b??a.role??"cliente"??"cliente";return console.warn("[ROLE DEBUG] getCurrentProfile()",{auth_id:a.id,table_user_id:a.user_id,email:a.email,role_db:a.role,role_override:b,role_effective:c}),{...a,role:c}}async function h(a){let b=await g();if(!b)throw Error("No autenticado");let c=b.role;if(!a)return{...b,role:c};if(!(Array.isArray(a)?a:[a]).includes(c))throw Error("Sin permisos");return{...b,role:c}}async function i(a){return!0}},97814:(a,b,c)=>{c.d(b,{JY:()=>j,UU:()=>h,WZ:()=>i});var d=c(19703);c(71977);var e=c(79106),f=c(15352),g=c(47550);async function h(a){try{let b=await (0,g.Rk)();if(!b)return void console.warn("Attempted to log audit action without authenticated user");let c=await (0,f.R)(),d=await (0,e.b3)(),h={action:a.action,actor_id:b.id,entity_type:a.entity_type,entity_id:a.entity_id??null,diff_json:a.diff_json,ip_address:d.get("x-forwarded-for")??d.get("x-real-ip")??"unknown",user_agent:d.get("user-agent")??"unknown"},{error:i}=await c.from("audit_log").insert(h);i&&console.error("Error logging audit action:",i)}catch(a){console.error("Error in logAuditAction:",a)}}async function i(a,b){try{let c=await (0,g.Rk)();if(!c||"admin_firma"!==c.role)throw Error("Sin permisos para ver auditor\xeda");let d=await (0,f.R)(),{data:e,error:h}=await d.from("audit_log").select(`
        *,
        actor:profiles(nombre)
      `).eq("entity_type",a).eq("entity_id",b).order("created_at",{ascending:!1});if(h)throw console.error("Error fetching audit history:",h),Error("Error al obtener historial de auditor\xeda");return{success:!0,logs:e||[]}}catch(a){return console.error("Error in getAuditHistory:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido",logs:[]}}}async function j(a=30){try{let b=await (0,g.Rk)();if(!b||"admin_firma"!==b.role)throw Error("Sin permisos para ver estad\xedsticas de auditor\xeda");let c=await (0,f.R)(),d=new Date;d.setDate(d.getDate()-a);let{data:e,error:h}=await c.from("audit_log").select("action, entity_type, created_at").gte("created_at",d.toISOString());if(h)throw console.error("Error fetching audit stats:",h),Error("Error al obtener estad\xedsticas de auditor\xeda");let i={},j={},k={};return(e??[]).forEach(a=>{if(a.action&&(i[a.action]=(i[a.action]||0)+1),a.entity_type&&(j[a.entity_type]=(j[a.entity_type]||0)+1),a.created_at){let b=new Date(a.created_at),c=isNaN(b.getTime())?null:b.toISOString().split("T")[0];c&&(k[c]=(k[c]||0)+1)}}),{success:!0,stats:{totalActions:e?.length||0,actionCounts:i,entityCounts:j,dailyActivity:k}}}catch(a){return console.error("Error in getAuditStats:",a),{success:!1,error:a instanceof Error?a.message:"Error desconocido",stats:null}}}(0,c(42981).D)([h,i,j]),(0,d.A)(h,"40bbe3e656245168542fd3a8033360a3153f7866c7",null),(0,d.A)(i,"607d1dca140ba92578dd984fe3dafe6a69aef5ba12",null),(0,d.A)(j,"40955eb8801a00741395ef4acde4fdb9f61977fcfa",null)}};